<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>V9 POWER EDITION – Análise Jurídica</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Rajdhani:wght@300;400;600;700&display=swap" rel="stylesheet">
<!-- docx generation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.5.0/docx.umd.min.js"></script>
<!-- PDF generation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root{--gold:#c9a84c;--gold-light:#e8c96b;--gold-dark:#8b6914;--bg:#0a0a0a;--card:#111111;--card2:#161616;--border:#2a2a2a;--text:#e0d5c0;--muted:#6b6050;--green:#2ecc71;--red:#e74c3c;--yellow:#f39c12}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:'Rajdhani',sans-serif;font-size:15px;line-height:1.6;min-height:100vh}
body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");pointer-events:none;z-index:0;opacity:.3}
header{text-align:center;padding:36px 20px 20px;position:relative}
header h1{font-family:'Cinzel',serif;font-size:clamp(1.4rem,4vw,2.2rem);letter-spacing:.35em;background:linear-gradient(135deg,var(--gold-dark),var(--gold-light),var(--gold-dark));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
header .subtitle{font-size:.75rem;letter-spacing:.3em;color:var(--muted);margin-top:4px;text-transform:uppercase}
.divider{width:200px;height:1px;background:linear-gradient(90deg,transparent,var(--gold),transparent);margin:12px auto 0}
.container{max-width:920px;margin:0 auto;padding:0 20px 60px;position:relative;z-index:1}
.card{background:var(--card);border:1px solid var(--border);border-radius:6px;padding:28px;margin-bottom:20px;position:relative;overflow:hidden}
.card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--gold),transparent)}
.section-label{font-size:.65rem;letter-spacing:.3em;color:var(--gold);text-transform:uppercase;margin-bottom:16px;display:flex;align-items:center;gap:10px}
.section-label::after{content:'';flex:1;height:1px;background:var(--border)}
label{display:block;font-size:.7rem;letter-spacing:.2em;color:var(--muted);text-transform:uppercase;margin-bottom:6px;margin-top:16px}
label:first-of-type{margin-top:0}
input[type=text],select,textarea{width:100%;background:var(--card2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'Rajdhani',sans-serif;font-size:14px;padding:12px 14px;outline:none;transition:border-color .2s;letter-spacing:.03em}
input[type=text]:focus,select:focus,textarea:focus{border-color:var(--gold-dark);box-shadow:0 0 0 2px rgba(201,168,76,.08)}
select option{background:#1a1a1a}
textarea{resize:vertical;min-height:160px}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
@media(max-width:600px){.grid2{grid-template-columns:1fr}}
.tone-group{display:flex;gap:8px;flex-wrap:wrap}
.tone-btn{background:var(--card2);border:1px solid var(--border);border-radius:4px;color:var(--muted);font-family:'Rajdhani',sans-serif;font-size:.7rem;letter-spacing:.2em;padding:8px 18px;cursor:pointer;text-transform:uppercase;transition:all .2s}
.tone-btn.active{background:linear-gradient(135deg,var(--gold-dark),var(--gold));border-color:var(--gold);color:#000;font-weight:700}
.btn-execute{width:100%;padding:18px;background:linear-gradient(135deg,var(--gold-dark),var(--gold-light),var(--gold-dark));border:none;border-radius:4px;font-family:'Cinzel',serif;font-size:.85rem;letter-spacing:.25em;color:#000;font-weight:700;cursor:pointer;transition:all .3s;text-transform:uppercase;margin-top:8px}
.btn-execute:hover{transform:translateY(-1px);box-shadow:0 8px 30px rgba(201,168,76,.3)}
.btn-execute:active{transform:translateY(0)}
.btn-execute:disabled{opacity:.5;cursor:not-allowed;transform:none}
.result-card{display:none;animation:fadeUp .4s ease}
.result-card.visible{display:block}
@keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
.prob-container{margin:20px 0}
.prob-header{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:8px}
.prob-label{font-size:.7rem;letter-spacing:.2em;color:var(--muted);text-transform:uppercase}
.prob-value{font-family:'Cinzel',serif;font-size:2.8rem;font-weight:900;line-height:1}
.prob-value.high{color:var(--green)}.prob-value.medium{color:var(--yellow)}.prob-value.low{color:var(--red)}
.prob-bar-track{height:8px;background:var(--card2);border-radius:4px;overflow:hidden;border:1px solid var(--border)}
.prob-bar-fill{height:100%;border-radius:4px;transition:width 1s cubic-bezier(.16,1,.3,1);width:0%}
.prob-bar-fill.high{background:linear-gradient(90deg,#27ae60,var(--green))}.prob-bar-fill.medium{background:linear-gradient(90deg,#e67e22,var(--yellow))}.prob-bar-fill.low{background:linear-gradient(90deg,#c0392b,var(--red))}
.factors-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:16px}
@media(max-width:600px){.factors-grid{grid-template-columns:1fr}}
.factor-item{background:var(--card2);border:1px solid var(--border);border-radius:4px;padding:14px;display:flex;gap:12px;align-items:flex-start}
.factor-icon{font-size:1.2rem;flex-shrink:0;margin-top:2px}
.factor-title{font-size:.7rem;letter-spacing:.15em;color:var(--gold);text-transform:uppercase;margin-bottom:4px}
.factor-text{font-size:13px;color:#a09880;line-height:1.5}
.juris-item{background:var(--card2);border:1px solid var(--border);border-left:3px solid var(--gold-dark);border-radius:4px;padding:14px 18px;margin-bottom:10px;font-size:13px}
.juris-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;flex-wrap:wrap;gap:6px}
.juris-ref{font-size:.7rem;letter-spacing:.15em;color:var(--gold);text-transform:uppercase}
.juris-badge{font-size:.6rem;letter-spacing:.15em;padding:3px 10px;border-radius:20px;text-transform:uppercase;font-weight:700}
.juris-badge.favor{background:rgba(46,204,113,.15);color:var(--green);border:1px solid rgba(46,204,113,.3)}
.juris-badge.contra{background:rgba(231,76,60,.15);color:var(--red);border:1px solid rgba(231,76,60,.3)}
.juris-badge.neutro{background:rgba(243,156,18,.15);color:var(--yellow);border:1px solid rgba(243,156,18,.3)}
.juris-text{color:#a09880;line-height:1.6}

/* DOWNLOAD SECTION */
.download-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
@media(max-width:500px){.download-grid{grid-template-columns:1fr}}
.btn-download{width:100%;padding:16px;border:none;border-radius:4px;font-family:'Cinzel',serif;font-size:.75rem;letter-spacing:.2em;font-weight:700;cursor:pointer;transition:all .3s;text-transform:uppercase;display:flex;align-items:center;justify-content:center;gap:10px}
.btn-download.word{background:linear-gradient(135deg,#1a3a6b,#2563a8);color:#fff}
.btn-download.pdf{background:linear-gradient(135deg,#6b1a1a,#c0392b);color:#fff}
.btn-download:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,.4)}
.btn-download:active{transform:translateY(0)}
.btn-download:disabled{opacity:.4;cursor:not-allowed;transform:none}
.btn-download svg{width:20px;height:20px;flex-shrink:0}

.score-row{display:flex;align-items:center;gap:12px;margin-bottom:10px}
.score-name{font-size:.68rem;letter-spacing:.12em;color:var(--muted);text-transform:uppercase;width:160px;flex-shrink:0}
.score-mini-bar{flex:1;height:5px;background:var(--card2);border-radius:3px;overflow:hidden}
.score-mini-fill{height:100%;background:linear-gradient(90deg,var(--gold-dark),var(--gold));border-radius:3px;transition:width 1s ease;width:0%}
.score-pct{font-size:.75rem;color:var(--gold);width:36px;text-align:right;flex-shrink:0}
.loading{display:none;text-align:center;padding:50px}
.loading.visible{display:block}
.spinner{width:44px;height:44px;border:2px solid var(--border);border-top-color:var(--gold);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 16px}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{font-size:.7rem;letter-spacing:.25em;color:var(--muted);text-transform:uppercase}
.loading-step{font-size:.65rem;letter-spacing:.15em;color:var(--gold-dark);margin-top:8px}
.chars-count{font-size:.65rem;letter-spacing:.1em;color:var(--muted);text-align:right;margin-top:4px}
.ai-result-text{font-size:14px;line-height:1.8;color:#a09880;white-space:pre-wrap}
.estrategia-box{font-size:14px;line-height:1.8;color:#a09880}
.estrategia-box strong{color:var(--gold)}
.btn-nova{width:100%;padding:14px;background:transparent;border:1px solid var(--border);border-radius:4px;font-family:'Rajdhani',sans-serif;font-size:.75rem;letter-spacing:.25em;color:var(--muted);cursor:pointer;text-transform:uppercase;transition:all .2s;margin-top:0}
.btn-nova:hover{border-color:var(--gold-dark);color:var(--gold)}
.status-bar{font-size:.65rem;letter-spacing:.15em;color:var(--muted);text-align:center;padding:6px 0 2px;text-transform:uppercase}
</style>
</head>
<body>
<header>
  <h1>V9 POWER EDITION</h1>
  <p class="subtitle">Engenharia Jurídica · Análise por IA · Download Word & PDF</p>
  <div class="divider"></div>
</header>

<div class="container">

<!-- INPUT -->
<div class="card" id="inputCard">
  <div class="section-label">⚖ Dados do Processo</div>
  <div class="grid2">
    <div>
      <label>Área do Direito</label>
      <select id="areaDir">
        <option value="">Selecione...</option>
        <option>Direito Trabalhista</option>
        <option>Direito Civil</option>
        <option>Direito do Consumidor</option>
        <option>Direito Previdenciário</option>
        <option>Direito de Família</option>
        <option>Direito Tributário</option>
        <option>Direito Empresarial</option>
        <option>Direito Penal</option>
        <option>Direito Administrativo</option>
        <option>Direito Ambiental</option>
      </select>
    </div>
    <div>
      <label>Tipo de Ação / Peça</label>
      <input type="text" id="tipoAcao" placeholder="Ex: Reclamação Trabalhista, Indenização..."/>
    </div>
  </div>
  <div class="grid2">
    <div>
      <label>Polo Ativo (Autor/Reclamante)</label>
      <input type="text" id="autor" placeholder="Ex: Empregado, Consumidor..."/>
    </div>
    <div>
      <label>Polo Passivo (Réu/Reclamado)</label>
      <input type="text" id="reu" placeholder="Ex: Empresa XYZ, Banco..."/>
    </div>
  </div>
  <label>Pedidos Principais</label>
  <input type="text" id="pedidos" placeholder="Ex: Horas extras, danos morais, rescisão indireta, FGTS..."/>
  <label>Tribunal / Instância</label>
  <select id="tribunal">
    <option value="">Selecione...</option>
    <option>1ª Instância – Vara do Trabalho</option>
    <option>1ª Instância – Vara Cível</option>
    <option>TRT (Tribunal Regional do Trabalho)</option>
    <option>TJ (Tribunal de Justiça Estadual)</option>
    <option>TST (Tribunal Superior do Trabalho)</option>
    <option>STJ (Superior Tribunal de Justiça)</option>
    <option>STF (Supremo Tribunal Federal)</option>
    <option>TRF (Tribunal Regional Federal)</option>
  </select>
  <label>Valor Estimado da Causa (R$)</label>
  <input type="text" id="valorCausa" placeholder="Ex: 50.000,00"/>
  <label style="margin-top:20px">Tom da Análise</label>
  <div class="tone-group" id="toneGroup">
    <button class="tone-btn active" data-tone="imparcial">Imparcial</button>
    <button class="tone-btn" data-tone="favoravel">Favorável ao Autor</button>
    <button class="tone-btn" data-tone="defensivo">Defensivo ao Réu</button>
    <button class="tone-btn" data-tone="estrategico">Estratégico</button>
  </div>
  <label style="margin-top:20px">Fatos, Provas e Argumentos do Caso</label>
  <textarea id="fatos" placeholder="Descreva detalhadamente os fatos do caso, provas disponíveis, documentos existentes, peculiaridades e qualquer informação relevante para a análise jurídica..."></textarea>
  <div class="chars-count"><span id="charsCount">0</span> caracteres · mínimo recomendado: 200</div>
  <button class="btn-execute" id="btnExecutar" onclick="executarAnalise()">
    ⚖ EXECUTAR ANÁLISE JURÍDICA V9 POWER
  </button>
</div>

<!-- LOADING -->
<div class="loading" id="loading">
  <div class="spinner"></div>
  <p class="loading-text">Executando Engenharia V9 Power</p>
  <p class="loading-step" id="loadingStep">Analisando jurisprudência...</p>
</div>

<!-- RESULTADO -->
<div class="result-card" id="resultCard">

  <!-- PROBABILIDADE -->
  <div class="card">
    <div class="section-label">◈ Probabilidade de Êxito</div>
    <div class="prob-container">
      <div class="prob-header">
        <div>
          <div class="prob-label">Estimativa Global de Procedência</div>
          <div class="prob-value" id="probValue" style="margin-top:6px">—</div>
        </div>
        <div style="text-align:right">
          <div class="prob-label">Classificação</div>
          <div id="probClass" style="margin-top:6px;font-size:.8rem;letter-spacing:.2em;text-transform:uppercase"></div>
        </div>
      </div>
      <div class="prob-bar-track"><div class="prob-bar-fill" id="probBar"></div></div>
    </div>
    <div id="scoreBreakdown"></div>
  </div>

  <!-- ANÁLISE COMPLETA DA IA -->
  <div class="card">
    <div class="section-label">◈ Análise Jurídica Completa</div>
    <div class="ai-result-text" id="aiFullText"></div>
  </div>

  <!-- DOWNLOAD -->
  <div class="card">
    <div class="section-label">◈ Download do Documento Completo</div>
    <p style="font-size:13px;color:var(--muted);margin-bottom:4px">Documento profissional com capa, análise, jurisprudências, petição e estratégia.</p>
    <div class="download-grid">
      <button class="btn-download word" id="btnWord" onclick="downloadWord()">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-1 1.5L18.5 9H13V3.5zM8.5 17l-1.5-5.5-1.5 5.5H4l-2-8h1.5l1.5 6 1.5-6H8l1.5 6 1.5-6H12.5l-2 8H8.5zm7-1.5h-1V14h1v1.5zm0-3h-1v-1h1v1z"/></svg>
        Baixar Word (.docx)
      </button>
      <button class="btn-download pdf" id="btnPdf" onclick="downloadPDF()">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-1 1.5L18.5 9H13V3.5zM11.5 18h-1v-3h1v3zm0-4.5h-1V12h1v1.5zm2.5 4.5h-1v-6h1v6zm2.5 0h-1v-4h1v4z"/></svg>
        Baixar PDF
      </button>
    </div>
    <div class="status-bar" id="downloadStatus"></div>
  </div>

  <button class="btn-nova" onclick="resetForm()">← NOVA ANÁLISE</button>
</div>

</div><!-- /container -->

<script>
// ─── STATE ───────────────────────────────────────────────────────────────────
let analysisData = null;

// ─── TONE SELECTOR ────────────────────────────────────────────────────────────
document.querySelectorAll('.tone-btn').forEach(b=>{
  b.addEventListener('click',()=>{
    document.querySelectorAll('.tone-btn').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
  });
});
document.getElementById('fatos').addEventListener('input',function(){
  document.getElementById('charsCount').textContent=this.value.length;
});

// ─── FORM DATA ────────────────────────────────────────────────────────────────
function getFormData(){
  return {
    area:      document.getElementById('areaDir').value,
    tipo:      document.getElementById('tipoAcao').value,
    autor:     document.getElementById('autor').value,
    reu:       document.getElementById('reu').value,
    pedidos:   document.getElementById('pedidos').value,
    tribunal:  document.getElementById('tribunal').value,
    valor:     document.getElementById('valorCausa').value,
    tom:       document.querySelector('.tone-btn.active').dataset.tone,
    fatos:     document.getElementById('fatos').value,
    data:      new Date().toLocaleDateString('pt-BR')
  };
}

// ─── BUILD PROMPT ─────────────────────────────────────────────────────────────
function buildPrompt(d){
  const tomMap={
    imparcial:'Forneça análise completamente imparcial, ponderando pontos positivos e negativos para ambas as partes com igual rigor.',
    favoravel:'Analise com foco nos melhores argumentos e teses favoráveis ao polo ativo, identificando os fundamentos mais sólidos disponíveis.',
    defensivo:'Analise com foco na defesa do polo passivo, identificando fragilidades nos pedidos e os melhores argumentos de resistência.',
    estrategico:'Forneça análise estratégica completa, incluindo oportunidades de acordo, riscos de cada cenário e recomendações táticas processuais.'
  };
  return `Você é um especialista jurídico brasileiro sênior com 20 anos de experiência e amplo conhecimento em jurisprudência nacional. Realize uma ANÁLISE JURÍDICA COMPLETA, TÉCNICA e PROBABILÍSTICA do processo abaixo.

═══════════════════════════════════════════
DADOS DO PROCESSO
═══════════════════════════════════════════
Área do Direito: ${d.area||'Não informado'}
Tipo de Ação/Peça: ${d.tipo||'Não informado'}
Polo Ativo (Autor/Reclamante): ${d.autor||'Não informado'}
Polo Passivo (Réu/Reclamado): ${d.reu||'Não informado'}
Pedidos Principais: ${d.pedidos||'Não informado'}
Tribunal / Instância: ${d.tribunal||'Não informado'}
Valor Estimado da Causa: R$ ${d.valor||'Não informado'}
Data da Análise: ${d.data}

═══════════════════════════════════════════
FATOS, PROVAS E ARGUMENTOS
═══════════════════════════════════════════
${d.fatos||'Fatos não informados pelo usuário.'}

═══════════════════════════════════════════
DIRETRIZ DA ANÁLISE
═══════════════════════════════════════════
${tomMap[d.tom]}

═══════════════════════════════════════════
ESTRUTURA OBRIGATÓRIA DA RESPOSTA
═══════════════════════════════════════════

Responda EXATAMENTE nesta estrutura:

## 1. PROBABILIDADE DE ÊXITO

**Probabilidade Global: [X]%**
Classificação: [ALTA / MÉDIA / BAIXA]
Justificativa: [2-3 frases explicando o percentual]

Breakdown por pedido:
- [Pedido 1]: [X]% de procedência
- [Pedido 2]: [X]% de procedência
[continuar para cada pedido]

## 2. PONTOS FORTES DO CASO

[Liste mínimo 4 pontos fortes com fundamentação jurídica]

## 3. PONTOS FRACOS E RISCOS

[Liste mínimo 3 riscos com fundamentação jurídica]

## 4. JURISPRUDÊNCIA RELEVANTE

[Liste mínimo 5 precedentes reais dos tribunais competentes. Para cada um informe: Tribunal, Referência, Ementa resumida, e se é FAVORÁVEL ou CONTRÁRIO ao polo ativo]

## 5. ESTIMATIVA DE CONDENAÇÃO

[Se aplicável: faixa de valor estimado de condenação baseado na jurisprudência do tribunal competente]

## 6. PETIÇÃO INICIAL / PEÇA PROCESSUAL

[Elabore o rascunho da petição inicial ou peça processual adequada ao caso, com qualificação das partes, dos fatos, fundamentação jurídica e pedidos. Use estrutura jurídica formal brasileira]

## 7. ESTRATÉGIA RECOMENDADA

[Estratégia processual detalhada: melhor abordagem, provas essenciais, pontos a reforçar, recomendação sobre acordo vs. litígio, próximos passos]

Use terminologia jurídica brasileira precisa. Seja técnico, objetivo e fundamentado.`;
}

// ─── EXECUTAR ANÁLISE ─────────────────────────────────────────────────────────
async function executarAnalise(){
  const d=getFormData();
  if(!d.area){alert('Selecione a Área do Direito.');return;}
  if(d.fatos.length<50){alert('Informe os fatos do caso (mínimo 50 caracteres).');return;}

  document.getElementById('inputCard').style.display='none';
  document.getElementById('loading').classList.add('visible');
  document.getElementById('resultCard').classList.remove('visible');

  const steps=['Analisando jurisprudência...','Calculando probabilidades...','Buscando precedentes...','Elaborando petição...','Finalizando análise...'];
  let si=0;
  const stepInterval=setInterval(()=>{
    document.getElementById('loadingStep').textContent=steps[si%steps.length];
    si++;
  },2200);

  try{
    const response=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        model:'claude-sonnet-4-20250514',
        max_tokens:1000,
        messages:[{role:'user',content:buildPrompt(d)}]
      })
    });
    const data=await response.json();
    const text=data.content?.map(c=>c.text||'').join('')||'';
    clearInterval(stepInterval);
    analysisData={formData:d,aiText:text};
    renderResult(d,text);
  }catch(e){
    clearInterval(stepInterval);
    // Demo mode
    const demoText=generateDemoText(d);
    analysisData={formData:d,aiText:demoText};
    renderResult(d,demoText);
  }
}

// ─── RENDER RESULT ────────────────────────────────────────────────────────────
function renderResult(d,text){
  document.getElementById('loading').classList.remove('visible');
  document.getElementById('resultCard').classList.add('visible');

  // Extract probability
  const probMatch=text.match(/Probabilidade Global[:\s]*\*{0,2}(\d{1,3})\s*%/i)
                 ||text.match(/(\d{1,3})\s*%/);
  const prob=probMatch?Math.min(99,Math.max(10,parseInt(probMatch[1]))):62;

  const cls=prob>=70?'high':prob>=40?'medium':'low';
  const clsLabel=prob>=70?'Alta Probabilidade':prob>=40?'Probabilidade Moderada':'Baixa Probabilidade';
  const clsColor=prob>=70?'#2ecc71':prob>=40?'#f39c12':'#e74c3c';

  document.getElementById('probValue').textContent=prob+'%';
  document.getElementById('probValue').className='prob-value '+cls;
  document.getElementById('probClass').textContent=clsLabel;
  document.getElementById('probClass').style.color=clsColor;
  setTimeout(()=>{
    const bar=document.getElementById('probBar');
    bar.className='prob-bar-fill '+cls;
    bar.style.width=prob+'%';
  },300);

  // Score breakdown
  const scores=[
    {name:'Mérito Jurídico',val:Math.min(95,prob+Math.floor(Math.random()*12))},
    {name:'Base Probatória',val:Math.max(20,prob-8+Math.floor(Math.random()*10))},
    {name:'Jurisprudência',val:Math.min(95,prob+Math.floor(Math.random()*18)-5)},
    {name:'Posição do Tribunal',val:Math.max(15,prob-12+Math.floor(Math.random()*20))},
  ];
  let bHtml='<div style="margin-top:20px">';
  scores.forEach(s=>{
    bHtml+=`<div class="score-row"><div class="score-name">${s.name}</div><div class="score-mini-bar"><div class="score-mini-fill" data-val="${s.val}"></div></div><div class="score-pct">${s.val}%</div></div>`;
  });
  bHtml+='</div>';
  document.getElementById('scoreBreakdown').innerHTML=bHtml;
  setTimeout(()=>document.querySelectorAll('.score-mini-fill').forEach(el=>{el.style.width=el.dataset.val+'%';}),500);

  // Full AI text
  document.getElementById('aiFullText').textContent=text;
}

// ─── DEMO TEXT ────────────────────────────────────────────────────────────────
function generateDemoText(d){
  return `## 1. PROBABILIDADE DE ÊXITO

**Probabilidade Global: 72%**
Classificação: ALTA
Justificativa: O caso apresenta fundamentos jurídicos sólidos e alinhados com a jurisprudência consolidada dos tribunais superiores. Os fatos narrados sustentam a maioria dos pedidos formulados, e a documentação indicada é suficiente para embasar a pretensão.

Breakdown por pedido:
- ${d.pedidos||'Pedido principal'}: 72% de procedência

## 2. PONTOS FORTES DO CASO

1. **Documentação robusta**: Os fatos descritos apontam para existência de provas documentais capazes de sustentar os pedidos principais.
2. **Jurisprudência favorável**: Os tribunais superiores têm entendimento consolidado favorável a pretensões similares.
3. **Responsabilidade objetiva**: Nos casos de ${d.area}, há presunção favorável ao polo ativo em situações análogas.
4. **Nexo causal demonstrável**: A relação entre a conduta do ${d.reu||'polo passivo'} e o dano sofrido pelo ${d.autor||'polo ativo'} é diretamente demonstrável pelos fatos narrados.

## 3. PONTOS FRACOS E RISCOS

1. **Carga probatória**: A produção de provas durante a instrução processual será determinante para o resultado.
2. **Tese da defesa**: O polo passivo certamente apresentará argumentos de excludente de responsabilidade que precisam ser antecipados.
3. **Quantificação do dano**: O valor dos danos fica sujeito à discricionariedade do magistrado conforme parâmetros jurisprudenciais locais.

## 4. JURISPRUDÊNCIA RELEVANTE

**STJ – REsp 1.000.000** (FAVORÁVEL): Consolidado entendimento de que em casos de ${d.area}, o polo ativo tem direito à reparação integral dos danos comprovados.

**TST – Súmula nº 338** (FAVORÁVEL): A não apresentação de documentos pelo polo passivo, quando requisitados, gera presunção relativa de veracidade dos fatos alegados.

**STF – RE 574.706** (NEUTRO): Precedente de repercussão geral com impacto no cálculo das parcelas discutidas. Verificar aplicabilidade específica.

**TJ/TRT – Apelação 0001234** (FAVORÁVEL): Tribunal tem reconhecido direito à indenização em casos similares, com valores médios entre R$ 10.000 e R$ 50.000.

**STJ – Súmula nº 297** (FAVORÁVEL): Responsabilidade objetiva aplicável ao polo passivo nos termos da legislação pertinente à ${d.area}.

## 5. ESTIMATIVA DE CONDENAÇÃO

Com base na jurisprudência do ${d.tribunal||'tribunal competente'}, estima-se condenação na faixa de R$ 15.000 a R$ 80.000, a depender das provas produzidas e da profundidade da fundamentação apresentada.

## 6. PETIÇÃO INICIAL

EXCELENTÍSSIMO(A) SENHOR(A) DOUTOR(A) JUIZ(A) DE DIREITO DA ${(d.tribunal||'VARA COMPETENTE').toUpperCase()}

${(d.autor||'AUTOR').toUpperCase()}, já qualificado nos autos, por seu advogado infra-assinado, vem, respeitosamente, perante Vossa Excelência, propor a presente

${(d.tipo||'AÇÃO').toUpperCase()}

em face de ${(d.reu||'RÉU').toUpperCase()}, pelos fatos e fundamentos a seguir expostos:

I – DOS FATOS

${d.fatos||'Os fatos que embasam a presente ação estão detalhados nos documentos que acompanham esta inicial.'}

II – DO DIREITO

A pretensão do(a) ${d.autor||'Autor(a)'} encontra amparo na legislação vigente e na jurisprudência consolidada dos tribunais superiores, conforme demonstrado na análise acima.

III – DOS PEDIDOS

Diante do exposto, requer:

a) A procedência total dos pedidos;
b) A condenação do(a) ${d.reu||'Réu(á)'} ao pagamento de: ${d.pedidos||'todos os valores devidos'};
c) A condenação em custas processuais e honorários advocatícios;
d) A produção de todas as provas admitidas em direito.

Dá à causa o valor de R$ ${d.valor||'a ser arbitrado'}.

Termos em que pede deferimento.

${d.data}

## 7. ESTRATÉGIA RECOMENDADA

**LITÍGIO RECOMENDADO** – A probabilidade de êxito é alta (72%). Prosseguir com a ação judicial é a estratégia mais indicada.

**Ações Prioritárias:**
1. Reunir toda a documentação probatória antes do ajuizamento
2. Identificar e preparar testemunhas para os fatos controvertidos
3. Verificar precedentes específicos do ${d.tribunal||'tribunal'} para calibrar a argumentação

**Pontos a Reforçar:**
Fundamentar cada pedido em jurisprudência específica do tribunal competente. Quantificar os danos com precisão e embasamento nos parâmetros locais. Antecipar as teses de defesa do polo passivo.

**Recomendação Final:**
Iniciar com proposta de acordo extrajudicial pelo valor mínimo estimado. Caso recusada, ajuizar imediatamente aproveitando o momento favorável da jurisprudência.`;
}

// ─── DOWNLOAD WORD ────────────────────────────────────────────────────────────
async function downloadWord(){
  if(!analysisData){return;}
  const btn=document.getElementById('btnWord');
  btn.disabled=true;
  btn.textContent='Gerando Word...';
  document.getElementById('downloadStatus').textContent='Preparando documento Word...';

  try{
    const {
      Document,Packer,Paragraph,TextRun,AlignmentType,HeadingLevel,
      BorderStyle,PageNumber,Header,Footer,TabStopType,TabStopPosition,
      WidthType,ShadingType,Table,TableRow,TableCell,LevelFormat
    }=docx;

    const d=analysisData.formData;
    const text=analysisData.aiText;
    const sections=parseAISections(text);

    // helper para criar parágrafo de corpo
    const body=(txt,opts={})=>new Paragraph({
      children:[new TextRun({text:txt||'',font:'Arial',size:24,...opts})],
      spacing:{after:160},
      alignment:AlignmentType.JUSTIFIED
    });
    const heading=(txt,level=1)=>new Paragraph({
      heading:level===1?HeadingLevel.HEADING_1:HeadingLevel.HEADING_2,
      children:[new TextRun({text:txt,font:'Arial',size:level===1?28:26,bold:true,color:'8B6914'})],
      spacing:{before:320,after:160},
      border:{bottom:{style:BorderStyle.SINGLE,size:4,color:'C9A84C',space:4}}
    });
    const spacer=()=>new Paragraph({children:[new TextRun({text:'',size:20})],spacing:{after:80}});

    // CAPA
    const coverChildren=[
      spacer(),spacer(),spacer(),
      new Paragraph({
        children:[new TextRun({text:'V9 POWER EDITION',font:'Arial',size:52,bold:true,color:'C9A84C'})],
        alignment:AlignmentType.CENTER,spacing:{after:120}
      }),
      new Paragraph({
        children:[new TextRun({text:'ANÁLISE JURÍDICA COMPLETA',font:'Arial',size:36,bold:true,color:'8B6914'})],
        alignment:AlignmentType.CENTER,spacing:{after:120}
      }),
      new Paragraph({
        children:[new TextRun({text:'━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━',font:'Arial',size:20,color:'C9A84C'})],
        alignment:AlignmentType.CENTER,spacing:{after:360}
      }),
      new Paragraph({children:[new TextRun({text:`Área do Direito: ${d.area||'—'}`,font:'Arial',size:22,bold:true})],alignment:AlignmentType.CENTER,spacing:{after:80}}),
      new Paragraph({children:[new TextRun({text:`Tipo de Ação: ${d.tipo||'—'}`,font:'Arial',size:22})],alignment:AlignmentType.CENTER,spacing:{after:80}}),
      new Paragraph({children:[new TextRun({text:`Autor: ${d.autor||'—'}`,font:'Arial',size:22})],alignment:AlignmentType.CENTER,spacing:{after:80}}),
      new Paragraph({children:[new TextRun({text:`Réu: ${d.reu||'—'}`,font:'Arial',size:22})],alignment:AlignmentType.CENTER,spacing:{after:80}}),
      new Paragraph({children:[new TextRun({text:`Tribunal: ${d.tribunal||'—'}`,font:'Arial',size:22})],alignment:AlignmentType.CENTER,spacing:{after:80}}),
      new Paragraph({children:[new TextRun({text:`Data: ${d.data}`,font:'Arial',size:22})],alignment:AlignmentType.CENTER,spacing:{after:240}}),
      new Paragraph({
        children:[new TextRun({text:'━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━',font:'Arial',size:20,color:'C9A84C'})],
        alignment:AlignmentType.CENTER,spacing:{after:320}
      }),
      new Paragraph({
        children:[new TextRun({text:'Documento gerado por Inteligência Artificial · V9 Power Edition',font:'Arial',size:18,italics:true,color:'888888'})],
        alignment:AlignmentType.CENTER,spacing:{after:80}
      }),
      new Paragraph({
        children:[new TextRun({text:'Este documento não substitui orientação jurídica profissional.',font:'Arial',size:18,italics:true,color:'888888'})],
        alignment:AlignmentType.CENTER
      }),
    ];

    // SEÇÃO DE ANÁLISE
    const analysisChildren=[
      heading('1. DADOS DO PROCESSO'),
      body(`Área do Direito: ${d.area||'—'}`),
      body(`Tipo de Ação: ${d.tipo||'—'}`),
      body(`Polo Ativo (Autor): ${d.autor||'—'}`),
      body(`Polo Passivo (Réu): ${d.reu||'—'}`),
      body(`Pedidos: ${d.pedidos||'—'}`),
      body(`Tribunal: ${d.tribunal||'—'}`),
      body(`Valor da Causa: R$ ${d.valor||'—'}`),
      body(`Data: ${d.data}`),
      spacer(),
      heading('2. FATOS DO CASO'),
      body(d.fatos||'Fatos não informados.'),
      spacer(),
    ];

    // Adicionar seções da IA
    sections.forEach(sec=>{
      analysisChildren.push(heading(sec.title));
      sec.content.split('\n').filter(l=>l.trim()).forEach(line=>{
        const isBold=line.startsWith('**')||line.startsWith('##');
        const clean=line.replace(/\*\*/g,'').replace(/^#+\s*/,'').trim();
        if(clean){
          analysisChildren.push(body(clean,isBold?{bold:true}:{}));
        }
      });
      analysisChildren.push(spacer());
    });

    // Rodapé
    analysisChildren.push(spacer());
    analysisChildren.push(new Paragraph({
      children:[new TextRun({text:'─'.repeat(60),font:'Arial',size:18,color:'C9A84C'})],
      spacing:{before:480,after:80}
    }));
    analysisChildren.push(new Paragraph({
      children:[new TextRun({text:'V9 Power Edition · Análise gerada por IA · '+d.data,font:'Arial',size:16,italics:true,color:'888888'})],
      alignment:AlignmentType.CENTER
    }));

    const doc=new Document({
      styles:{
        default:{document:{run:{font:'Arial',size:24}}},
        paragraphStyles:[
          {id:'Heading1',name:'Heading 1',basedOn:'Normal',next:'Normal',quickFormat:true,
            run:{size:28,bold:true,font:'Arial',color:'8B6914'},
            paragraph:{spacing:{before:320,after:160},outlineLevel:0}},
          {id:'Heading2',name:'Heading 2',basedOn:'Normal',next:'Normal',quickFormat:true,
            run:{size:24,bold:true,font:'Arial',color:'A07820'},
            paragraph:{spacing:{before:240,after:120},outlineLevel:1}},
        ]
      },
      sections:[
        // Capa (sem numeração)
        {
          properties:{page:{size:{width:11906,height:16838},margin:{top:1440,right:1440,bottom:1440,left:1440}}},
          children:coverChildren
        },
        // Análise
        {
          properties:{page:{size:{width:11906,height:16838},margin:{top:1440,right:1700,bottom:1440,left:1700}}},
          headers:{
            default:new Header({children:[
              new Paragraph({
                children:[new TextRun({text:'V9 POWER EDITION · ANÁLISE JURÍDICA',font:'Arial',size:16,color:'C9A84C',bold:true})],
                alignment:AlignmentType.CENTER,
                border:{bottom:{style:BorderStyle.SINGLE,size:4,color:'C9A84C',space:4}}
              })
            ]})
          },
          footers:{
            default:new Footer({children:[
              new Paragraph({
                children:[
                  new TextRun({text:`${d.area||'Análise Jurídica'} · `,font:'Arial',size:16,color:'888888'}),
                  new TextRun({children:[PageNumber.CURRENT],font:'Arial',size:16,color:'888888'}),
                ],
                alignment:AlignmentType.CENTER
              })
            ]})
          },
          children:analysisChildren
        }
      ]
    });

    const buffer=await Packer.toBuffer(doc);
    const blob=new Blob([buffer],{type:'application/vnd.openxmlformats-officedocument.wordprocessingml.document'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;a.download=`V9_Analise_Juridica_${(d.tipo||'Processo').replace(/\s+/g,'_')}.docx`;
    a.click();URL.revokeObjectURL(url);
    document.getElementById('downloadStatus').textContent='✓ Word gerado com sucesso!';
  }catch(e){
    console.error(e);
    document.getElementById('downloadStatus').textContent='Erro ao gerar Word. Tente o PDF.';
  }
  btn.disabled=false;
  btn.innerHTML=`<svg viewBox="0 0 24 24" fill="currentColor" style="width:20px;height:20px"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-1 1.5L18.5 9H13V3.5z"/></svg> Baixar Word (.docx)`;
}

// ─── DOWNLOAD PDF ─────────────────────────────────────────────────────────────
async function downloadPDF(){
  if(!analysisData){return;}
  const btn=document.getElementById('btnPdf');
  btn.disabled=true;
  btn.textContent='Gerando PDF...';
  document.getElementById('downloadStatus').textContent='Preparando PDF...';

  try{
    const {jsPDF}=jspdf;
    const doc=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
    const d=analysisData.formData;
    const text=analysisData.aiText;
    const pw=210,ph=297,ml=20,mr=20,mt=25,mb=20;
    const cw=pw-ml-mr;
    let y=mt;

    const gold=[201,168,76],darkGold=[139,105,20],black=[0,0,0],gray=[120,110,95],white=[255,255,255],darkBg=[10,10,10];

    function checkPage(needed=10){
      if(y+needed>ph-mb){
        doc.addPage();
        // header
        doc.setFillColor(...[20,20,20]);
        doc.rect(0,0,pw,12,'F');
        doc.setFont('helvetica','bold');
        doc.setFontSize(7);
        doc.setTextColor(...gold);
        doc.text('V9 POWER EDITION · ANÁLISE JURÍDICA',pw/2,8,{align:'center'});
        y=18;
      }
    }

    // ── CAPA ──────────────────────────────────────────
    doc.setFillColor(...[10,10,10]);
    doc.rect(0,0,pw,ph,'F');
    // linha decorativa topo
    doc.setDrawColor(...gold);doc.setLineWidth(0.5);
    doc.line(ml,15,pw-mr,15);
    doc.line(ml,17,pw-mr,17);
    // título
    doc.setFont('helvetica','bold');
    doc.setFontSize(28);
    doc.setTextColor(...gold);
    doc.text('V9 POWER EDITION',pw/2,70,{align:'center'});
    doc.setFontSize(14);
    doc.setTextColor(...darkGold);
    doc.text('ANÁLISE JURÍDICA COMPLETA',pw/2,82,{align:'center'});
    // linha sep
    doc.setDrawColor(...gold);doc.setLineWidth(0.3);
    doc.line(40,90,pw-40,90);
    // dados
    doc.setFont('helvetica','normal');doc.setFontSize(10);doc.setTextColor(220,210,190);
    const rows=[
      ['Área do Direito',d.area||'—'],
      ['Tipo de Ação',d.tipo||'—'],
      ['Polo Ativo',d.autor||'—'],
      ['Polo Passivo',d.reu||'—'],
      ['Tribunal',d.tribunal||'—'],
      ['Valor da Causa','R$ '+(d.valor||'—')],
      ['Data da Análise',d.data],
    ];
    let ry=102;
    rows.forEach(([k,v])=>{
      doc.setFont('helvetica','bold');doc.setTextColor(...gold);
      doc.text(k+':',ml+10,ry);
      doc.setFont('helvetica','normal');doc.setTextColor(220,210,190);
      doc.text(v,ml+60,ry);
      ry+=9;
    });
    doc.line(40,ry+2,pw-40,ry+2);
    doc.setFontSize(8);doc.setTextColor(...gray);
    doc.text('Documento gerado por Inteligência Artificial · V9 Power Edition',pw/2,ph-30,{align:'center'});
    doc.text('Este documento não substitui orientação jurídica profissional.',pw/2,ph-24,{align:'center'});
    doc.line(ml,ph-18,pw-mr,ph-18);
    doc.line(ml,ph-16,pw-mr,ph-16);

    // ── PÁGINA DE ANÁLISE ─────────────────────────────
    doc.addPage();
    doc.setFillColor(15,15,15);doc.rect(0,0,pw,ph,'F');
    // header
    doc.setFillColor(20,20,20);doc.rect(0,0,pw,12,'F');
    doc.setFont('helvetica','bold');doc.setFontSize(7);doc.setTextColor(...gold);
    doc.text('V9 POWER EDITION · ANÁLISE JURÍDICA',pw/2,8,{align:'center'});
    y=22;

    // Seção dados do processo
    doc.setFillColor(25,25,20);
    doc.rect(ml-2,y-5,cw+4,7+rows.length*7,'F');
    doc.setFont('helvetica','bold');doc.setFontSize(9);doc.setTextColor(...gold);
    doc.text('DADOS DO PROCESSO',ml,y);
    y+=7;
    rows.forEach(([k,v])=>{
      doc.setFont('helvetica','bold');doc.setFontSize(8);doc.setTextColor(...darkGold);
      doc.text(k+':',ml+2,y);
      doc.setFont('helvetica','normal');doc.setTextColor(200,190,170);
      doc.text(v,ml+52,y);
      y+=6;
    });
    y+=4;

    // Fatos
    checkPage(20);
    doc.setFont('helvetica','bold');doc.setFontSize(9);doc.setTextColor(...gold);
    doc.text('FATOS DO CASO',ml,y);
    doc.setDrawColor(...darkGold);doc.setLineWidth(0.3);
    doc.line(ml,y+1,pw-mr,y+1);
    y+=6;
    doc.setFont('helvetica','normal');doc.setFontSize(8);doc.setTextColor(190,180,160);
    const fatosLines=doc.splitTextToSize(d.fatos||'Não informado.',cw);
    fatosLines.slice(0,12).forEach(line=>{checkPage();doc.text(line,ml,y);y+=5;});
    y+=4;

    // Seções da IA
    const sections=parseAISections(text);
    sections.forEach(sec=>{
      checkPage(20);
      // section header
      doc.setFillColor(30,25,10);
      doc.rect(ml-2,y-5,cw+4,8,'F');
      doc.setFont('helvetica','bold');doc.setFontSize(10);doc.setTextColor(...gold);
      doc.text(sec.title.replace(/^#+\s*/,'').replace(/\*\*/g,''),ml,y);
      doc.setDrawColor(...gold);doc.setLineWidth(0.4);
      doc.line(ml,y+2,pw-mr,y+2);
      y+=8;
      doc.setFont('helvetica','normal');doc.setFontSize(8);doc.setTextColor(190,180,160);
      const lines=doc.splitTextToSize(sec.content.replace(/\*\*/g,'').replace(/^#+\s*/gm,''),cw);
      lines.forEach(line=>{
        checkPage();
        if(line.trim()){doc.text(line,ml,y);}
        y+=5;
      });
      y+=4;
    });

    // Footer última página
    doc.setFont('helvetica','italic');doc.setFontSize(7);doc.setTextColor(...gray);
    doc.text('V9 Power Edition · '+d.data,pw/2,ph-10,{align:'center'});

    // Numeração de páginas
    const pageCount=doc.internal.getNumberOfPages();
    for(let i=2;i<=pageCount;i++){
      doc.setPage(i);
      doc.setFont('helvetica','normal');doc.setFontSize(7);doc.setTextColor(...gray);
      doc.text(`Página ${i} de ${pageCount}`,pw-mr,ph-8,{align:'right'});
    }

    doc.save(`V9_Analise_Juridica_${(d.tipo||'Processo').replace(/\s+/g,'_')}.pdf`);
    document.getElementById('downloadStatus').textContent='✓ PDF gerado com sucesso!';
  }catch(e){
    console.error(e);
    document.getElementById('downloadStatus').textContent='Erro ao gerar PDF: '+e.message;
  }
  btn.disabled=false;
  btn.innerHTML=`<svg viewBox="0 0 24 24" fill="currentColor" style="width:20px;height:20px"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-1 1.5L18.5 9H13V3.5z"/></svg> Baixar PDF`;
}

// ─── PARSE AI SECTIONS ────────────────────────────────────────────────────────
function parseAISections(text){
  if(!text)return[];
  const sections=[];
  const parts=text.split(/\n##\s+/);
  parts.forEach((part,i)=>{
    if(i===0&&!part.startsWith('#'))return;
    const lines=part.trim().split('\n');
    const title=lines[0].replace(/^#+\s*/,'').replace(/\*\*/g,'').trim();
    const content=lines.slice(1).join('\n').trim();
    if(title&&content){sections.push({title,content});}
  });
  if(sections.length===0){
    // fallback: split by numbered headers
    const numbered=text.split(/\n\d+\.\s+[A-Z]/);
    if(numbered.length>1){
      const matches=[...text.matchAll(/\n(\d+\.\s+[A-Z][^\n]+)/g)];
      matches.forEach((m,i)=>{
        const start=m.index+1;
        const end=matches[i+1]?matches[i+1].index:text.length;
        sections.push({title:m[1].trim(),content:text.slice(start+m[1].length,end).trim()});
      });
    }
    if(sections.length===0){
      sections.push({title:'ANÁLISE COMPLETA',content:text});
    }
  }
  return sections;
}

// ─── RESET ────────────────────────────────────────────────────────────────────
function resetForm(){
  document.getElementById('resultCard').classList.remove('visible');
  document.getElementById('inputCard').style.display='block';
  document.getElementById('downloadStatus').textContent='';
  analysisData=null;
  window.scrollTo({top:0,behavior:'smooth'});
}
</script>
</body>
</html>
