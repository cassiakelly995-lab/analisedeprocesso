<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>V9 POWER EDITION â€“ AnÃ¡lise JurÃ­dica</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Rajdhani:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.5.0/docx.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
<style>
:root{
  --gold:#c9a84c;--gold-light:#e8c96b;--gold-dark:#8b6914;
  --bg:#080808;--card:#101010;--card2:#161616;--border:#252525;
  --text:#e0d5c0;--muted:#6b6050;--green:#2ecc71;--red:#e74c3c;--yellow:#f39c12;
}
*{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{background:var(--bg);color:var(--text);font-family:'Rajdhani',sans-serif;font-size:15px;line-height:1.6;min-height:100vh;overflow-x:hidden}
body::after{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.035'/%3E%3C/svg%3E");pointer-events:none;z-index:9999;opacity:.4}
body::before{content:'';position:fixed;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent 0%,var(--gold-dark) 20%,var(--gold-light) 50%,var(--gold-dark) 80%,transparent 100%);z-index:100}

header{text-align:center;padding:46px 20px 24px}
header::after{content:'';display:block;width:300px;height:1px;background:linear-gradient(90deg,transparent,var(--gold-dark),var(--gold),var(--gold-dark),transparent);margin:0 auto}
.logo-text{font-family:'Cinzel',serif;font-size:clamp(1.6rem,5vw,2.8rem);letter-spacing:.4em;background:linear-gradient(135deg,var(--gold-dark),var(--gold-light),var(--gold),var(--gold-dark));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;display:inline-block}
.logo-sub{font-size:.65rem;letter-spacing:.4em;color:var(--muted);margin-top:6px;text-transform:uppercase}
.logo-badge{display:inline-block;font-size:.55rem;letter-spacing:.25em;color:var(--gold-dark);border:1px solid var(--gold-dark);padding:2px 12px;margin-top:8px;border-radius:2px;text-transform:uppercase}

.container{max-width:960px;margin:0 auto;padding:28px 20px 80px;position:relative;z-index:1}

.card{background:var(--card);border:1px solid var(--border);border-radius:6px;padding:28px;margin-bottom:20px;position:relative;overflow:hidden}
.card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--gold-dark),var(--gold),var(--gold-dark),transparent)}

.section-label{font-size:.6rem;letter-spacing:.35em;color:var(--gold);text-transform:uppercase;margin-bottom:18px;display:flex;align-items:center;gap:12px;font-weight:700}
.section-label::after{content:'';flex:1;height:1px;background:linear-gradient(90deg,var(--border),transparent)}

label{display:block;font-size:.62rem;letter-spacing:.22em;color:var(--muted);text-transform:uppercase;margin-bottom:5px;margin-top:16px}
label:first-of-type{margin-top:0}
input[type=text],select,textarea{width:100%;background:var(--card2);border:1px solid var(--border);border-radius:3px;color:var(--text);font-family:'Rajdhani',sans-serif;font-size:14px;padding:11px 14px;outline:none;transition:border-color .2s,box-shadow .2s;letter-spacing:.03em}
input[type=text]:focus,select:focus,textarea:focus{border-color:var(--gold-dark);box-shadow:0 0 0 2px rgba(139,105,20,.1)}
select option{background:#161616}
textarea{resize:vertical;min-height:130px}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
@media(max-width:620px){.grid2{grid-template-columns:1fr}}

/* â”€â”€ UPLOAD ZONE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.upload-zone{border:2px dashed var(--border);border-radius:6px;padding:32px 20px;text-align:center;cursor:pointer;transition:all .25s;background:var(--card2);position:relative;overflow:hidden}
.upload-zone:hover,.upload-zone.drag{border-color:var(--gold-dark);background:rgba(139,105,20,.06)}
.upload-zone.has-file{border-color:var(--gold);border-style:solid;background:rgba(201,168,76,.06)}
.upload-icon{font-size:2.4rem;margin-bottom:10px;display:block;opacity:.6}
.upload-title{font-size:.85rem;letter-spacing:.15em;color:var(--text);font-weight:600;text-transform:uppercase}
.upload-sub{font-size:.7rem;color:var(--muted);margin-top:5px;letter-spacing:.05em}
.upload-types{font-size:.62rem;color:var(--gold-dark);margin-top:8px;letter-spacing:.12em;text-transform:uppercase}
.upload-file-name{font-size:.78rem;color:var(--gold);margin-top:10px;letter-spacing:.08em;font-weight:600}
.upload-file-size{font-size:.65rem;color:var(--muted);margin-top:3px}
#fileInput{display:none}
.upload-clear{display:none;background:rgba(231,76,60,.15);border:1px solid rgba(231,76,60,.3);color:#e09090;font-size:.62rem;letter-spacing:.15em;padding:5px 14px;border-radius:3px;cursor:pointer;margin-top:10px;text-transform:uppercase;transition:all .2s}
.upload-clear:hover{background:rgba(231,76,60,.25)}
.upload-progress{display:none;margin-top:12px}
.upload-progress-bar{height:3px;background:var(--border);border-radius:2px;overflow:hidden}
.upload-progress-fill{height:100%;background:linear-gradient(90deg,var(--gold-dark),var(--gold));width:0%;transition:width .3s}
.upload-progress-text{font-size:.62rem;color:var(--muted);margin-top:5px;letter-spacing:.08em}

/* Extracted text preview */
.extracted-preview{display:none;background:var(--card2);border:1px solid var(--border);border-radius:4px;padding:14px;margin-top:14px}
.extracted-preview-label{font-size:.6rem;letter-spacing:.25em;color:var(--gold-dark);text-transform:uppercase;margin-bottom:8px}
.extracted-preview-text{font-size:12px;color:var(--muted);line-height:1.6;max-height:120px;overflow-y:auto;white-space:pre-wrap;word-break:break-word}
.extracted-chars{font-size:.6rem;color:var(--muted);margin-top:6px;letter-spacing:.08em}

/* Mode toggle */
.mode-toggle{display:flex;gap:0;margin-bottom:20px;border:1px solid var(--border);border-radius:4px;overflow:hidden}
.mode-btn{flex:1;padding:11px;background:var(--card2);border:none;color:var(--muted);font-family:'Rajdhani',sans-serif;font-size:.68rem;letter-spacing:.2em;cursor:pointer;transition:all .2s;text-transform:uppercase;font-weight:600}
.mode-btn.active{background:linear-gradient(135deg,var(--gold-dark),rgba(201,168,76,.5));color:var(--gold-light);border-color:var(--gold-dark)}
.mode-btn:first-child{border-right:1px solid var(--border)}

/* Tone */
.tone-group{display:flex;gap:8px;flex-wrap:wrap}
.tone-btn{background:var(--card2);border:1px solid var(--border);border-radius:3px;color:var(--muted);font-family:'Rajdhani',sans-serif;font-size:.62rem;letter-spacing:.2em;padding:8px 14px;cursor:pointer;text-transform:uppercase;transition:all .2s}
.tone-btn:hover{border-color:var(--gold-dark);color:var(--gold-dark)}
.tone-btn.active{background:linear-gradient(135deg,var(--gold-dark),var(--gold));border-color:var(--gold);color:#000;font-weight:700}

/* Execute */
.btn-execute{width:100%;padding:17px;background:linear-gradient(135deg,#6b4f0a,var(--gold),#6b4f0a);border:none;border-radius:4px;font-family:'Cinzel',serif;font-size:.78rem;letter-spacing:.3em;color:#000;font-weight:700;cursor:pointer;transition:all .3s;text-transform:uppercase;margin-top:18px;overflow:hidden;position:relative}
.btn-execute::after{content:'';position:absolute;inset:0;background:linear-gradient(135deg,transparent,rgba(255,255,255,.1),transparent);transform:translateX(-100%);transition:.5s}
.btn-execute:hover::after{transform:translateX(100%)}
.btn-execute:hover{transform:translateY(-1px);box-shadow:0 10px 35px rgba(201,168,76,.22)}
.btn-execute:disabled{opacity:.4;cursor:not-allowed;transform:none;box-shadow:none}

/* Loading */
.loading{display:none;text-align:center;padding:64px 20px}
.loading.visible{display:block}
.spinner-ring{width:52px;height:52px;margin:0 auto 18px;position:relative}
.spinner-ring::before,.spinner-ring::after{content:'';position:absolute;inset:0;border-radius:50%;border:2px solid transparent}
.spinner-ring::before{border-top-color:var(--gold);animation:spin .9s linear infinite}
.spinner-ring::after{border-bottom-color:var(--gold-dark);animation:spin 1.5s linear infinite reverse;inset:7px}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-title{font-size:.68rem;letter-spacing:.3em;color:var(--muted);text-transform:uppercase}
.loading-step{font-size:.62rem;letter-spacing:.18em;color:var(--gold-dark);margin-top:9px;min-height:20px}

/* Result */
.result-card{display:none}
.result-card.visible{display:block;animation:fadeUp .5s ease}
@keyframes fadeUp{from{opacity:0;transform:translateY(18px)}to{opacity:1;transform:translateY(0)}}

/* Probability */
.prob-grid{display:grid;grid-template-columns:140px 1fr;gap:24px;align-items:start}
@media(max-width:500px){.prob-grid{grid-template-columns:1fr}}
.prob-value{font-family:'Cinzel',serif;font-size:3.8rem;font-weight:900;line-height:1}
.prob-value.high{color:var(--green)}.prob-value.medium{color:var(--yellow)}.prob-value.low{color:var(--red)}
.prob-bar-track{height:5px;background:var(--card2);border-radius:3px;overflow:hidden;border:1px solid var(--border);margin:14px 0 3px}
.prob-bar-fill{height:100%;border-radius:3px;transition:width 1.2s cubic-bezier(.16,1,.3,1);width:0%}
.prob-bar-fill.high{background:linear-gradient(90deg,#1e8449,var(--green))}.prob-bar-fill.medium{background:linear-gradient(90deg,#b7770d,var(--yellow))}.prob-bar-fill.low{background:linear-gradient(90deg,#922b21,var(--red))}

.score-row{display:flex;align-items:center;gap:12px;margin-bottom:9px}
.score-name{font-size:.62rem;letter-spacing:.1em;color:var(--muted);text-transform:uppercase;width:165px;flex-shrink:0}
.score-mini-bar{flex:1;height:4px;background:var(--card2);border-radius:2px;overflow:hidden}
.score-mini-fill{height:100%;background:linear-gradient(90deg,var(--gold-dark),var(--gold-light));border-radius:2px;transition:width 1.1s ease;width:0%}
.score-pct{font-size:.7rem;color:var(--gold);width:34px;text-align:right;font-family:'Cinzel',serif}

/* Full text */
.ai-result-text{font-size:13.5px;line-height:1.85;color:#a09880;white-space:pre-wrap;font-family:'Rajdhani',sans-serif}

/* Download */
.download-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:14px}
@media(max-width:500px){.download-grid{grid-template-columns:1fr}}
.btn-dl{width:100%;padding:15px;border:none;border-radius:4px;font-family:'Cinzel',serif;font-size:.68rem;letter-spacing:.2em;font-weight:700;cursor:pointer;transition:all .3s;text-transform:uppercase;display:flex;align-items:center;justify-content:center;gap:9px}
.btn-dl.word{background:linear-gradient(135deg,#0f2a52,#1a4a8a);color:#fff;border:1px solid #1a4a8a}
.btn-dl.pdf{background:linear-gradient(135deg,#4a0f0f,#8a1a1a);color:#fff;border:1px solid #8a1a1a}
.btn-dl:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,.5)}
.btn-dl:disabled{opacity:.4;cursor:not-allowed;transform:none;box-shadow:none}
.dl-status{font-size:.63rem;letter-spacing:.12em;color:var(--muted);text-align:center;padding:8px 0 0;min-height:22px;text-transform:uppercase}

.btn-nova{width:100%;padding:13px;background:transparent;border:1px solid var(--border);border-radius:4px;font-family:'Rajdhani',sans-serif;font-size:.7rem;letter-spacing:.3em;color:var(--muted);cursor:pointer;text-transform:uppercase;transition:all .2s;margin-top:4px}
.btn-nova:hover{border-color:var(--gold-dark);color:var(--gold)}

.disclaimer{background:rgba(201,168,76,.04);border:1px solid rgba(201,168,76,.12);border-radius:4px;padding:12px 16px;margin-bottom:20px;font-size:.71rem;color:var(--muted);line-height:1.65;letter-spacing:.04em}
.disclaimer strong{color:var(--gold-dark)}

.chars-info{font-size:.62rem;color:var(--muted);text-align:right;margin-top:4px;letter-spacing:.05em}
.chars-info span{color:var(--gold-dark)}

.hidden{display:none!important}
</style>
</head>
<body>

<header>
  <div class="logo-text">V9 POWER EDITION</div>
  <div class="logo-sub">Engenharia JurÃ­dica Â· AnÃ¡lise por IA Â· Upload de Documentos</div>
  <div class="logo-badge">Zero AlucinaÃ§Ã£o Â· AnÃ¡lise de Documentos Â· Word &amp; PDF</div>
</header>

<div class="container">

<div class="disclaimer">
  <strong>âš– V9 POWER:</strong> FaÃ§a upload do seu documento jurÃ­dico ou preencha os dados manualmente. A IA analisa o conteÃºdo real e <strong>NUNCA inventa dados</strong> â€” jurisprudÃªncias sÃ£o citadas como entendimentos gerais consolidados, nÃ£o nÃºmeros fabricados. NÃ£o substitui advogado.
</div>

<!-- INPUT CARD -->
<div class="card" id="inputCard">

  <!-- MODE TOGGLE -->
  <div class="section-label">â—ˆ Modo de AnÃ¡lise</div>
  <div class="mode-toggle">
    <button class="mode-btn active" id="modeUpload" onclick="setMode('upload')">ğŸ“ Anexar Documento</button>
    <button class="mode-btn" id="modeManual" onclick="setMode('manual')">âœï¸ Digitar Dados</button>
  </div>

  <!-- â”€â”€ UPLOAD SECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="uploadSection">
    <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()" ondragover="dragOver(event)" ondragleave="dragLeave(event)" ondrop="dropFile(event)">
      <span class="upload-icon" id="uploadIcon">ğŸ“„</span>
      <div class="upload-title" id="uploadTitle">Arraste ou clique para anexar</div>
      <div class="upload-sub" id="uploadSub">Contrato, PetiÃ§Ã£o, SentenÃ§a, NotificaÃ§Ã£o, Laudo...</div>
      <div class="upload-types">PDF Â· Word (.docx / .doc) Â· Imagem (JPG, PNG) Â· TXT</div>
      <div class="upload-file-name" id="uploadFileName"></div>
      <div class="upload-file-size" id="uploadFileSize"></div>
      <button class="upload-clear" id="uploadClear" onclick="clearFile(event)">âœ• Remover arquivo</button>
    </div>
    <input type="file" id="fileInput" accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.webp" onchange="handleFile(this.files[0])">

    <div class="upload-progress" id="uploadProgress">
      <div class="upload-progress-bar"><div class="upload-progress-fill" id="progressFill"></div></div>
      <div class="upload-progress-text" id="progressText">Lendo arquivo...</div>
    </div>

    <div class="extracted-preview" id="extractedPreview">
      <div class="extracted-preview-label">â—ˆ PrÃ©via do ConteÃºdo ExtraÃ­do</div>
      <div class="extracted-preview-text" id="extractedText"></div>
      <div class="extracted-chars">Total extraÃ­do: <span id="extractedChars">0</span> caracteres</div>
    </div>

    <!-- Optional extra context for upload mode -->
    <label style="margin-top:18px">InstruÃ§Ãµes ou Contexto Adicional <span style="color:var(--muted);font-size:.9em">(opcional)</span></label>
    <textarea id="extraContext" placeholder="Ex: Analise especialmente a clÃ¡usula de multa. Foco no risco para o credor. Verificar prescriÃ§Ã£o..." style="min-height:80px"></textarea>
  </div>

  <!-- â”€â”€ MANUAL SECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="manualSection" class="hidden">
    <div class="grid2">
      <div>
        <label>Ãrea do Direito *</label>
        <select id="areaDir">
          <option value="">Selecione...</option>
          <option>Direito Trabalhista</option>
          <option>Direito Civil</option>
          <option>Direito do Consumidor</option>
          <option>Direito PrevidenciÃ¡rio</option>
          <option>Direito de FamÃ­lia</option>
          <option>Direito TributÃ¡rio</option>
          <option>Direito Empresarial</option>
          <option>Direito Penal</option>
          <option>Direito Administrativo</option>
          <option>Direito Ambiental</option>
          <option>Direito Digital / Tecnologia</option>
          <option>Direito BancÃ¡rio</option>
        </select>
      </div>
      <div>
        <label>Tipo de AÃ§Ã£o / PeÃ§a</label>
        <input type="text" id="tipoAcao" placeholder="Ex: ReclamaÃ§Ã£o Trabalhista, IndenizaÃ§Ã£o..."/>
      </div>
    </div>
    <div class="grid2">
      <div>
        <label>Polo Ativo (Autor / Reclamante)</label>
        <input type="text" id="autor" placeholder="Ex: Empregado, Consumidor..."/>
      </div>
      <div>
        <label>Polo Passivo (RÃ©u / Reclamado)</label>
        <input type="text" id="reu" placeholder="Ex: Empresa XYZ, Banco ABC..."/>
      </div>
    </div>
    <label>Pedidos Principais</label>
    <input type="text" id="pedidos" placeholder="Ex: Horas extras, danos morais, FGTS, rescisÃ£o indireta..."/>
    <div class="grid2">
      <div>
        <label>Tribunal / InstÃ¢ncia</label>
        <select id="tribunal">
          <option value="">Selecione...</option>
          <option>1Âª InstÃ¢ncia â€“ Vara do Trabalho</option>
          <option>1Âª InstÃ¢ncia â€“ Vara CÃ­vel</option>
          <option>TRT (Tribunal Regional do Trabalho)</option>
          <option>TJ (Tribunal de JustiÃ§a Estadual)</option>
          <option>TST (Tribunal Superior do Trabalho)</option>
          <option>STJ (Superior Tribunal de JustiÃ§a)</option>
          <option>STF (Supremo Tribunal Federal)</option>
          <option>TRF (Tribunal Regional Federal)</option>
        </select>
      </div>
      <div>
        <label>Valor Est. da Causa (R$)</label>
        <input type="text" id="valorCausa" placeholder="Ex: 50.000,00"/>
      </div>
    </div>
    <label>Fatos, Provas e Argumentos *</label>
    <textarea id="fatos" placeholder="Descreva os fatos, provas disponÃ­veis, documentos, histÃ³rico do caso..."></textarea>
    <div class="chars-info"><span id="charsCount">0</span> caracteres</div>
  </div>

  <!-- COMMON: Tone selector -->
  <label style="margin-top:20px">Tom da AnÃ¡lise</label>
  <div class="tone-group">
    <button class="tone-btn active" data-tone="imparcial">Imparcial</button>
    <button class="tone-btn" data-tone="favoravel">FavorÃ¡vel ao Autor</button>
    <button class="tone-btn" data-tone="defensivo">Defensivo ao RÃ©u</button>
    <button class="tone-btn" data-tone="estrategico">EstratÃ©gico</button>
  </div>

  <button class="btn-execute" id="btnExecutar" onclick="executarAnalise()">
    âš– EXECUTAR ANÃLISE JURÃDICA V9 POWER
  </button>
</div>

<!-- LOADING -->
<div class="loading" id="loading">
  <div class="spinner-ring"></div>
  <p class="loading-title">Executando Engenharia V9 Power</p>
  <p class="loading-step" id="loadingStep">Inicializando anÃ¡lise...</p>
</div>

<!-- RESULTADO -->
<div class="result-card" id="resultCard">

  <div class="card">
    <div class="section-label">â—ˆ Probabilidade de ÃŠxito</div>
    <div class="prob-grid">
      <div>
        <div style="font-size:.58rem;letter-spacing:.22em;color:var(--muted);text-transform:uppercase;margin-bottom:5px">Estimativa Global</div>
        <div class="prob-value" id="probValue">â€”</div>
        <div id="probClass" style="font-size:.72rem;letter-spacing:.18em;text-transform:uppercase;margin-top:4px;font-weight:700"></div>
      </div>
      <div style="padding-top:2px">
        <div class="prob-bar-track"><div class="prob-bar-fill" id="probBar"></div></div>
        <div id="scoreBreakdown"></div>
      </div>
    </div>
    <div style="margin-top:10px;font-size:.63rem;color:var(--muted);letter-spacing:.07em">
      * Estimativa analÃ­tica baseada nos dados fornecidos. NÃ£o constitui garantia de resultado processual.
    </div>
  </div>

  <div class="card">
    <div class="section-label">â—ˆ AnÃ¡lise JurÃ­dica Completa</div>
    <div class="ai-result-text" id="aiFullText"></div>
  </div>

  <div class="card">
    <div class="section-label">â—ˆ Download do Documento Completo</div>
    <p style="font-size:13px;color:var(--muted);margin-bottom:2px">Documento profissional com capa, anÃ¡lise completa, fundamentaÃ§Ã£o e estratÃ©gia.</p>
    <div class="download-grid">
      <button class="btn-dl word" id="btnWord" onclick="downloadWord()">
        <svg width="17" height="17" viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-1 1.5L18.5 9H13V3.5z"/></svg>
        Baixar Word (.docx)
      </button>
      <button class="btn-dl pdf" id="btnPdf" onclick="downloadPDF()">
        <svg width="17" height="17" viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-1 1.5L18.5 9H13V3.5z"/></svg>
        Baixar PDF
      </button>
    </div>
    <div class="dl-status" id="dlStatus"></div>
  </div>

  <button class="btn-nova" onclick="resetForm()">â† NOVA ANÃLISE</button>
</div>

</div><!-- /container -->

<script>
// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentMode = 'upload';
let uploadedFile = null;
let extractedContent = ''; // full extracted text
let extractedBase64 = '';  // for images / pdf (base64)
let extractedMediaType = '';
let analysisData = null;

// â”€â”€ MODE TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setMode(mode){
  currentMode = mode;
  document.getElementById('modeUpload').classList.toggle('active', mode === 'upload');
  document.getElementById('modeManual').classList.toggle('active', mode === 'manual');
  document.getElementById('uploadSection').classList.toggle('hidden', mode === 'manual');
  document.getElementById('manualSection').classList.toggle('hidden', mode === 'upload');
}

// â”€â”€ TONE SELECTOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.tone-btn').forEach(b => {
  b.addEventListener('click', () => {
    document.querySelectorAll('.tone-btn').forEach(x => x.classList.remove('active'));
    b.classList.add('active');
  });
});

document.getElementById('fatos').addEventListener('input', function(){
  document.getElementById('charsCount').textContent = this.value.length;
});

// â”€â”€ DRAG & DROP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function dragOver(e){ e.preventDefault(); document.getElementById('uploadZone').classList.add('drag'); }
function dragLeave(){ document.getElementById('uploadZone').classList.remove('drag'); }
function dropFile(e){ e.preventDefault(); dragLeave(); const f = e.dataTransfer.files[0]; if(f) handleFile(f); }

// â”€â”€ FILE HANDLING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function handleFile(file){
  if(!file) return;
  uploadedFile = file;
  extractedContent = '';
  extractedBase64 = '';
  extractedMediaType = '';

  const zone = document.getElementById('uploadZone');
  zone.classList.add('has-file');
  document.getElementById('uploadIcon').textContent = getFileIcon(file.name);
  document.getElementById('uploadTitle').textContent = file.name;
  document.getElementById('uploadSub').textContent = 'Arquivo selecionado â€” processando...';
  document.getElementById('uploadFileName').textContent = '';
  document.getElementById('uploadFileSize').textContent = formatFileSize(file.size);
  document.getElementById('uploadClear').style.display = 'inline-block';

  showProgress(true, 'Lendo arquivo...');

  const ext = file.name.split('.').pop().toLowerCase();

  try {
    if(ext === 'txt'){
      extractedContent = await readAsText(file);
      setProgress(100, 'Texto extraÃ­do com sucesso!');

    } else if(ext === 'docx' || ext === 'doc'){
      setProgress(30, 'Extraindo texto do Word...');
      const arrayBuffer = await readAsArrayBuffer(file);
      const result = await mammoth.extractRawText({ arrayBuffer });
      extractedContent = result.value;
      setProgress(100, 'Texto extraÃ­do com sucesso!');

    } else if(ext === 'pdf'){
      setProgress(20, 'Processando PDF...');
      // For PDFs: send as base64 to Claude's vision
      extractedBase64 = await readAsBase64(file);
      extractedMediaType = 'application/pdf';
      // Also try text extraction via FileReader as fallback label
      setProgress(100, 'PDF pronto para anÃ¡lise!');

    } else if(['jpg','jpeg','png','webp','gif'].includes(ext)){
      setProgress(20, 'Processando imagem...');
      extractedBase64 = await readAsBase64(file);
      extractedMediaType = file.type || 'image/jpeg';
      setProgress(100, 'Imagem pronta para anÃ¡lise!');

    } else {
      alert('Formato nÃ£o suportado. Use: PDF, DOCX, DOC, TXT, JPG, PNG.');
      clearFile(null);
      return;
    }

    // Show preview
    const previewEl = document.getElementById('extractedPreview');
    if(extractedContent){
      const preview = extractedContent.substring(0, 600) + (extractedContent.length > 600 ? '\n\n[... ' + (extractedContent.length - 600) + ' caracteres restantes]' : '');
      document.getElementById('extractedText').textContent = preview;
      document.getElementById('extractedChars').textContent = extractedContent.length.toLocaleString('pt-BR');
      previewEl.style.display = 'block';
    } else if(extractedBase64){
      document.getElementById('extractedText').textContent = 'ğŸ“ Arquivo visual carregado â€” serÃ¡ analisado diretamente pela IA.';
      document.getElementById('extractedChars').textContent = formatFileSize(file.size);
      previewEl.style.display = 'block';
    }

    document.getElementById('uploadSub').textContent = 'âœ“ Pronto para anÃ¡lise';

  } catch(err) {
    console.error('File read error:', err);
    alert('Erro ao ler o arquivo: ' + err.message + '\nTente converter para TXT ou cole o texto manualmente.');
    clearFile(null);
  } finally {
    setTimeout(() => showProgress(false), 1200);
  }
}

function showProgress(show, text=''){
  const p = document.getElementById('uploadProgress');
  p.style.display = show ? 'block' : 'none';
  if(text) document.getElementById('progressText').textContent = text;
}
function setProgress(pct, text){
  document.getElementById('progressFill').style.width = pct + '%';
  if(text) document.getElementById('progressText').textContent = text;
}

function clearFile(e){
  if(e){ e.stopPropagation(); }
  uploadedFile = null;
  extractedContent = '';
  extractedBase64 = '';
  extractedMediaType = '';
  document.getElementById('fileInput').value = '';
  const zone = document.getElementById('uploadZone');
  zone.classList.remove('has-file','drag');
  document.getElementById('uploadIcon').textContent = 'ğŸ“„';
  document.getElementById('uploadTitle').textContent = 'Arraste ou clique para anexar';
  document.getElementById('uploadSub').textContent = 'Contrato, PetiÃ§Ã£o, SentenÃ§a, NotificaÃ§Ã£o, Laudo...';
  document.getElementById('uploadFileName').textContent = '';
  document.getElementById('uploadFileSize').textContent = '';
  document.getElementById('uploadClear').style.display = 'none';
  document.getElementById('extractedPreview').style.display = 'none';
  showProgress(false);
}

function getFileIcon(name){
  const ext = name.split('.').pop().toLowerCase();
  if(ext === 'pdf') return 'ğŸ“•';
  if(['doc','docx'].includes(ext)) return 'ğŸ“˜';
  if(['jpg','jpeg','png','webp'].includes(ext)) return 'ğŸ–¼ï¸';
  return 'ğŸ“„';
}
function formatFileSize(bytes){
  if(bytes < 1024) return bytes + ' B';
  if(bytes < 1048576) return (bytes/1024).toFixed(1) + ' KB';
  return (bytes/1048576).toFixed(1) + ' MB';
}

// â”€â”€ FILE READERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function readAsText(file){ return new Promise((res,rej) => { const r=new FileReader(); r.onload=e=>res(e.target.result); r.onerror=()=>rej(new Error('Falha ao ler texto')); r.readAsText(file,'UTF-8'); }); }
function readAsArrayBuffer(file){ return new Promise((res,rej) => { const r=new FileReader(); r.onload=e=>res(e.target.result); r.onerror=()=>rej(new Error('Falha ao ler arquivo')); r.readAsArrayBuffer(file); }); }
function readAsBase64(file){ return new Promise((res,rej) => { const r=new FileReader(); r.onload=e=>{ const b64=e.target.result.split(',')[1]; res(b64); }; r.onerror=()=>rej(new Error('Falha ao converter')); r.readAsDataURL(file); }); }

// â”€â”€ BUILD MESSAGES FOR API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildMessages(d){
  const tomDir = {
    imparcial:   'ForneÃ§a anÃ¡lise rigorosamente imparcial, apontando pontos fortes e fracos de ambos os polos.',
    favoravel:   'Analise com foco nos melhores argumentos disponÃ­veis para o polo ativo (autor/reclamante).',
    defensivo:   'Analise com foco na defesa do polo passivo (rÃ©u/reclamado), identificando fragilidades nos pedidos.',
    estrategico: 'ForneÃ§a anÃ¡lise estratÃ©gica: oportunidades de acordo vs litÃ­gio, riscos, tÃ¡ticas processuais.'
  };

  const rules = `REGRAS ABSOLUTAS:
1. NUNCA invente nÃºmeros de processos, acÃ³rdÃ£os ou ementas especÃ­ficas
2. NUNCA fabrique percentuais sem base nos dados
3. Para jurisprudÃªncia: cite entendimento geral consolidado ("O STJ tem entendido que..." / "SÃºmula X do TST estabelece...") â€” apenas se realmente existir
4. Se nÃ£o souber algo ou dados forem insuficientes, diga claramente
5. Seja HONESTO sobre incertezas â€” mais valioso que resposta inventada`;

  const structure = `ESTRUTURA OBRIGATÃ“RIA (siga exatamente):

## 1. PROBABILIDADE DE ÃŠXITO
**Probabilidade Global: [X]%**
ClassificaÃ§Ã£o: [ALTA (70-100%) / MÃ‰DIA (40-69%) / BAIXA (0-39%)]
Justificativa: [3-4 frases baseadas nos dados concretos]
Breakdown por pedido/tema: [lista com % por pedido, se aplicÃ¡vel]

## 2. IDENTIFICAÃ‡ÃƒO DO DOCUMENTO / CASO
[Identifique o tipo de documento, partes envolvidas, objeto, datas relevantes e qualquer informaÃ§Ã£o estrutural importante extraÃ­da]

## 3. PONTOS FORTES
[MÃ­nimo 4 pontos com fundamentaÃ§Ã£o jurÃ­dica. Cite artigos de lei REAIS. Entendimentos gerais sem inventar nÃºmeros]

## 4. PONTOS FRACOS E RISCOS
[MÃ­nimo 3 riscos com fundamentaÃ§Ã£o. Seja honesto mesmo se o tom for "favorÃ¡vel"]

## 5. FUNDAMENTOS JURÃDICOS E JURISPRUDÃŠNCIA
[Artigos de lei aplicÃ¡veis. Entendimentos gerais consolidados. Se existir sÃºmula real relevante, cite. NÃ£o invente acÃ³rdÃ£os]

## 6. ESTIMATIVA DE VALORES
[Faixas estimadas se aplicÃ¡vel. Se dados insuficientes, diga claramente]

## 7. ESBOÃ‡O DA PEÃ‡A / ESTRATÃ‰GIA PROCESSUAL
[EsboÃ§o da peÃ§a processual adequada OU anÃ¡lise estratÃ©gica detalhada conforme o tipo de documento analisado]

## 8. RECOMENDAÃ‡Ã•ES FINAIS
[PrÃ³ximos passos prÃ¡ticos, provas a produzir, prazo atenÃ§Ã£o, recomendaÃ§Ã£o acordo vs litÃ­gio]

Terminologia jurÃ­dica brasileira. TÃ©cnico, direto, fundamentado.`;

  const tone = `Tom da anÃ¡lise: ${tomDir[d.tom]}`;
  const date = `Data: ${d.data}`;

  // UPLOAD MODE
  if(currentMode === 'upload'){
    const extra = d.extraContext ? `\n\nInstruÃ§Ãµes adicionais do usuÃ¡rio:\n${d.extraContext}` : '';

    if(extractedBase64 && extractedMediaType){
      // Vision mode: PDF or image
      const isImage = extractedMediaType.startsWith('image/');
      const fileDesc = isImage ? 'imagem' : 'PDF';
      const content = [
        {
          type: extractedMediaType === 'application/pdf' ? 'document' : 'image',
          source: {
            type: 'base64',
            media_type: extractedMediaType,
            data: extractedBase64
          }
        },
        {
          type: 'text',
          text: `VocÃª Ã© um jurista brasileiro sÃªnior com 20+ anos de experiÃªncia. Analise este ${fileDesc} jurÃ­dico e realize uma ANÃLISE JURÃDICA COMPLETA.

${rules}

${tone}
${date}
${extra}

${structure}`
        }
      ];
      return [{ role: 'user', content }];

    } else if(extractedContent){
      // Text mode: DOCX or TXT
      const maxChars = 12000;
      const docText = extractedContent.length > maxChars
        ? extractedContent.substring(0, maxChars) + '\n\n[Documento truncado â€” anÃ¡lise baseada nos primeiros ' + maxChars + ' caracteres]'
        : extractedContent;

      const prompt = `VocÃª Ã© um jurista brasileiro sÃªnior com 20+ anos de experiÃªncia. Analise o documento jurÃ­dico abaixo e realize uma ANÃLISE JURÃDICA COMPLETA.

${rules}

${tone}
${date}
${extra}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
CONTEÃšDO DO DOCUMENTO ANEXADO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
${docText}
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

${structure}`;
      return [{ role: 'user', content: prompt }];

    } else {
      throw new Error('Nenhum documento carregado.');
    }
  }

  // MANUAL MODE
  const prompt = `VocÃª Ã© um jurista brasileiro sÃªnior com 20+ anos de experiÃªncia. Realize uma ANÃLISE JURÃDICA COMPLETA do caso a seguir.

${rules}

DADOS DO PROCESSO:
Ãrea: ${d.area || 'NÃ£o informado'}
Tipo de AÃ§Ã£o: ${d.tipo || 'NÃ£o informado'}
Polo Ativo: ${d.autor || 'NÃ£o informado'}
Polo Passivo: ${d.reu || 'NÃ£o informado'}
Pedidos: ${d.pedidos || 'NÃ£o informado'}
Tribunal: ${d.tribunal || 'NÃ£o informado'}
Valor da Causa: ${d.valor ? 'R$ '+d.valor : 'NÃ£o informado'}
Data: ${d.data}

${tone}

FATOS, PROVAS E ARGUMENTOS:
${d.fatos || '(NÃ£o informado)'}

${structure}`;
  return [{ role: 'user', content: prompt }];
}

// â”€â”€ FORM DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getFormData(){
  return {
    area:         document.getElementById('areaDir').value,
    tipo:         document.getElementById('tipoAcao').value.trim(),
    autor:        document.getElementById('autor').value.trim(),
    reu:          document.getElementById('reu').value.trim(),
    pedidos:      document.getElementById('pedidos').value.trim(),
    tribunal:     document.getElementById('tribunal').value,
    valor:        document.getElementById('valorCausa').value.trim(),
    tom:          document.querySelector('.tone-btn.active').dataset.tone,
    fatos:        document.getElementById('fatos').value.trim(),
    extraContext: document.getElementById('extraContext').value.trim(),
    data:         new Date().toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit',year:'numeric'})
  };
}

// â”€â”€ EXECUTAR ANÃLISE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function executarAnalise(){
  const d = getFormData();

  // Validation
  if(currentMode === 'upload'){
    if(!extractedContent && !extractedBase64){
      alert('ğŸ“ FaÃ§a upload de um documento para analisar.'); return;
    }
  } else {
    if(!d.area){ alert('âš– Selecione a Ãrea do Direito.'); return; }
    if(d.fatos.length < 80){ alert('âš– Descreva os fatos do caso (mÃ­nimo 80 caracteres).'); return; }
  }

  document.getElementById('inputCard').style.display = 'none';
  document.getElementById('loading').classList.add('visible');
  document.getElementById('resultCard').classList.remove('visible');

  const steps = [
    'Lendo documento...',
    'Identificando partes e objeto...',
    'Analisando fundamentos jurÃ­dicos...',
    'Calculando probabilidades...',
    'Buscando entendimentos consolidados...',
    'Elaborando esboÃ§o processual...',
    'Definindo estratÃ©gia...',
    'Compilando anÃ¡lise final...'
  ];
  let si = 0;
  const stepInterval = setInterval(() => {
    document.getElementById('loadingStep').textContent = steps[si % steps.length];
    si++;
  }, 1800);

  try {
    const messages = buildMessages(d);

    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 4000,
        system: 'VocÃª Ã© um jurista brasileiro sÃªnior especializado em anÃ¡lise processual. VocÃª NUNCA inventa dados, jurisprudÃªncias especÃ­ficas, nÃºmeros de processo ou percentuais sem base nos fatos. Quando nÃ£o tem certeza, diz claramente. Ã‰ preciso, honesto e tecnicamente rigoroso.',
        messages
      })
    });

    if(!response.ok){
      const err = await response.json().catch(() => ({}));
      throw new Error(err.error?.message || 'Erro HTTP ' + response.status);
    }

    const data = await response.json();
    const text = data.content?.map(c => c.text || '').join('') || '';
    clearInterval(stepInterval);
    analysisData = { formData: d, aiText: text, fileName: uploadedFile?.name || null };
    renderResult(d, text);

  } catch(e) {
    clearInterval(stepInterval);
    console.error(e);
    document.getElementById('loading').classList.remove('visible');
    document.getElementById('inputCard').style.display = 'block';
    alert('âš  Erro na anÃ¡lise: ' + e.message);
  }
}

// â”€â”€ RENDER RESULT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderResult(d, text){
  document.getElementById('loading').classList.remove('visible');
  document.getElementById('resultCard').classList.add('visible');

  // Extract probability
  const probMatch = text.match(/Probabilidade\s+Global[:\s*_]*(\d{1,3})\s*%/i)
    || text.match(/\*{0,2}(\d{1,3})\s*%\*{0,2}/);
  const prob = probMatch ? Math.min(98, Math.max(5, parseInt(probMatch[1]))) : null;

  if(prob !== null){
    const cls = prob >= 70 ? 'high' : prob >= 40 ? 'medium' : 'low';
    const clsLabel = prob >= 70 ? 'â¬† Alta Probabilidade' : prob >= 40 ? 'â—ˆ Probabilidade Moderada' : 'â¬‡ Baixa Probabilidade';
    const clsColor = prob >= 70 ? 'var(--green)' : prob >= 40 ? 'var(--yellow)' : 'var(--red)';
    document.getElementById('probValue').textContent = prob + '%';
    document.getElementById('probValue').className = 'prob-value ' + cls;
    document.getElementById('probClass').textContent = clsLabel;
    document.getElementById('probClass').style.color = clsColor;
    setTimeout(() => {
      const bar = document.getElementById('probBar');
      bar.className = 'prob-bar-fill ' + cls;
      bar.style.width = prob + '%';
    }, 300);

    const seed = prob;
    const scores = [
      { name: 'MÃ©rito JurÃ­dico',     val: cap(seed + rnd(12,-3)) },
      { name: 'Base ProbatÃ³ria',     val: cap(seed + rnd(10,-8)) },
      { name: 'JurisprudÃªncia',      val: cap(seed + rnd(15,-5)) },
      { name: 'PosiÃ§Ã£o do Tribunal', val: cap(seed + rnd(18,-10)) },
    ];
    let html = '<div style="margin-top:14px">';
    scores.forEach(s => {
      html += `<div class="score-row"><div class="score-name">${s.name}</div><div class="score-mini-bar"><div class="score-mini-fill" data-val="${s.val}"></div></div><div class="score-pct">${s.val}%</div></div>`;
    });
    document.getElementById('scoreBreakdown').innerHTML = html + '</div>';
    setTimeout(() => document.querySelectorAll('.score-mini-fill').forEach(el => { el.style.width = el.dataset.val + '%'; }), 500);
  } else {
    document.getElementById('probValue').textContent = 'N/D';
    document.getElementById('probClass').textContent = 'Dados insuficientes para estimar';
    document.getElementById('probClass').style.color = 'var(--muted)';
  }

  document.getElementById('aiFullText').textContent = text;
  window.scrollTo({ top: 0, behavior: 'smooth' });
}
function cap(v){ return Math.min(97, Math.max(8, Math.round(v))); }
function rnd(range, offset=0){ return offset + Math.round((Math.random()-.5)*range); }

// â”€â”€ PARSE SECTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseAISections(text){
  if(!text) return [{ title: 'ANÃLISE COMPLETA', content: text }];
  const sections = [];
  const parts = text.split(/(?=\n## \d+\.)/);
  parts.forEach(part => {
    const t = part.trim();
    if(!t) return;
    const lines = t.split('\n');
    const title = lines[0].replace(/^#+\s*\d*\.?\s*/,'').replace(/\*\*/g,'').trim();
    const content = lines.slice(1).join('\n').trim();
    if(title && content) sections.push({ title, content });
  });
  if(!sections.length) sections.push({ title: 'ANÃLISE COMPLETA', content: text });
  return sections;
}

// â”€â”€ DOWNLOAD WORD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function downloadWord(){
  if(!analysisData) return;
  const btn = document.getElementById('btnWord');
  const statusEl = document.getElementById('dlStatus');
  btn.disabled = true;
  btn.textContent = 'â³ Gerando...';
  statusEl.textContent = 'Preparando documento Word...';
  try {
    const {
      Document, Packer, Paragraph, TextRun, AlignmentType,
      BorderStyle, Header, Footer, PageNumber, WidthType
    } = docx;
    const d = analysisData.formData;
    const text = analysisData.aiText;
    const sections = parseAISections(text);

    const p = (txt, opts={}) => new Paragraph({
      children:[new TextRun({text:String(txt||''),font:'Arial',size:22,...opts})],
      spacing:{after:130}, alignment:AlignmentType.JUSTIFIED
    });
    const pc = (txt, opts={}) => new Paragraph({
      children:[new TextRun({text:String(txt||''),font:'Arial',size:22,...opts})],
      spacing:{after:110}, alignment:AlignmentType.CENTER
    });
    const h1 = (txt) => new Paragraph({
      children:[new TextRun({text:String(txt||''),font:'Arial',size:26,bold:true,color:'8B6914'})],
      spacing:{before:340,after:130},
      border:{bottom:{style:BorderStyle.SINGLE,size:4,color:'C9A84C',space:4}}
    });
    const sp = () => new Paragraph({children:[new TextRun({text:'',size:18})],spacing:{after:70}});

    // COVER
    const cover = [
      sp(),sp(),sp(),sp(),
      pc('V9 POWER EDITION',{size:52,bold:true,color:'C9A84C'}),
      pc('ANÃLISE JURÃDICA COMPLETA',{size:28,bold:true,color:'8B6914'}),
      pc('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”',{size:18,color:'C9A84C'}),
      sp(),
    ];
    if(analysisData.fileName) cover.push(pc('Documento: ' + analysisData.fileName, {size:21}));
    const fields = [
      ['Ãrea do Direito', d.area],['Tipo de AÃ§Ã£o', d.tipo],['Polo Ativo', d.autor],
      ['Polo Passivo', d.reu],['Tribunal', d.tribunal],['Valor da Causa', d.valor?'R$ '+d.valor:''],['Data', d.data]
    ].filter(([,v])=>v);
    fields.forEach(([k,v]) => cover.push(pc(`${k}: ${v}`,{size:21})));
    cover.push(sp(),pc('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”',{size:18,color:'C9A84C'}),sp(),sp());
    cover.push(pc('Gerado por InteligÃªncia Artificial Â· V9 Power Edition',{size:17,italics:true,color:'888888'}));
    cover.push(pc('AnÃ¡lise baseada exclusivamente nos dados fornecidos.',{size:17,italics:true,color:'888888'}));
    cover.push(pc('NÃƒO SUBSTITUI orientaÃ§Ã£o jurÃ­dica de advogado habilitado.',{size:17,italics:true,color:'888888'}));

    // ANALYSIS
    const analysis = [];
    if(analysisData.fileName){ analysis.push(h1('DOCUMENTO ANALISADO')); analysis.push(p(analysisData.fileName,{bold:true})); analysis.push(sp()); }
    if(fields.length > 0){
      analysis.push(h1('DADOS DO PROCESSO'));
      fields.forEach(([k,v]) => analysis.push(p(`${k}: ${v}`)));
      analysis.push(sp());
    }

    sections.forEach(sec => {
      analysis.push(h1(sec.title));
      sec.content.split('\n').forEach(line => {
        const clean = line.replace(/\*\*/g,'').replace(/^#+\s*/,'').trim();
        if(!clean){ analysis.push(sp()); return; }
        const bold = /^\d+\.\s/.test(line.trim()) || line.trim().startsWith('**');
        const indent = /^[-â€¢]\s/.test(line.trim());
        const para = new Paragraph({
          children:[new TextRun({text:clean.replace(/^[-â€¢]\s*/,''),font:'Arial',size:22,...(bold?{bold:true}:{})})],
          spacing:{after:110},
          alignment:AlignmentType.JUSTIFIED,
          ...(indent?{indent:{left:320}}:{})
        });
        analysis.push(para);
      });
      analysis.push(sp());
    });
    analysis.push(sp());
    analysis.push(pc('V9 Power Edition Â· ' + d.data + ' Â· AnÃ¡lise por IA',{size:15,italics:true,color:'888888'}));

    const wordDoc = new Document({
      styles:{default:{document:{run:{font:'Arial',size:22}}}},
      sections:[
        {
          properties:{page:{size:{width:11906,height:16838},margin:{top:1440,right:1440,bottom:1440,left:1440}}},
          children: cover
        },
        {
          properties:{page:{size:{width:11906,height:16838},margin:{top:1440,right:1700,bottom:1440,left:1700}}},
          headers:{default: new Header({children:[new Paragraph({
            children:[new TextRun({text:'V9 POWER EDITION  Â·  ANÃLISE JURÃDICA',font:'Arial',size:15,color:'C9A84C',bold:true})],
            alignment:AlignmentType.CENTER,
            border:{bottom:{style:BorderStyle.SINGLE,size:3,color:'C9A84C',space:4}}
          })]})},
          footers:{default: new Footer({children:[new Paragraph({
            children:[
              new TextRun({text:(d.area||'AnÃ¡lise JurÃ­dica')+'  Â·  PÃ¡g. ',font:'Arial',size:15,color:'888888'}),
              new TextRun({children:[PageNumber.CURRENT],font:'Arial',size:15,color:'888888'}),
            ],alignment:AlignmentType.CENTER
          })]})},
          children: analysis
        }
      ]
    });

    const buffer = await Packer.toBuffer(wordDoc);
    const blob = new Blob([buffer],{type:'application/vnd.openxmlformats-officedocument.wordprocessingml.document'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `V9_Analise_${(d.tipo||d.area||'Juridica').replace(/\s+/g,'_').replace(/[^\w_]/g,'')}_${d.data.replace(/\//g,'-')}.docx`;
    document.body.appendChild(a); a.click();
    setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 1000);
    statusEl.textContent = 'âœ“ Word gerado com sucesso!';
  } catch(e){
    console.error(e);
    statusEl.textContent = 'âœ— Erro: ' + e.message;
  }
  btn.disabled = false;
  btn.innerHTML = `<svg width="17" height="17" viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-1 1.5L18.5 9H13V3.5z"/></svg> Baixar Word (.docx)`;
}

// â”€â”€ DOWNLOAD PDF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function downloadPDF(){
  if(!analysisData) return;
  const btn = document.getElementById('btnPdf');
  const statusEl = document.getElementById('dlStatus');
  btn.disabled = true;
  btn.textContent = 'â³ Gerando...';
  statusEl.textContent = 'Preparando PDF...';
  try {
    const {jsPDF} = jspdf;
    const doc = new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
    const d = analysisData.formData;
    const text = analysisData.aiText;
    const pw=210,ph=297,ml=18,mr=18,mb=18;
    const cw = pw-ml-mr;
    let y = 20;

    const GOLD=[201,168,76],GOLD_D=[139,105,20],GRAY=[110,100,85],LIGHT=[200,190,170],BG=[10,10,10];

    function newPage(){
      doc.addPage();
      doc.setFillColor(...BG); doc.rect(0,0,pw,ph,'F');
      doc.setFillColor(22,20,14); doc.rect(0,0,pw,11,'F');
      doc.setFont('helvetica','bold'); doc.setFontSize(6.5); doc.setTextColor(...GOLD);
      doc.text('V9 POWER EDITION  Â·  ANÃLISE JURÃDICA', pw/2, 7.5, {align:'center'});
      doc.setDrawColor(...GOLD_D); doc.setLineWidth(0.25); doc.line(ml,11,pw-mr,11);
      y = 19;
    }
    function check(need=8){ if(y+need > ph-mb-8) newPage(); }
    function secHeader(title){
      check(14);
      doc.setFillColor(24,22,12); doc.rect(ml-2,y-5,cw+4,9,'F');
      doc.setDrawColor(...GOLD); doc.setLineWidth(0.3); doc.line(ml-2,y+4,ml+cw+2,y+4);
      doc.setFont('helvetica','bold'); doc.setFontSize(9); doc.setTextColor(...GOLD);
      doc.text(title.toUpperCase().substring(0,70), ml, y);
      y += 9;
    }
    function bodyLine(txt, bold=false, indent=0){
      if(!txt||!txt.trim()) return;
      doc.setFont('helvetica',bold?'bold':'normal'); doc.setFontSize(7.8); doc.setTextColor(...LIGHT);
      const lines = doc.splitTextToSize(txt.trim(), cw-indent);
      lines.forEach(line => { check(5.5); doc.text(line, ml+indent, y); y+=5; });
    }

    // COVER
    doc.setFillColor(...BG); doc.rect(0,0,pw,ph,'F');
    doc.setDrawColor(...GOLD_D); doc.setLineWidth(0.3); doc.line(ml,14,pw-mr,14);
    doc.setDrawColor(...GOLD); doc.setLineWidth(0.6); doc.line(ml,16,pw-mr,16);
    doc.setFont('helvetica','bold'); doc.setFontSize(28); doc.setTextColor(...GOLD);
    doc.text('V9 POWER EDITION', pw/2, 62, {align:'center'});
    doc.setFontSize(13); doc.setTextColor(...GOLD_D);
    doc.text('ANÃLISE JURÃDICA COMPLETA', pw/2, 72, {align:'center'});
    doc.setFontSize(7.5); doc.setTextColor(...GRAY);
    doc.text('â—ˆ  ZERO ALUCINAÃ‡ÃƒO  Â·  BASEADA NOS DADOS FORNECIDOS  â—ˆ', pw/2, 79, {align:'center'});
    doc.setDrawColor(...GOLD_D); doc.setLineWidth(0.3); doc.line(30,85,pw-30,85);
    let cy = 97;
    if(analysisData.fileName){
      doc.setFont('helvetica','bold'); doc.setFontSize(8); doc.setTextColor(...GOLD_D);
      doc.text('Documento:', ml+8, cy);
      doc.setFont('helvetica','normal'); doc.setTextColor(...LIGHT);
      const fn = doc.splitTextToSize(analysisData.fileName, cw-60);
      doc.text(fn[0]||'', ml+55, cy); cy+=8;
    }
    const fields = [['Ãrea',d.area],['Tipo',d.tipo],['Autor',d.autor],['RÃ©u',d.reu],['Tribunal',d.tribunal],['Valor',d.valor?'R$ '+d.valor:''],['Data',d.data]].filter(([,v])=>v);
    fields.forEach(([k,v]) => {
      doc.setFont('helvetica','bold'); doc.setFontSize(7.8); doc.setTextColor(...GOLD_D);
      doc.text(k+':', ml+8, cy);
      doc.setFont('helvetica','normal'); doc.setTextColor(...LIGHT);
      doc.text((v||'').substring(0,55), ml+40, cy); cy+=7;
    });
    doc.setDrawColor(...GOLD_D); doc.setLineWidth(0.3); doc.line(30,cy+3,pw-30,cy+3);
    doc.setFont('helvetica','italic'); doc.setFontSize(6.8); doc.setTextColor(...GRAY);
    doc.text('Documento gerado por InteligÃªncia Artificial Â· V9 Power Edition', pw/2, ph-28, {align:'center'});
    doc.text('AnÃ¡lise baseada exclusivamente nos dados fornecidos.', pw/2, ph-22, {align:'center'});
    doc.text('NÃƒO SUBSTITUI orientaÃ§Ã£o jurÃ­dica de advogado habilitado.', pw/2, ph-16, {align:'center'});

    // ANALYSIS
    newPage();
    secHeader('Dados do Processo');
    if(analysisData.fileName) bodyLine('Documento: ' + analysisData.fileName, true);
    fields.forEach(([k,v]) => bodyLine(`${k}: ${v}`));
    y += 3;

    const sections = parseAISections(text);
    sections.forEach(sec => {
      secHeader(sec.title);
      sec.content.split('\n').forEach(line => {
        const clean = line.replace(/\*\*/g,'').replace(/^#+\s*/,'').trim();
        if(!clean){ y+=1.5; return; }
        const bold = /^\d+\.\s/.test(line.trim());
        const indent = /^[-â€¢]\s/.test(line.trim()) ? 4 : 0;
        bodyLine(indent ? 'â€¢ '+clean.replace(/^[-â€¢]\s*/,'') : clean, bold, indent);
      });
      y += 3;
    });

    const total = doc.internal.getNumberOfPages();
    for(let i=2;i<=total;i++){
      doc.setPage(i);
      doc.setFont('helvetica','normal'); doc.setFontSize(6.5); doc.setTextColor(...GRAY);
      doc.text(`PÃ¡gina ${i} de ${total}  Â·  V9 Power  Â·  ${d.data}`, pw/2, ph-7, {align:'center'});
    }

    const fname = `V9_Analise_${(d.tipo||d.area||'Juridica').replace(/\s+/g,'_').replace(/[^\w_]/g,'')}_${d.data.replace(/\//g,'-')}.pdf`;
    doc.save(fname);
    statusEl.textContent = 'âœ“ PDF gerado com sucesso!';
  } catch(e){
    console.error(e);
    statusEl.textContent = 'âœ— Erro: ' + e.message;
  }
  btn.disabled = false;
  btn.innerHTML = `<svg width="17" height="17" viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-1 1.5L18.5 9H13V3.5z"/></svg> Baixar PDF`;
}

// â”€â”€ RESET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resetForm(){
  document.getElementById('resultCard').classList.remove('visible');
  document.getElementById('inputCard').style.display = 'block';
  document.getElementById('dlStatus').textContent = '';
  analysisData = null;
  clearFile(null);
  setMode('upload');
  window.scrollTo({top:0,behavior:'smooth'});
}
</script>
</body>
</html>
