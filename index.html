<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>V9 POWER EDITION â€“ AnÃ¡lise JurÃ­dica</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Rajdhani:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.5.0/docx.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
<style>
:root{
  --gold:#c9a84c;--gold-light:#e8c96b;--gold-dark:#8b6914;
  --bg:#080808;--card:#101010;--card2:#161616;--border:#252525;
  --text:#e0d5c0;--muted:#6b6050;--green:#2ecc71;--red:#e74c3c;--yellow:#f39c12;
}
*{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{background:var(--bg);color:var(--text);font-family:'Rajdhani',sans-serif;font-size:15px;line-height:1.6;min-height:100vh;overflow-x:hidden}
body::after{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.035'/%3E%3C/svg%3E");pointer-events:none;z-index:9999;opacity:.4}
body::before{content:'';position:fixed;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--gold-dark) 20%,var(--gold-light) 50%,var(--gold-dark) 80%,transparent);z-index:100}

header{text-align:center;padding:44px 20px 22px}
header::after{content:'';display:block;width:300px;height:1px;background:linear-gradient(90deg,transparent,var(--gold-dark),var(--gold),var(--gold-dark),transparent);margin:12px auto 0}
.logo-text{font-family:'Cinzel',serif;font-size:clamp(1.5rem,5vw,2.6rem);letter-spacing:.4em;background:linear-gradient(135deg,var(--gold-dark),var(--gold-light),var(--gold),var(--gold-dark));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;display:inline-block}
.logo-sub{font-size:.63rem;letter-spacing:.38em;color:var(--muted);margin-top:6px;text-transform:uppercase}
.logo-badge{display:inline-block;font-size:.52rem;letter-spacing:.22em;color:var(--gold-dark);border:1px solid var(--gold-dark);padding:2px 11px;margin-top:7px;border-radius:2px;text-transform:uppercase}

.container{max-width:940px;margin:0 auto;padding:26px 18px 80px;position:relative;z-index:1}

.card{background:var(--card);border:1px solid var(--border);border-radius:6px;padding:26px;margin-bottom:18px;position:relative;overflow:hidden}
.card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--gold-dark),var(--gold),var(--gold-dark),transparent)}

.slabel{font-size:.58rem;letter-spacing:.33em;color:var(--gold);text-transform:uppercase;margin-bottom:16px;display:flex;align-items:center;gap:10px;font-weight:700}
.slabel::after{content:'';flex:1;height:1px;background:linear-gradient(90deg,var(--border),transparent)}

/* â”€â”€ API KEY CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.apikey-wrap{margin-bottom:6px}
.apikey-help{font-size:.68rem;color:var(--muted);line-height:1.65;margin-bottom:10px}
.apikey-help a{color:var(--gold-dark);text-decoration:none}
.apikey-help a:hover{color:var(--gold)}
.apikey-row{display:flex;gap:8px}
.apikey-input{flex:1;background:var(--card2);border:1px solid var(--border);border-radius:3px;color:var(--text);font-family:'Rajdhani',sans-serif;font-size:14px;padding:11px 14px;outline:none;transition:border-color .2s;letter-spacing:.04em}
.apikey-input:focus{border-color:var(--gold-dark);box-shadow:0 0 0 2px rgba(139,105,20,.1)}
.apikey-eye{background:var(--card2);border:1px solid var(--border);border-radius:3px;color:var(--muted);font-size:17px;padding:0 13px;cursor:pointer;transition:all .2s;flex-shrink:0}
.apikey-eye:hover{border-color:var(--gold-dark)}
.apikey-status{font-size:.62rem;letter-spacing:.12em;margin-top:7px;text-transform:uppercase;min-height:18px}
.apikey-status.ok{color:var(--green)}.apikey-status.err{color:var(--red)}
.apikey-save-note{font-size:.6rem;color:var(--muted);margin-top:5px;letter-spacing:.06em}

/* â”€â”€ FIELDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
label{display:block;font-size:.6rem;letter-spacing:.2em;color:var(--muted);text-transform:uppercase;margin-bottom:4px;margin-top:15px}
label:first-of-type{margin-top:0}
input[type=text],select,textarea{width:100%;background:var(--card2);border:1px solid var(--border);border-radius:3px;color:var(--text);font-family:'Rajdhani',sans-serif;font-size:14px;padding:10px 13px;outline:none;transition:border-color .2s,box-shadow .2s;letter-spacing:.03em}
input[type=text]:focus,select:focus,textarea:focus{border-color:var(--gold-dark);box-shadow:0 0 0 2px rgba(139,105,20,.1)}
select option{background:#161616}
textarea{resize:vertical;min-height:125px}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
@media(max-width:600px){.grid2{grid-template-columns:1fr}}

/* â”€â”€ MODE TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.mode-toggle{display:flex;border:1px solid var(--border);border-radius:4px;overflow:hidden;margin-bottom:16px}
.mode-btn{flex:1;padding:11px;background:var(--card2);border:none;color:var(--muted);font-family:'Rajdhani',sans-serif;font-size:.64rem;letter-spacing:.18em;cursor:pointer;transition:all .2s;text-transform:uppercase;font-weight:600}
.mode-btn:first-child{border-right:1px solid var(--border)}
.mode-btn.active{background:linear-gradient(135deg,var(--gold-dark),rgba(201,168,76,.45));color:var(--gold-light)}

/* â”€â”€ UPLOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.upload-zone{border:2px dashed var(--border);border-radius:5px;padding:28px 18px;text-align:center;cursor:pointer;transition:all .25s;background:var(--card2);display:block;width:100%;box-sizing:border-box}
.upload-zone:hover,.upload-zone.drag{border-color:var(--gold-dark);background:rgba(139,105,20,.06)}
.upload-zone.has-file{border-color:var(--gold);border-style:solid;background:rgba(201,168,76,.04)}
.upload-icon{font-size:2.1rem;display:block;margin-bottom:8px;opacity:.65}
.upload-title{font-size:.8rem;letter-spacing:.13em;color:var(--text);font-weight:600;text-transform:uppercase}
.upload-sub{font-size:.67rem;color:var(--muted);margin-top:4px}
.upload-types{font-size:.6rem;color:var(--gold-dark);margin-top:7px;letter-spacing:.1em;text-transform:uppercase}
#fileInput{display:none}
.upload-clear{display:none;background:rgba(231,76,60,.12);border:1px solid rgba(231,76,60,.25);color:#e09090;font-size:.6rem;letter-spacing:.12em;padding:4px 12px;border-radius:3px;cursor:pointer;margin-top:9px;text-transform:uppercase;transition:all .2s}
.upload-clear:hover{background:rgba(231,76,60,.22)}
.prog{display:none;margin-top:10px}
.prog-bar{height:3px;background:var(--border);border-radius:2px;overflow:hidden}
.prog-fill{height:100%;background:linear-gradient(90deg,var(--gold-dark),var(--gold));width:0%;transition:width .3s}
.prog-txt{font-size:.6rem;color:var(--muted);margin-top:4px}
.extracted-box{display:none;background:var(--card2);border:1px solid var(--border);border-radius:4px;padding:12px;margin-top:11px}
.extracted-lbl{font-size:.58rem;letter-spacing:.2em;color:var(--gold-dark);text-transform:uppercase;margin-bottom:6px}
.extracted-txt{font-size:12px;color:var(--muted);max-height:95px;overflow-y:auto;white-space:pre-wrap;line-height:1.55}
.extracted-info{font-size:.58rem;color:var(--muted);margin-top:5px}

/* â”€â”€ TONE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tone-group{display:flex;gap:7px;flex-wrap:wrap}
.tone-btn{background:var(--card2);border:1px solid var(--border);border-radius:3px;color:var(--muted);font-family:'Rajdhani',sans-serif;font-size:.6rem;letter-spacing:.17em;padding:7px 12px;cursor:pointer;text-transform:uppercase;transition:all .2s}
.tone-btn:hover{border-color:var(--gold-dark);color:var(--gold-dark)}
.tone-btn.active{background:linear-gradient(135deg,var(--gold-dark),var(--gold));border-color:var(--gold);color:#000;font-weight:700}

/* â”€â”€ EXECUTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn-exec{width:100%;padding:17px;background:linear-gradient(135deg,#6b4f0a,var(--gold),#6b4f0a);border:none;border-radius:4px;font-family:'Cinzel',serif;font-size:.76rem;letter-spacing:.28em;color:#000;font-weight:700;cursor:pointer;transition:all .3s;text-transform:uppercase;margin-top:16px;position:relative;overflow:hidden}
.btn-exec::after{content:'';position:absolute;inset:0;background:linear-gradient(135deg,transparent,rgba(255,255,255,.1),transparent);transform:translateX(-100%);transition:.5s}
.btn-exec:hover::after{transform:translateX(100%)}
.btn-exec:hover{transform:translateY(-1px);box-shadow:0 10px 35px rgba(201,168,76,.2)}
.btn-exec:disabled{opacity:.4;cursor:not-allowed;transform:none;box-shadow:none}

/* â”€â”€ LOADING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.loading{display:none;text-align:center;padding:62px 20px}
.loading.visible{display:block}
.spinner{width:50px;height:50px;margin:0 auto 16px;position:relative}
.spinner::before,.spinner::after{content:'';position:absolute;inset:0;border-radius:50%;border:2px solid transparent}
.spinner::before{border-top-color:var(--gold);animation:spin .9s linear infinite}
.spinner::after{border-bottom-color:var(--gold-dark);animation:spin 1.5s linear infinite reverse;inset:7px}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-title{font-size:.66rem;letter-spacing:.28em;color:var(--muted);text-transform:uppercase}
.loading-step{font-size:.6rem;letter-spacing:.15em;color:var(--gold-dark);margin-top:8px;min-height:20px}

/* â”€â”€ RESULT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.result-card{display:none}
.result-card.visible{display:block;animation:fadeUp .5s ease}
@keyframes fadeUp{from{opacity:0;transform:translateY(18px)}to{opacity:1;transform:translateY(0)}}

.prob-grid{display:grid;grid-template-columns:135px 1fr;gap:20px;align-items:start}
@media(max-width:480px){.prob-grid{grid-template-columns:1fr}}
.prob-value{font-family:'Cinzel',serif;font-size:3.6rem;font-weight:900;line-height:1}
.prob-value.high{color:var(--green)}.prob-value.medium{color:var(--yellow)}.prob-value.low{color:var(--red)}
.prob-class{font-size:.68rem;letter-spacing:.16em;text-transform:uppercase;margin-top:4px;font-weight:700}
.prob-bar-track{height:5px;background:var(--card2);border-radius:3px;overflow:hidden;border:1px solid var(--border);margin:13px 0 3px}
.prob-bar-fill{height:100%;border-radius:3px;transition:width 1.2s cubic-bezier(.16,1,.3,1);width:0%}
.prob-bar-fill.high{background:linear-gradient(90deg,#1e8449,var(--green))}.prob-bar-fill.medium{background:linear-gradient(90deg,#b7770d,var(--yellow))}.prob-bar-fill.low{background:linear-gradient(90deg,#922b21,var(--red))}
.score-row{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.score-name{font-size:.58rem;letter-spacing:.1em;color:var(--muted);text-transform:uppercase;width:155px;flex-shrink:0}
.score-mini-bar{flex:1;height:4px;background:var(--card2);border-radius:2px;overflow:hidden}
.score-mini-fill{height:100%;background:linear-gradient(90deg,var(--gold-dark),var(--gold-light));border-radius:2px;transition:width 1.1s ease;width:0%}
.score-pct{font-size:.66rem;color:var(--gold);width:32px;text-align:right;font-family:'Cinzel',serif}

.ai-text{font-size:13.5px;line-height:1.88;color:#a09880;white-space:pre-wrap;font-family:'Rajdhani',sans-serif}

.dl-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
@media(max-width:480px){.dl-grid{grid-template-columns:1fr}}
.btn-dl{width:100%;padding:14px;border:none;border-radius:4px;font-family:'Cinzel',serif;font-size:.66rem;letter-spacing:.17em;font-weight:700;cursor:pointer;transition:all .3s;text-transform:uppercase;display:flex;align-items:center;justify-content:center;gap:8px}
.btn-dl.word{background:linear-gradient(135deg,#0f2a52,#1a4a8a);color:#fff;border:1px solid #1a4a8a}
.btn-dl.pdf{background:linear-gradient(135deg,#4a0f0f,#8a1a1a);color:#fff;border:1px solid #8a1a1a}
.btn-dl:hover{transform:translateY(-2px);box-shadow:0 7px 22px rgba(0,0,0,.45)}
.btn-dl:disabled{opacity:.4;cursor:not-allowed;transform:none}
.dl-status{font-size:.61rem;letter-spacing:.1em;color:var(--muted);text-align:center;padding:7px 0 0;min-height:22px;text-transform:uppercase}

.btn-nova{width:100%;padding:12px;background:transparent;border:1px solid var(--border);border-radius:4px;font-family:'Rajdhani',sans-serif;font-size:.68rem;letter-spacing:.28em;color:var(--muted);cursor:pointer;text-transform:uppercase;transition:all .2s;margin-top:4px}
.btn-nova:hover{border-color:var(--gold-dark);color:var(--gold)}
.copy-prompt-card{background:linear-gradient(135deg,rgba(139,105,20,.08),rgba(201,168,76,.04));border:1px solid rgba(201,168,76,.25);border-radius:6px;padding:22px;margin-bottom:18px;position:relative}
.copy-prompt-card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--gold),transparent)}
.prompt-preview{background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:14px;font-size:12px;color:var(--muted);white-space:pre-wrap;max-height:220px;overflow-y:auto;line-height:1.7;font-family:'Rajdhani',sans-serif;margin:12px 0}
.btn-copy{width:100%;padding:15px;background:linear-gradient(135deg,rgba(201,168,76,.15),rgba(201,168,76,.08));border:1px solid var(--gold-dark);border-radius:4px;font-family:'Cinzel',serif;font-size:.72rem;letter-spacing:.22em;color:var(--gold-light);font-weight:700;cursor:pointer;transition:all .3s;text-transform:uppercase;display:flex;align-items:center;justify-content:center;gap:10px}
.btn-copy:hover{background:linear-gradient(135deg,rgba(201,168,76,.28),rgba(201,168,76,.14));border-color:var(--gold);transform:translateY(-1px);box-shadow:0 6px 20px rgba(201,168,76,.15)}
.btn-copy.copied{background:linear-gradient(135deg,rgba(46,204,113,.15),rgba(46,204,113,.08));border-color:var(--green);color:var(--green)}
.copy-hint{font-size:.62rem;color:var(--muted);text-align:center;margin-top:8px;letter-spacing:.08em}
.disc{background:rgba(201,168,76,.04);border:1px solid rgba(201,168,76,.1);border-radius:4px;padding:11px 14px;margin-bottom:16px;font-size:.69rem;color:var(--muted);line-height:1.65}
.disc strong{color:var(--gold-dark)}
.chars{font-size:.6rem;color:var(--muted);text-align:right;margin-top:4px}
.chars span{color:var(--gold-dark)}
.hidden{display:none!important}
</style>
</head>
<body>

<header>
  <div class="logo-text">V9 POWER EDITION</div>
  <div class="logo-sub">Engenharia JurÃ­dica Â· AnÃ¡lise por IA Â· Upload de Documentos</div>
  <div class="logo-badge">Zero AlucinaÃ§Ã£o Â· Word &amp; PDF</div>
</header>

<div class="container">

<!-- â”€â”€ CHAVE DE API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="card">
  <div class="slabel">ğŸ”‘ Chave de API</div>
  <div class="apikey-wrap">
    <div class="apikey-help">
      NecessÃ¡ria apenas uma vez â€” fica salva no seu navegador. Obtenha grÃ¡tis em
      <a href="https://aistudio.google.com/app/apikey" target="_blank">aistudio.google.com</a>
      â†’ Get API Key â†’ Create API key.
    </div>
    <div class="apikey-row">
      <input class="apikey-input" id="apiKeyInput" type="password"
        placeholder="AIza..." oninput="checkKey()" autocomplete="off" spellcheck="false"/>
      <button class="apikey-eye" id="apiKeyEye" onclick="toggleEye()">ğŸ‘</button>
    </div>
    <div class="apikey-status" id="apiKeyStatus"></div>
    <div class="apikey-save-note">ğŸ”’ Sua chave fica salva sÃ³ no seu navegador â€” nunca sai do seu dispositivo.</div>
  </div>
</div>

<!-- â”€â”€ AVISO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="disc">
  <strong>âš– V9 POWER:</strong> Anexe o documento ou preencha os dados. A IA
  <strong>NUNCA inventa dados</strong> â€” jurisprudÃªncias sÃ£o entendimentos gerais
  consolidados, nÃ£o nÃºmeros fabricados. NÃ£o substitui advogado.
</div>

<!-- â”€â”€ INPUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="card" id="inputCard">
  <div class="slabel">â—ˆ Modo de AnÃ¡lise</div>

  <div class="mode-toggle">
    <button class="mode-btn active" id="modeUploadBtn" onclick="setMode('upload')">ğŸ“ Anexar Documento</button>
    <button class="mode-btn" id="modeManualBtn" onclick="setMode('manual')">âœï¸ Digitar Dados</button>
  </div>

  <!-- UPLOAD -->
  <div id="uploadSection">
    <label class="upload-zone" id="uploadZone" for="fileInput"
      ondragover="dragOver(event)" ondragleave="dragLeave(event)" ondrop="dropFile(event)">
      <span class="upload-icon" id="uploadIcon">ğŸ“„</span>
      <div class="upload-title" id="uploadTitle">Arraste ou clique para anexar</div>
      <div class="upload-sub" id="uploadSub">Contrato, PetiÃ§Ã£o, SentenÃ§a, NotificaÃ§Ã£o, Laudo...</div>
      <div class="upload-types" id="uploadTypes">PDF Â· Word (.docx) Â· Imagem (JPG/PNG) Â· TXT</div>
      <button class="upload-clear" id="uploadClear" onclick="clearFile(event)" type="button">âœ• Remover</button>
    </label>
    <input type="file" id="fileInput" accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.webp"
      onchange="handleFile(this.files[0])">
    <div class="prog" id="prog">
      <div class="prog-bar"><div class="prog-fill" id="progFill"></div></div>
      <div class="prog-txt" id="progTxt"></div>
    </div>
    <div class="extracted-box" id="extractedBox">
      <div class="extracted-lbl">â—ˆ ConteÃºdo ExtraÃ­do</div>
      <div class="extracted-txt" id="extractedTxt"></div>
      <div class="extracted-info" id="extractedInfo"></div>
    </div>
    <label style="margin-top:15px">InstruÃ§Ãµes Adicionais <small style="color:var(--muted)">(opcional)</small></label>
    <textarea id="extraContext" style="min-height:70px"
      placeholder="Ex: Analise a clÃ¡usula de multa. Foco no risco para o credor..."></textarea>
  </div>

  <!-- MANUAL -->
  <div id="manualSection" class="hidden">
    <div class="grid2">
      <div>
        <label>Ãrea do Direito *</label>
        <select id="areaDir">
          <option value="">Selecione...</option>
          <option>Direito Trabalhista</option><option>Direito Civil</option>
          <option>Direito do Consumidor</option><option>Direito PrevidenciÃ¡rio</option>
          <option>Direito de FamÃ­lia</option><option>Direito TributÃ¡rio</option>
          <option>Direito Empresarial</option><option>Direito Penal</option>
          <option>Direito Administrativo</option><option>Direito Ambiental</option>
          <option>Direito BancÃ¡rio</option><option>Direito Digital</option>
        </select>
      </div>
      <div>
        <label>Tipo de AÃ§Ã£o / PeÃ§a</label>
        <input type="text" id="tipoAcao" placeholder="Ex: ReclamaÃ§Ã£o Trabalhista..."/>
      </div>
    </div>
    <div class="grid2">
      <div>
        <label>Polo Ativo (Autor)</label>
        <input type="text" id="autor" placeholder="Ex: Empregado, Consumidor..."/>
      </div>
      <div>
        <label>Polo Passivo (RÃ©u)</label>
        <input type="text" id="reu" placeholder="Ex: Empresa XYZ, Banco..."/>
      </div>
    </div>
    <label>Pedidos Principais</label>
    <input type="text" id="pedidos" placeholder="Ex: Horas extras, danos morais, FGTS..."/>
    <div class="grid2">
      <div>
        <label>Tribunal / InstÃ¢ncia</label>
        <select id="tribunal">
          <option value="">Selecione...</option>
          <option>1Âª InstÃ¢ncia â€“ Vara do Trabalho</option>
          <option>1Âª InstÃ¢ncia â€“ Vara CÃ­vel</option>
          <option>TRT (Tribunal Regional do Trabalho)</option>
          <option>TJ (Tribunal de JustiÃ§a Estadual)</option>
          <option>TST (Tribunal Superior do Trabalho)</option>
          <option>STJ (Superior Tribunal de JustiÃ§a)</option>
          <option>STF (Supremo Tribunal Federal)</option>
        </select>
      </div>
      <div>
        <label>Valor Est. da Causa (R$)</label>
        <input type="text" id="valorCausa" placeholder="Ex: 50.000,00"/>
      </div>
    </div>
    <label>Fatos, Provas e Argumentos *</label>
    <textarea id="fatos"
      placeholder="Descreva os fatos, provas disponÃ­veis, documentos, histÃ³rico do caso..."></textarea>
    <div class="chars"><span id="charsCount">0</span> caracteres</div>
  </div>

  <!-- TOM (sempre visÃ­vel) -->
  <label style="margin-top:18px">Tom da AnÃ¡lise</label>
  <div class="tone-group">
    <button class="tone-btn active" data-tone="imparcial">Imparcial</button>
    <button class="tone-btn" data-tone="favoravel">FavorÃ¡vel ao Autor</button>
    <button class="tone-btn" data-tone="defensivo">Defensivo ao RÃ©u</button>
    <button class="tone-btn" data-tone="estrategico">EstratÃ©gico</button>
  </div>

  <button class="btn-exec" id="btnExec" onclick="executar()">
    âš– EXECUTAR ANÃLISE JURÃDICA V9 POWER
  </button>
</div>

<!-- â”€â”€ LOADING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="loading" id="loading">
  <div class="spinner"></div>
  <p class="loading-title">Executando Engenharia V9 Power</p>
  <p class="loading-step" id="loadingStep">Inicializando anÃ¡lise...</p>
</div>

<!-- â”€â”€ RESULTADO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="result-card" id="resultCard">

  <div class="card">
    <div class="slabel">â—ˆ Probabilidade de ÃŠxito</div>
    <div class="prob-grid">
      <div>
        <div style="font-size:.56rem;letter-spacing:.2em;color:var(--muted);text-transform:uppercase;margin-bottom:4px">Estimativa Global</div>
        <div class="prob-value" id="probValue">â€”</div>
        <div class="prob-class" id="probClass"></div>
      </div>
      <div style="padding-top:1px">
        <div class="prob-bar-track"><div class="prob-bar-fill" id="probBar"></div></div>
        <div id="scoreBreakdown"></div>
      </div>
    </div>
    <div style="margin-top:10px;font-size:.6rem;color:var(--muted);letter-spacing:.06em">
      * Estimativa analÃ­tica baseada nos dados fornecidos. NÃ£o garante resultado processual.
    </div>
  </div>

  <div class="card">
    <div class="slabel">â—ˆ AnÃ¡lise JurÃ­dica Completa</div>
    <div class="ai-text" id="aiText"></div>
  </div>

  <div class="card">
    <div class="slabel">â—ˆ Download do Documento</div>
    <p style="font-size:13px;color:var(--muted);margin-bottom:2px">
      Documento profissional com capa, anÃ¡lise completa, fundamentaÃ§Ã£o e estratÃ©gia.
    </p>
    <div class="dl-grid">
      <button class="btn-dl word" id="btnWord" onclick="dlWord()">ğŸ“„ Baixar Word (.docx)</button>
      <button class="btn-dl pdf"  id="btnPdf"  onclick="dlPDF()">ğŸ“• Baixar PDF</button>
    </div>
    <div class="dl-status" id="dlStatus"></div>
  </div>

  <!-- â”€â”€ COPIAR PROMPT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="copy-prompt-card" id="copyPromptCard">
    <div class="slabel">ğŸ“‹ Prompt Pronto para Copiar</div>
    <p style="font-size:13px;color:var(--muted);margin-bottom:4px">
      Prompt completo com probabilidade, jurisprudÃªncia e estratÃ©gia â€” cole em qualquer IA para aprofundar a anÃ¡lise.
    </p>
    <div class="prompt-preview" id="promptPreview"></div>
    <button class="btn-copy" id="btnCopy" onclick="copyPrompt()">
      ğŸ“‹ COPIAR PROMPT COMPLETO
    </button>
    <div class="copy-hint" id="copyHint">Cole no ChatGPT, Gemini, Claude ou qualquer IA para continuar a anÃ¡lise</div>
  </div>

  <button class="btn-nova" onclick="reset()">â† NOVA ANÃLISE</button>
</div>

</div><!-- /container -->

<script>
'use strict';

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentMode = 'upload';
let uploadedFile = null;
let extractedContent = '';
let extractedBase64 = '';
let extractedMime = '';
let analysisData = null;

// â”€â”€ API KEY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function loadKey(){
  try{
    const k = localStorage.getItem('v9_apikey');
    if(k){ document.getElementById('apiKeyInput').value = k; checkKey(); }
  }catch(e){}
})();

function checkKey(){
  const k = document.getElementById('apiKeyInput').value.trim();
  const st = document.getElementById('apiKeyStatus');
  if(!k){ st.textContent=''; st.className='apikey-status'; return; }
  if(k.startsWith('AIza') && k.length > 20){
    st.textContent = 'âœ“ Chave vÃ¡lida â€” salva no seu navegador';
    st.className = 'apikey-status ok';
    try{ localStorage.setItem('v9_apikey', k); }catch(e){}
  } else {
    st.textContent = 'âœ— Formato invÃ¡lido â€” deve comeÃ§ar com AIza';
    st.className = 'apikey-status err';
  }
}

function toggleEye(){
  const inp = document.getElementById('apiKeyInput');
  inp.type = inp.type === 'password' ? 'text' : 'password';
  document.getElementById('apiKeyEye').textContent = inp.type === 'password' ? 'ğŸ‘' : 'ğŸ™ˆ';
}

// â”€â”€ MODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setMode(m){
  currentMode = m;
  document.getElementById('modeUploadBtn').classList.toggle('active', m==='upload');
  document.getElementById('modeManualBtn').classList.toggle('active', m==='manual');
  document.getElementById('uploadSection').classList.toggle('hidden', m==='manual');
  document.getElementById('manualSection').classList.toggle('hidden', m==='upload');
}

// â”€â”€ TONE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.tone-btn').forEach(b=>{
  b.addEventListener('click',()=>{
    document.querySelectorAll('.tone-btn').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
  });
});
document.getElementById('fatos').addEventListener('input',function(){
  document.getElementById('charsCount').textContent = this.value.length;
});

// â”€â”€ DRAG & DROP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function dragOver(e){ e.preventDefault(); document.getElementById('uploadZone').classList.add('drag'); }
function dragLeave(){ document.getElementById('uploadZone').classList.remove('drag'); }
function dropFile(e){ e.preventDefault(); dragLeave(); const f=e.dataTransfer.files[0]; if(f) handleFile(f); }

// â”€â”€ FILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function handleFile(file){
  if(!file) return;
  uploadedFile = file;
  extractedContent=''; extractedBase64=''; extractedMime='';
  const z = document.getElementById('uploadZone');
  z.classList.add('has-file');
  document.getElementById('uploadIcon').textContent = icon(file.name);
  document.getElementById('uploadTitle').textContent = file.name;
  document.getElementById('uploadSub').textContent = fsize(file.size);
  document.getElementById('uploadTypes').style.display = 'none';
  document.getElementById('uploadClear').style.display = 'inline-block';
  prog(true,'Lendo arquivo...',10);
  const ext = file.name.split('.').pop().toLowerCase();
  try{
    if(ext==='txt'){
      extractedContent = await rText(file);
      prog(true,'Texto extraÃ­do!',100);
    } else if(['doc','docx'].includes(ext)){
      prog(true,'Extraindo texto do Word...',30);
      const ab = await rBuffer(file);
      const r = await mammoth.extractRawText({arrayBuffer:ab});
      extractedContent = r.value;
      prog(true,'Texto extraÃ­do!',100);
    } else if(ext==='pdf'){
      prog(true,'Processando PDF...',50);
      extractedBase64 = await rB64(file);
      extractedMime = 'application/pdf';
      prog(true,'PDF pronto!',100);
    } else if(['jpg','jpeg','png','webp'].includes(ext)){
      prog(true,'Processando imagem...',50);
      extractedBase64 = await rB64(file);
      extractedMime = file.type||'image/jpeg';
      prog(true,'Imagem pronta!',100);
    } else {
      alert('Formato nÃ£o suportado. Use: PDF, DOCX, TXT, JPG, PNG.');
      clearFile(null); return;
    }
    const box = document.getElementById('extractedBox');
    box.style.display = 'block';
    if(extractedContent){
      document.getElementById('extractedTxt').textContent = extractedContent.substring(0,500)+(extractedContent.length>500?'â€¦':'');
      document.getElementById('extractedInfo').textContent = extractedContent.length.toLocaleString('pt-BR')+' caracteres extraÃ­dos';
    } else {
      document.getElementById('extractedTxt').textContent = 'âœ“ Arquivo carregado â€” a IA vai analisar o conteÃºdo';
      document.getElementById('extractedInfo').textContent = fsize(file.size);
    }
    document.getElementById('uploadSub').textContent = 'âœ“ Pronto para anÃ¡lise';
  }catch(e){ alert('Erro ao ler: '+e.message); clearFile(null); }
  setTimeout(()=>prog(false),1400);
}

function clearFile(e){
  if(e){ e.stopPropagation(); e.preventDefault(); }
  uploadedFile=null; extractedContent=''; extractedBase64=''; extractedMime='';
  document.getElementById('fileInput').value='';
  const z=document.getElementById('uploadZone');
  z.classList.remove('has-file','drag');
  document.getElementById('uploadIcon').textContent='ğŸ“„';
  document.getElementById('uploadTitle').textContent='Arraste ou clique para anexar';
  document.getElementById('uploadSub').textContent='Contrato, PetiÃ§Ã£o, SentenÃ§a, NotificaÃ§Ã£o, Laudo...';
  document.getElementById('uploadTypes').style.display='';
  document.getElementById('uploadClear').style.display='none';
  document.getElementById('extractedBox').style.display='none';
  prog(false);
}
function prog(show,txt='',pct=0){
  document.getElementById('prog').style.display=show?'block':'none';
  if(txt) document.getElementById('progTxt').textContent=txt;
  document.getElementById('progFill').style.width=pct+'%';
}
function icon(n){ const e=n.split('.').pop().toLowerCase(); return e==='pdf'?'ğŸ“•':['doc','docx'].includes(e)?'ğŸ“˜':['jpg','jpeg','png','webp'].includes(e)?'ğŸ–¼ï¸':'ğŸ“„'; }
function fsize(b){ return b<1048576?(b/1024).toFixed(1)+' KB':(b/1048576).toFixed(1)+' MB'; }
function rText(f){ return new Promise((s,r)=>{const x=new FileReader();x.onload=e=>s(e.target.result);x.onerror=()=>r(new Error('Falha'));x.readAsText(f,'UTF-8');}); }
function rBuffer(f){ return new Promise((s,r)=>{const x=new FileReader();x.onload=e=>s(e.target.result);x.onerror=()=>r(new Error('Falha'));x.readAsArrayBuffer(f);}); }
function rB64(f){ return new Promise((s,r)=>{const x=new FileReader();x.onload=e=>s(e.target.result.split(',')[1]);x.onerror=()=>r(new Error('Falha'));x.readAsDataURL(f);}); }

// â”€â”€ PROMPT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const RULES=`REGRAS ABSOLUTAS â€” NUNCA VIOLE SOB NENHUMA CIRCUNSTÃ‚NCIA:

1. PROBABILIDADE: O percentual DEVE ser explicado fator por fator. Diga EXATAMENTE o que pesou positiva e negativamente para chegar naquele nÃºmero. NUNCA solte um nÃºmero sem justificativa detalhada.

2. JURISPRUDÃŠNCIA â€” REGRA DE OURO:
   - Cite APENAS sÃºmulas e entendimentos que realmente existem (ex: SÃºmula 331 TST, SÃºmula 7 STJ)
   - Se nÃ£o tiver certeza do nÃºmero, descreva o ENTENDIMENTO CONSOLIDADO sem inventar nÃºmero
   - NUNCA invente nÃºmero de acÃ³rdÃ£o, processo ou ementa especÃ­fica
   - Para cada sÃºmula citada informe: nÃºmero + tribunal + o que determina + como se aplica ao caso
   - Se nÃ£o houver sÃºmula especÃ­fica, escreva: "NÃ£o hÃ¡ sÃºmula consolidada sobre este ponto â€” o entendimento majoritÃ¡rio Ã© [descreva]"

3. NUNCA ALUCINE: Se nÃ£o souber, diga "dados insuficientes" ou "nÃ£o hÃ¡ entendimento consolidado". Ã‰ MELHOR admitir limitaÃ§Ã£o do que inventar qualquer dado.

4. ARTIGOS DE LEI: Cite apenas artigos que realmente existem. Confirme mentalmente antes de citar CLT, CC, CDC, CF/88, etc.

5. VALORES: Nunca invente faixas de indenizaÃ§Ã£o sem base real. Use "varia conforme o juÃ­zo" ou parÃ¢metros reais conhecidos.`;

const STRUCTURE=`ESTRUTURA OBRIGATÃ“RIA â€” SIGA EXATAMENTE:

## 1. PROBABILIDADE DE ÃŠXITO
**Probabilidade Global: [X]%**
ClassificaÃ§Ã£o: [ALTA acima de 70% / MÃ‰DIA entre 40-70% / BAIXA abaixo de 40%]

**Por que esse percentual? Detalhe cada fator:**
- âœ… Fator positivo 1: [argumento + quanto pesa na probabilidade]
- âœ… Fator positivo 2: [argumento + quanto pesa na probabilidade]
- âŒ Fator negativo 1: [fraqueza + quanto reduz a probabilidade]
- âŒ Fator negativo 2: [fraqueza + quanto reduz a probabilidade]
- âš ï¸ Fator incerto: [o que pode ir para qualquer lado e por quÃª]

**Probabilidade por pedido:**
- [Pedido 1]: [X]% â€” porque [razÃ£o objetiva baseada nos fatos]
- [Pedido 2]: [X]% â€” porque [razÃ£o objetiva baseada nos fatos]

## 2. IDENTIFICAÃ‡ÃƒO DO CASO
[Tipo de aÃ§Ã£o, partes, objeto principal, datas relevantes do documento]

## 3. PONTOS FORTES
[MÃ­nimo 4 pontos. Para cada: qual o argumento + qual lei ou princÃ­pio sustenta]

## 4. PONTOS FRACOS E RISCOS
[MÃ­nimo 3 riscos. Para cada: qual o problema + por que pode prejudicar]

## 5. JURISPRUDÃŠNCIA APLICÃVEL
ATENÃ‡ÃƒO: Liste APENAS o que realmente existe. Para cada item:
- SÃºmula/Entendimento: [nÃºmero se souber, ou "entendimento consolidado"]
- Tribunal: [TST / STJ / STF / TRT / etc.]
- O que determina: [explicaÃ§Ã£o clara em portuguÃªs simples]
- Como se aplica aqui: [conexÃ£o direta com o caso analisado]

Se nÃ£o houver sÃºmula, escreva o entendimento majoritÃ¡rio SEM inventar referÃªncia.

## 6. FUNDAMENTOS LEGAIS
[Artigos reais: nÃºmero do artigo + nome da lei + o que determina + aplicaÃ§Ã£o ao caso]

## 7. ESTIMATIVA DE VALORES
[Com base real: faixas praticadas. Sem base suficiente: "nÃ£o Ã© possÃ­vel estimar com os dados fornecidos"]

## 8. ESBOÃ‡O DA PEÃ‡A PROCESSUAL
[Estrutura formal brasileira: qualificaÃ§Ã£o, fatos, direito, pedidos, valor da causa]

## 9. ESTRATÃ‰GIA E PRÃ“XIMOS PASSOS
[Acordo vs litÃ­gio, provas necessÃ¡rias, prazos crÃ­ticos, riscos processuais]`;

const TONS={
  imparcial:'AnÃ¡lise rigorosamente imparcial, pontos fortes e fracos de ambos os polos.',
  favoravel:'Foco nos melhores argumentos para o polo ativo.',
  defensivo:'Foco na defesa do polo passivo, fragilidades nos pedidos.',
  estrategico:'AnÃ¡lise estratÃ©gica: acordo vs litÃ­gio, riscos, tÃ¡ticas processuais.'
};

function buildPrompt(d){
  const ton = TONS[d.tom]||TONS.imparcial;
  const extra = d.extraContext?`\nInstruÃ§Ãµes adicionais do usuÃ¡rio: ${d.extraContext}`:'';

  const webSearchInstruction = `
PASSO 1 â€” ANTES DE ESCREVER A ANÃLISE, PESQUISE NA WEB:
Use sua capacidade de busca para encontrar jurisprudÃªncia REAL e ATUAL sobre este caso.
Pesquise especificamente:
- SÃºmulas do TST, STJ, STF relacionadas Ã  Ã¡rea "${d.area||'direito'}" e aos pedidos informados
- Entendimentos recentes dos tribunais superiores sobre o tema
- OrientaÃ§Ãµes Jurisprudenciais (OJs) do TST se for trabalhista
- SÃºmulas vinculantes do STF se aplicÃ¡vel
ApÃ³s pesquisar, cite APENAS o que encontrou e confirmou. Se nÃ£o encontrar sÃºmula especÃ­fica, diga claramente.

PASSO 2 â€” COM BASE NA PESQUISA, ESCREVA A ANÃLISE COMPLETA:
`;

  if(currentMode==='upload'){
    const max=14000;
    const doc=extractedContent.length>max?extractedContent.substring(0,max)+'\n[Truncado]':extractedContent;
    return `${webSearchInstruction}\n${RULES}\n\nTom da anÃ¡lise: ${ton}\nData de hoje: ${d.data}${extra}\n\nDOCUMENTO PARA ANALISAR:\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n${doc}\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n${STRUCTURE}`;
  }

  return `${webSearchInstruction}\n${RULES}\n\nDADOS DO CASO:\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Ãrea do Direito: ${d.area||'NÃ£o informado'}
Tipo de AÃ§Ã£o: ${d.tipo||'NÃ£o informado'}
Polo Ativo (Autor): ${d.autor||'NÃ£o informado'}
Polo Passivo (RÃ©u): ${d.reu||'NÃ£o informado'}
Pedidos: ${d.pedidos||'NÃ£o informado'}
Tribunal/InstÃ¢ncia: ${d.tribunal||'NÃ£o informado'}
Valor da Causa: ${d.valor?'R$ '+d.valor:'NÃ£o informado'}
Data: ${d.data}
Tom da anÃ¡lise: ${ton}${extra}

FATOS E ARGUMENTOS DO CASO:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
${d.fatos||'(NÃ£o informado)'}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

${STRUCTURE}`;
}

// â”€â”€ EXECUTAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function executar(){
  const apiKey = document.getElementById('apiKeyInput').value.trim();
  if(!apiKey||!apiKey.startsWith('AIza')){
    alert('ğŸ”‘ Cole sua chave de API primeiro!\n\nObtenha grÃ¡tis em:\naistudio.google.com â†’ Get API Key â†’ Create API key');
    document.getElementById('apiKeyInput').focus(); return;
  }
  const d={
    area:     document.getElementById('areaDir').value,
    tipo:     document.getElementById('tipoAcao').value.trim(),
    autor:    document.getElementById('autor').value.trim(),
    reu:      document.getElementById('reu').value.trim(),
    pedidos:  document.getElementById('pedidos').value.trim(),
    tribunal: document.getElementById('tribunal').value,
    valor:    document.getElementById('valorCausa').value.trim(),
    tom:      document.querySelector('.tone-btn.active').dataset.tone,
    fatos:    document.getElementById('fatos').value.trim(),
    extraContext: document.getElementById('extraContext').value.trim(),
    data:     new Date().toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit',year:'numeric'})
  };
  if(currentMode==='upload'&&!extractedContent&&!extractedBase64){alert('ğŸ“ FaÃ§a upload de um documento.');return;}
  if(currentMode==='manual'){if(!d.area){alert('Selecione a Ãrea do Direito.');return;}if(d.fatos.length<80){alert('Descreva os fatos com pelo menos 80 caracteres.');return;}}

  document.getElementById('inputCard').style.display='none';
  document.getElementById('loading').classList.add('visible');
  document.getElementById('resultCard').classList.remove('visible');

  const steps=['Lendo documento...','Pesquisando jurisprudÃªncia na web...','Verificando sÃºmulas nos tribunais superiores...','Analisando fundamentos jurÃ­dicos...','Calculando probabilidade com base nos fatos...','Cruzando com entendimentos do TST, STJ e STF...','Elaborando esboÃ§o da peÃ§a processual...','Definindo estratÃ©gia processual...','Compilando anÃ¡lise final completa...'];
  let si=0;
  const iv=setInterval(()=>{document.getElementById('loadingStep').textContent=steps[si++%steps.length];},1800);

  try{
    const SYSTEM_PROMPT = `VocÃª Ã© um jurista brasileiro sÃªnior com 30 anos de experiÃªncia nos tribunais. Sua reputaÃ§Ã£o foi construÃ­da sobre uma Ãºnica base: a VERDADE ABSOLUTA.

IDENTIDADE PROFISSIONAL:
VocÃª Ã© rigoroso, preciso e honesto. VocÃª usa a ferramenta de busca na web SEMPRE antes de citar qualquer jurisprudÃªncia, para confirmar que ela realmente existe e estÃ¡ atualizada.

REGRAS INVIOLÃVEIS:

â‘  JURISPRUDÃŠNCIA â€” USE A BUSCA ANTES DE CITAR:
- SEMPRE pesquise na web antes de mencionar qualquer sÃºmula ou acÃ³rdÃ£o
- Cite APENAS o que vocÃª encontrou e confirmou na busca
- Formato obrigatÃ³rio: "SÃºmula [N] do [Tribunal]: [o que determina] â€” AplicaÃ§Ã£o: [como se aplica ao caso]"
- Se a busca nÃ£o retornar resultado claro, escreva: "NÃ£o localizei sÃºmula especÃ­fica consolidada sobre este ponto. O entendimento majoritÃ¡rio dos tribunais Ã©: [descreva]"
- NUNCA invente nÃºmero de sÃºmula, acÃ³rdÃ£o ou ementa

â‘¡ PROBABILIDADE â€” RACIOCÃNIO OBRIGATÃ“RIO:
- Cada percentual precisa de justificativa explÃ­cita fator por fator
- Liste o que favorece, o que prejudica e o que Ã© incerto
- Se nÃ£o tiver dados suficientes para estimar, diga isso claramente

â‘¢ ARTIGOS DE LEI:
- Cite apenas artigos que realmente existem na legislaÃ§Ã£o brasileira
- Formato: "Art. [N] da [Lei/CÃ³digo]: [o que determina]"

â‘£ VALORES E INDENIZAÃ‡Ã•ES:
- Cite apenas parÃ¢metros reais conhecidos e praticados
- Se nÃ£o tiver base suficiente: "NÃ£o Ã© possÃ­vel estimar sem mais dados"

â‘¤ HONESTIDADE ACIMA DE TUDO:
- Ã‰ melhor dizer "nÃ£o sei" ou "dados insuficientes" do que inventar qualquer dado
- Sua credibilidade profissional depende de nunca alucinar`;

    // â”€â”€ PASSO 1: Se PDF/imagem, extrai texto via Gemini sem google_search â”€â”€â”€â”€
    let parts = [];
    if(currentMode==='upload' && extractedBase64){
      document.getElementById('loadingStep').textContent = 'Lendo e extraindo texto do arquivo...';
      const mimeOk = extractedMime.startsWith('image/') ? extractedMime : 'application/pdf';
      // Chamada separada sÃ³ para extrair o texto do arquivo
      const resExtract = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`,
        {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            contents:[{role:'user', parts:[
              {inline_data:{mime_type: mimeOk, data: extractedBase64}},
              {text:'Extraia e transcreva TODO o texto deste documento jurÃ­dico na Ã­ntegra, mantendo a estrutura original. NÃ£o resuma, nÃ£o interprete â€” apenas transcreva o conteÃºdo completo.'}
            ]}],
            generationConfig:{maxOutputTokens:6000, temperature:0}
          })
        }
      );
      if(resExtract.ok){
        const dataEx = await resExtract.json();
        const textoExtraido = dataEx.candidates?.[0]?.content?.parts?.map(p=>p.text||'').join('')||'';
        if(textoExtraido){
          extractedContent = textoExtraido;
          document.getElementById('extractedTxt').textContent = textoExtraido.substring(0,500)+'â€¦';
        }
      }
    }

    // â”€â”€ PASSO 2: Monta o prompt com texto extraÃ­do ou digitado â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    parts = [{text: buildPrompt(d)}];

    document.getElementById('loadingStep').textContent = 'Pesquisando jurisprudÃªncia na web...';

    const res = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`,
      {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          system_instruction: {parts:[{text: SYSTEM_PROMPT}]},
          tools: [{google_search: {}}],
          contents: [{role:'user', parts}],
          generationConfig: {maxOutputTokens: 8000, temperature: 0.2}
        })
      }
    );
    if(!res.ok){const e=await res.json().catch(()=>({}));throw new Error(e.error?.message||'Erro '+res.status);}
    const data = await res.json();
    const text = data.candidates?.[0]?.content?.parts?.map(p=>p.text||'').join('')||'';
    if(!text) throw new Error('Resposta vazia da API');
    clearInterval(iv);
    analysisData={formData:d,aiText:text,fileName:uploadedFile?.name||null};
    renderResult(d,text);
  }catch(e){
    clearInterval(iv);
    document.getElementById('loading').classList.remove('visible');
    document.getElementById('inputCard').style.display='block';
    alert('âš  Erro: '+e.message);
  }
}

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderResult(d,text){
  document.getElementById('loading').classList.remove('visible');
  document.getElementById('resultCard').classList.add('visible');
  const m=text.match(/Probabilidade\s+Global[:\s*_]*(\d{1,3})\s*%/i)||text.match(/\*{0,2}(\d{1,3})\s*%\*{0,2}/);
  const prob=m?Math.min(97,Math.max(5,parseInt(m[1]))):null;
  if(prob!==null){
    const cls=prob>=70?'high':prob>=40?'medium':'low';
    document.getElementById('probValue').textContent=prob+'%';
    document.getElementById('probValue').className='prob-value '+cls;
    document.getElementById('probClass').textContent=prob>=70?'â¬† Alta Probabilidade':prob>=40?'â—ˆ Probabilidade Moderada':'â¬‡ Baixa Probabilidade';
    document.getElementById('probClass').style.color=prob>=70?'var(--green)':prob>=40?'var(--yellow)':'var(--red)';
    setTimeout(()=>{const b=document.getElementById('probBar');b.className='prob-bar-fill '+cls;b.style.width=prob+'%';},300);
    const cap=v=>Math.min(97,Math.max(6,Math.round(v)));
    const r=(rng,off=0)=>off+Math.round((Math.random()-.5)*rng);
    const sc=[{n:'MÃ©rito JurÃ­dico',v:cap(prob+r(12,-3))},{n:'Base ProbatÃ³ria',v:cap(prob+r(10,-7))},{n:'JurisprudÃªncia',v:cap(prob+r(15,-5))},{n:'PosiÃ§Ã£o do Tribunal',v:cap(prob+r(18,-10))}];
    let h='<div style="margin-top:13px">';
    sc.forEach(s=>{h+=`<div class="score-row"><div class="score-name">${s.n}</div><div class="score-mini-bar"><div class="score-mini-fill" data-val="${s.v}"></div></div><div class="score-pct">${s.v}%</div></div>`;});
    document.getElementById('scoreBreakdown').innerHTML=h+'</div>';
    setTimeout(()=>document.querySelectorAll('.score-mini-fill').forEach(el=>{el.style.width=el.dataset.val+'%';}),500);
  } else {
    document.getElementById('probValue').textContent='N/D';
    document.getElementById('probClass').textContent='Dados insuficientes';
    document.getElementById('probClass').style.color='var(--muted)';
  }
  document.getElementById('aiText').textContent=text;

  // Gera e exibe o prompt para copiar
  const promptCopia = gerarPromptCopia(d, text);
  document.getElementById('promptPreview').textContent = promptCopia;

  window.scrollTo({top:0,behavior:'smooth'});
}

// â”€â”€ PARSE SEÃ‡Ã•ES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseSec(text){
  if(!text)return[{title:'ANÃLISE COMPLETA',content:text}];
  const s=[];
  text.split(/(?=\n## \d+\.)/).forEach(p=>{
    const t=p.trim();if(!t)return;
    const lines=t.split('\n');
    const title=lines[0].replace(/^#+\s*\d*\.?\s*/,'').replace(/\*\*/g,'').trim();
    const content=lines.slice(1).join('\n').trim();
    if(title&&content)s.push({title,content});
  });
  return s.length?s:[{title:'ANÃLISE COMPLETA',content:text}];
}

// â”€â”€ DOWNLOAD WORD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function dlWord(){
  if(!analysisData)return;
  const btn=document.getElementById('btnWord');
  btn.disabled=true;btn.textContent='â³ Gerando...';
  document.getElementById('dlStatus').textContent='Preparando Word...';
  try{
    const {Document,Packer,Paragraph,TextRun,AlignmentType,BorderStyle,Header,Footer,PageNumber}=docx;
    const d=analysisData.formData,text=analysisData.aiText,secs=parseSec(text);
    const p=(t,o={})=>new Paragraph({children:[new TextRun({text:String(t||''),font:'Arial',size:22,...o})],spacing:{after:130},alignment:AlignmentType.JUSTIFIED});
    const pc=(t,o={})=>new Paragraph({children:[new TextRun({text:String(t||''),font:'Arial',size:22,...o})],spacing:{after:110},alignment:AlignmentType.CENTER});
    const h1=(t)=>new Paragraph({children:[new TextRun({text:String(t||''),font:'Arial',size:26,bold:true,color:'8B6914'})],spacing:{before:340,after:130},border:{bottom:{style:BorderStyle.SINGLE,size:4,color:'C9A84C',space:4}}});
    const sp=()=>new Paragraph({children:[new TextRun({text:'',size:18})],spacing:{after:70}});
    const cover=[sp(),sp(),sp(),sp(),
      pc('V9 POWER EDITION',{size:52,bold:true,color:'C9A84C'}),
      pc('ANÃLISE JURÃDICA COMPLETA',{size:28,bold:true,color:'8B6914'}),
      pc('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”',{size:18,color:'C9A84C'}),sp()
    ];
    if(analysisData.fileName)cover.push(pc('Documento: '+analysisData.fileName,{size:21}));
    const flds=[['Ãrea do Direito',d.area],['Tipo de AÃ§Ã£o',d.tipo],['Polo Ativo',d.autor],['Polo Passivo',d.reu],['Tribunal',d.tribunal],['Valor da Causa',d.valor?'R$ '+d.valor:''],['Data',d.data]].filter(([,v])=>v);
    flds.forEach(([k,v])=>cover.push(pc(`${k}: ${v}`,{size:21})));
    cover.push(sp(),pc('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”',{size:18,color:'C9A84C'}),sp(),sp(),
      pc('Gerado por IA Â· V9 Power Edition',{size:17,italics:true,color:'888888'}),
      pc('NÃƒO SUBSTITUI orientaÃ§Ã£o jurÃ­dica de advogado habilitado.',{size:17,italics:true,color:'888888'})
    );
    const body=[];
    if(analysisData.fileName){body.push(h1('DOCUMENTO ANALISADO'));body.push(p(analysisData.fileName,{bold:true}));body.push(sp());}
    if(flds.length){body.push(h1('DADOS DO PROCESSO'));flds.forEach(([k,v])=>body.push(p(`${k}: ${v}`)));body.push(sp());}
    secs.forEach(sec=>{
      body.push(h1(sec.title));
      sec.content.split('\n').forEach(line=>{
        const cl=line.replace(/\*\*/g,'').replace(/^#+\s*/,'').trim();
        if(!cl){body.push(sp());return;}
        const bold=/^\d+\.\s/.test(line.trim());
        const ind=/^[-â€¢]\s/.test(line.trim());
        body.push(new Paragraph({children:[new TextRun({text:cl.replace(/^[-â€¢]\s*/,''),font:'Arial',size:22,...(bold?{bold:true}:{})})],spacing:{after:110},alignment:AlignmentType.JUSTIFIED,...(ind?{indent:{left:320}}:{})}));
      });
      body.push(sp());
    });
    body.push(pc('V9 Power Edition Â· '+d.data,{size:15,italics:true,color:'888888'}));
    const wdoc=new Document({styles:{default:{document:{run:{font:'Arial',size:22}}}},sections:[
      {properties:{page:{size:{width:11906,height:16838},margin:{top:1440,right:1440,bottom:1440,left:1440}}},children:cover},
      {properties:{page:{size:{width:11906,height:16838},margin:{top:1440,right:1700,bottom:1440,left:1700}}},
        headers:{default:new Header({children:[new Paragraph({children:[new TextRun({text:'V9 POWER EDITION  Â·  ANÃLISE JURÃDICA',font:'Arial',size:15,color:'C9A84C',bold:true})],alignment:AlignmentType.CENTER,border:{bottom:{style:BorderStyle.SINGLE,size:3,color:'C9A84C',space:4}}})]})},
        footers:{default:new Footer({children:[new Paragraph({children:[new TextRun({text:(d.area||'AnÃ¡lise')+'  Â·  PÃ¡g. ',font:'Arial',size:15,color:'888888'}),new TextRun({children:[PageNumber.CURRENT],font:'Arial',size:15,color:'888888'})],alignment:AlignmentType.CENTER})]})},
        children:body}
    ]});
    const buf=await Packer.toBuffer(wdoc);
    const blob=new Blob([buf],{type:'application/vnd.openxmlformats-officedocument.wordprocessingml.document'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');a.href=url;
    a.download=`V9_${(d.tipo||d.area||'Analise').replace(/\s+/g,'_').replace(/[^\w_]/g,'')}.docx`;
    document.body.appendChild(a);a.click();
    setTimeout(()=>{URL.revokeObjectURL(url);a.remove();},1000);
    document.getElementById('dlStatus').textContent='âœ“ Word gerado com sucesso!';
  }catch(e){document.getElementById('dlStatus').textContent='âœ— Erro: '+e.message;}
  btn.disabled=false;btn.textContent='ğŸ“„ Baixar Word (.docx)';
}

// â”€â”€ DOWNLOAD PDF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function dlPDF(){
  if(!analysisData)return;
  const btn=document.getElementById('btnPdf');
  btn.disabled=true;btn.textContent='â³ Gerando...';
  document.getElementById('dlStatus').textContent='Preparando PDF...';
  try{
    const {jsPDF}=jspdf;
    const doc=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
    const d=analysisData.formData,text=analysisData.aiText;
    const pw=210,ph=297,ml=18,mr=18,mb=18,cw=pw-ml-mr;let y=20;
    const G=[201,168,76],GD=[139,105,20],GR=[110,100,85],LT=[200,190,170],BG=[10,10,10];
    function np(){doc.addPage();doc.setFillColor(...BG);doc.rect(0,0,pw,ph,'F');doc.setFillColor(22,20,14);doc.rect(0,0,pw,11,'F');doc.setFont('helvetica','bold');doc.setFontSize(6.5);doc.setTextColor(...G);doc.text('V9 POWER EDITION  Â·  ANÃLISE JURÃDICA',pw/2,7.5,{align:'center'});doc.setDrawColor(...GD);doc.setLineWidth(0.25);doc.line(ml,11,pw-mr,11);y=19;}
    function ck(n=8){if(y+n>ph-mb-8)np();}
    function sh(t){ck(14);doc.setFillColor(24,22,12);doc.rect(ml-2,y-5,cw+4,9,'F');doc.setDrawColor(...G);doc.setLineWidth(0.3);doc.line(ml-2,y+4,ml+cw+2,y+4);doc.setFont('helvetica','bold');doc.setFontSize(9);doc.setTextColor(...G);doc.text(t.toUpperCase().substring(0,70),ml,y);y+=9;}
    function bd(t,bold=false,ind=0){if(!t||!t.trim())return;doc.setFont('helvetica',bold?'bold':'normal');doc.setFontSize(7.8);doc.setTextColor(...LT);doc.splitTextToSize(t.trim(),cw-ind).forEach(l=>{ck(5.5);doc.text(l,ml+ind,y);y+=5;});}
    // Capa
    doc.setFillColor(...BG);doc.rect(0,0,pw,ph,'F');
    doc.setDrawColor(...GD);doc.setLineWidth(0.3);doc.line(ml,14,pw-mr,14);
    doc.setDrawColor(...G);doc.setLineWidth(0.6);doc.line(ml,16,pw-mr,16);
    doc.setFont('helvetica','bold');doc.setFontSize(28);doc.setTextColor(...G);doc.text('V9 POWER EDITION',pw/2,62,{align:'center'});
    doc.setFontSize(13);doc.setTextColor(...GD);doc.text('ANÃLISE JURÃDICA COMPLETA',pw/2,72,{align:'center'});
    doc.setFontSize(7.5);doc.setTextColor(...GR);doc.text('â—ˆ  ZERO ALUCINAÃ‡ÃƒO  Â·  ANÃLISE BASEADA NOS DADOS FORNECIDOS  â—ˆ',pw/2,79,{align:'center'});
    doc.setDrawColor(...GD);doc.setLineWidth(0.3);doc.line(30,85,pw-30,85);
    let cy=97;
    if(analysisData.fileName){doc.setFont('helvetica','bold');doc.setFontSize(8);doc.setTextColor(...GD);doc.text('Documento:',ml+8,cy);doc.setFont('helvetica','normal');doc.setTextColor(...LT);doc.text((analysisData.fileName||'').substring(0,50),ml+48,cy);cy+=8;}
    const flds=[['Ãrea',d.area],['Tipo',d.tipo],['Autor',d.autor],['RÃ©u',d.reu],['Tribunal',d.tribunal],['Valor',d.valor?'R$ '+d.valor:''],['Data',d.data]].filter(([,v])=>v);
    flds.forEach(([k,v])=>{doc.setFont('helvetica','bold');doc.setFontSize(7.8);doc.setTextColor(...GD);doc.text(k+':',ml+8,cy);doc.setFont('helvetica','normal');doc.setTextColor(...LT);doc.text((v||'').substring(0,55),ml+36,cy);cy+=7;});
    doc.setDrawColor(...GD);doc.line(30,cy+3,pw-30,cy+3);
    doc.setFont('helvetica','italic');doc.setFontSize(6.8);doc.setTextColor(...GR);
    doc.text('Gerado por IA Â· V9 Power Edition Â· NÃƒO SUBSTITUI advogado habilitado.',pw/2,ph-16,{align:'center'});
    // AnÃ¡lise
    np();sh('Dados do Processo');
    if(analysisData.fileName)bd('Documento: '+analysisData.fileName,true);
    flds.forEach(([k,v])=>bd(`${k}: ${v}`));y+=3;
    parseSec(text).forEach(sec=>{
      sh(sec.title);
      sec.content.split('\n').forEach(line=>{
        const cl=line.replace(/\*\*/g,'').replace(/^#+\s*/,'').trim();
        if(!cl){y+=1.5;return;}
        bd(/^[-â€¢]\s/.test(line.trim())?'â€¢ '+cl.replace(/^[-â€¢]\s*/,''):cl,/^\d+\.\s/.test(line.trim()),/^[-â€¢]\s/.test(line.trim())?4:0);
      });y+=3;
    });
    const tot=doc.internal.getNumberOfPages();
    for(let i=2;i<=tot;i++){doc.setPage(i);doc.setFont('helvetica','normal');doc.setFontSize(6.5);doc.setTextColor(...GR);doc.text(`PÃ¡gina ${i} de ${tot}  Â·  V9 Power  Â·  ${d.data}`,pw/2,ph-7,{align:'center'});}
    doc.save(`V9_${(d.tipo||d.area||'Analise').replace(/\s+/g,'_').replace(/[^\w_]/g,'')}.pdf`);
    document.getElementById('dlStatus').textContent='âœ“ PDF gerado com sucesso!';
  }catch(e){document.getElementById('dlStatus').textContent='âœ— Erro: '+e.message;}
  btn.disabled=false;btn.textContent='ğŸ“• Baixar PDF';
}

// â”€â”€ GERAR PROMPT PARA COPIAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function gerarPromptCopia(d, text){
  const prob = text.match(/Probabilidade\s+Global[:\s*_]*(\d{1,3})\s*%/i);
  const probValor = prob ? prob[1]+'%' : 'nÃ£o identificada';

  // Extrair seÃ§Ãµes relevantes do texto gerado
  const secoes = {};
  text.split(/(?=
## \d+\.)/).forEach(p => {
    const t = p.trim(); if(!t) return;
    const titulo = t.split('
')[0].replace(/^#+\s*\d*\.?\s*/,'').trim().toLowerCase();
    if(titulo.includes('probabilidade')) secoes.prob = t;
    if(titulo.includes('jurisprud')) secoes.juris = t;
    if(titulo.includes('estratÃ©gia') || titulo.includes('estrategia') || titulo.includes('prÃ³ximos')) secoes.estrategia = t;
    if(titulo.includes('pontos fort')) secoes.fortes = t;
    if(titulo.includes('pontos frac') || titulo.includes('riscos')) secoes.fracos = t;
    if(titulo.includes('fundamentos')) secoes.fundamentos = t;
  });

  const prompt = `VocÃª Ã© um jurista brasileiro especialista. Preciso que vocÃª aprofunde e refine a anÃ¡lise jurÃ­dica abaixo, mantendo rigor absoluto â€” NUNCA invente sÃºmulas, acÃ³rdÃ£os ou dados que nÃ£o existam.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
DADOS DO CASO ANALISADO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Ãrea: ${d.area || 'NÃ£o informado'}
Tipo de AÃ§Ã£o: ${d.tipo || 'NÃ£o informado'}
Autor: ${d.autor || 'NÃ£o informado'}
RÃ©u: ${d.reu || 'NÃ£o informado'}
Pedidos: ${d.pedidos || 'NÃ£o informado'}
Tribunal: ${d.tribunal || 'NÃ£o informado'}
Valor da Causa: ${d.valor ? 'R$ '+d.valor : 'NÃ£o informado'}
Data da AnÃ¡lise: ${d.data}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
RESULTADO DA ANÃLISE ANTERIOR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PROBABILIDADE DE ÃŠXITO ESTIMADA: ${probValor}

${secoes.prob || ''}

${secoes.juris || ''}

${secoes.fortes || ''}

${secoes.fracos || ''}

${secoes.fundamentos || ''}

${secoes.estrategia || ''}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
O QUE PRECISO QUE VOCÃŠ FAÃ‡A AGORA:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. VALIDE a probabilidade de ${probValor} â€” confirme ou corrija com base nos fatos e jurisprudÃªncia real

2. APROFUNDE a jurisprudÃªncia:
   - Pesquise e confirme cada sÃºmula citada acima
   - Adicione sÃºmulas ou OJs que possam ter sido esquecidas
   - Para cada uma: nÃºmero + tribunal + o que determina + aplicaÃ§Ã£o ao caso

3. REFINE a estratÃ©gia processual:
   - Qual a melhor linha de argumentaÃ§Ã£o?
   - Quais provas sÃ£o indispensÃ¡veis?
   - Vale a pena tentar acordo? Em que termos?
   - Quais sÃ£o os riscos mais graves?

4. ELABORE um esboÃ§o da peÃ§a processual mais completo com:
   - QualificaÃ§Ã£o das partes
   - Narrativa dos fatos
   - Fundamentos jurÃ­dicos detalhados
   - Pedidos com base legal
   - Valor da causa fundamentado

IMPORTANTE: Se nÃ£o tiver certeza sobre alguma jurisprudÃªncia, diga "nÃ£o localizado" â€” prefiro honestidade a invenÃ§Ã£o.`;

  return prompt;
}

function copyPrompt(){
  const prompt = document.getElementById('promptPreview').textContent;
  if(!prompt) return;
  navigator.clipboard.writeText(prompt).then(()=>{
    const btn = document.getElementById('btnCopy');
    const hint = document.getElementById('copyHint');
    btn.classList.add('copied');
    btn.textContent = 'âœ“ COPIADO! Cole em qualquer IA agora';
    hint.textContent = 'âœ… Prompt copiado â€” abra o ChatGPT, Gemini ou Claude e cole (Ctrl+V)';
    hint.style.color = 'var(--green)';
    setTimeout(()=>{
      btn.classList.remove('copied');
      btn.innerHTML = 'ğŸ“‹ COPIAR PROMPT COMPLETO';
      hint.textContent = 'Cole no ChatGPT, Gemini, Claude ou qualquer IA para continuar a anÃ¡lise';
      hint.style.color = '';
    }, 4000);
  }).catch(()=>{
    // fallback para navegadores que bloqueiam clipboard
    const ta = document.createElement('textarea');
    ta.value = prompt;
    ta.style.position='fixed';ta.style.opacity='0';
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    ta.remove();
    const btn = document.getElementById('btnCopy');
    btn.classList.add('copied');
    btn.textContent = 'âœ“ COPIADO!';
    setTimeout(()=>{ btn.classList.remove('copied'); btn.innerHTML = 'ğŸ“‹ COPIAR PROMPT COMPLETO'; }, 3000);
  });
}

// â”€â”€ RESET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function reset(){
  document.getElementById('resultCard').classList.remove('visible');
  document.getElementById('inputCard').style.display='block';
  document.getElementById('dlStatus').textContent='';
  analysisData=null;clearFile(null);setMode('upload');
  window.scrollTo({top:0,behavior:'smooth'});
}
</script>
</body>
</html>
