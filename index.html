<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>V9 PRO â€“ AnÃ¡lise JurÃ­dica Profissional</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Rajdhani:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.5.0/docx.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
<style>
:root{
  --gold:#c9a84c;--gold-light:#e8c96b;--gold-dark:#8b6914;
  --bg:#060606;--card:#0e0e0e;--card2:#141414;--border:#222;
  --text:#e0d5c0;--muted:#6b6050;--green:#2ecc71;--red:#e74c3c;--yellow:#f39c12;--blue:#3498db;
}
*{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{background:var(--bg);color:var(--text);font-family:'Rajdhani',sans-serif;font-size:15px;line-height:1.6;min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--gold-dark) 20%,var(--gold-light) 50%,var(--gold-dark) 80%,transparent);z-index:1000}

/* â”€â”€ TOPBAR â”€â”€ */
.topbar{background:#080808;border-bottom:1px solid #1a1a1a;padding:0 24px;display:grid;grid-template-columns:1fr auto 1fr;align-items:center;height:52px;position:sticky;top:2px;z-index:500}
.topbar::after{content:'';position:absolute;bottom:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--gold-dark) 30%,var(--gold) 50%,var(--gold-dark) 70%,transparent)}
.topbar-logo{font-family:'Cinzel',serif;font-size:.78rem;letter-spacing:.35em;background:linear-gradient(135deg,var(--gold-dark),var(--gold-light));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;font-weight:700}
.topbar-center{display:flex;gap:6px;align-items:center;justify-content:center;flex-wrap:nowrap}
.topbar-pill{display:inline-flex;align-items:center;gap:5px;font-size:.56rem;letter-spacing:.1em;color:var(--muted);border:1px solid #1e1e1e;border-radius:20px;padding:4px 10px;text-transform:uppercase;white-space:nowrap;transition:all .2s}
.topbar-pill.active{color:var(--green);border-color:rgba(46,204,113,.25);background:rgba(46,204,113,.05)}
.topbar-pill.gold{color:var(--gold-dark);border-color:rgba(201,168,76,.2);background:rgba(201,168,76,.04)}
.topbar-pill-dot{width:5px;height:5px;border-radius:50%;background:currentColor;flex-shrink:0}
.topbar-actions{display:flex;gap:8px;align-items:center;justify-content:flex-end}
.btn-hist{background:transparent;border:1px solid #1e1e1e;border-radius:4px;color:var(--muted);font-family:'Rajdhani',sans-serif;font-size:.6rem;letter-spacing:.14em;padding:7px 14px;cursor:pointer;text-transform:uppercase;transition:all .2s;display:flex;align-items:center;gap:6px}
.btn-hist:hover{border-color:var(--gold-dark);color:var(--gold)}
.hist-count{background:var(--gold-dark);color:#000;font-size:.52rem;font-weight:800;border-radius:10px;padding:1px 6px;line-height:1.4}

/* â”€â”€ HEADER â”€â”€ */
header{text-align:center;padding:28px 20px 20px;position:relative}
.logo-eyebrow{font-size:.52rem;letter-spacing:.45em;color:var(--gold-dark);text-transform:uppercase;margin-bottom:10px;font-family:'Rajdhani',sans-serif;font-weight:600}
.logo-text{font-family:'Cinzel',serif;font-size:clamp(2rem,6vw,3.2rem);letter-spacing:.35em;background:linear-gradient(160deg,var(--gold-dark) 0%,var(--gold-light) 40%,var(--gold) 60%,var(--gold-dark) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;display:inline-block;line-height:1.1;font-weight:900}
.logo-sub{font-size:.6rem;letter-spacing:.2em;color:var(--muted);margin-top:8px;text-transform:uppercase;font-family:'Rajdhani',sans-serif}
.logo-divider{display:flex;align-items:center;gap:16px;margin:16px auto 0;width:fit-content}
.logo-divider-line{width:80px;height:1px;background:linear-gradient(90deg,transparent,var(--gold-dark))}
.logo-divider-line.r{background:linear-gradient(90deg,var(--gold-dark),transparent)}
.logo-divider-diamond{width:6px;height:6px;background:var(--gold);transform:rotate(45deg);flex-shrink:0}
header::after{content:'';display:block;height:1px;background:linear-gradient(90deg,transparent,var(--gold-dark) 20%,var(--gold) 50%,var(--gold-dark) 80%,transparent);margin:18px auto 0;max-width:500px}

.container{max-width:960px;margin:0 auto;padding:22px 16px 80px;position:relative;z-index:1}

/* â”€â”€ CARDS â”€â”€ */
.card{background:var(--card);border:1px solid var(--border);border-radius:6px;padding:22px;margin-bottom:16px;position:relative;overflow:hidden}
.card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--gold-dark),var(--gold),var(--gold-dark),transparent)}
.slabel{font-size:.55rem;letter-spacing:.3em;color:var(--gold);text-transform:uppercase;margin-bottom:14px;display:flex;align-items:center;gap:10px;font-weight:700}
.slabel::after{content:'';flex:1;height:1px;background:linear-gradient(90deg,var(--border),transparent)}

/* â”€â”€ API KEY CARD (colapsÃ¡vel) â”€â”€ */
.apikey-card{background:var(--card);border:1px solid var(--border);border-radius:6px;margin-bottom:16px;overflow:hidden;transition:all .3s;position:relative}
.apikey-card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--gold-dark),var(--gold),var(--gold-dark),transparent)}
.apikey-header{padding:14px 20px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;user-select:none}
.apikey-header:hover .apikey-toggle-icon{color:var(--gold)}
.apikey-header-left{display:flex;align-items:center;gap:10px}
.apikey-header-label{font-size:.55rem;letter-spacing:.3em;color:var(--gold);text-transform:uppercase;font-weight:700}
.apikey-header-status{display:flex;align-items:center;gap:6px;font-size:.58rem;letter-spacing:.08em;text-transform:uppercase}
.apikey-header-status.ok{color:var(--green)}
.apikey-header-status.empty{color:var(--muted)}
.apikey-status-dot{width:6px;height:6px;border-radius:50%;background:currentColor;flex-shrink:0}
.apikey-toggle-icon{font-size:.7rem;color:var(--muted);transition:all .3s;margin-left:8px}
.apikey-body{padding:0 20px 18px;display:none}
.apikey-body.open{display:block}
.apikey-collapsed-row{display:flex;align-items:center;gap:8px}
.apikey-mini-input{flex:1;background:transparent;border:none;color:var(--muted);font-family:'Rajdhani',sans-serif;font-size:13px;outline:none;letter-spacing:.04em;min-width:0}



/* â”€â”€ API KEY â”€â”€ */
.apikey-help{font-size:.66rem;color:var(--muted);line-height:1.6;margin-bottom:9px}
.apikey-help a{color:var(--gold-dark);text-decoration:none}
.apikey-row{display:flex;gap:8px}
.apikey-input{flex:1;background:var(--card2);border:1px solid var(--border);border-radius:3px;color:var(--text);font-family:'Rajdhani',sans-serif;font-size:14px;padding:10px 13px;outline:none;transition:border-color .2s;letter-spacing:.04em}
.apikey-input:focus{border-color:var(--gold-dark)}
.apikey-eye{background:var(--card2);border:1px solid var(--border);border-radius:3px;color:var(--muted);font-size:16px;padding:0 12px;cursor:pointer;transition:all .2s}
.apikey-eye:hover{border-color:var(--gold-dark)}
.apikey-status{font-size:.58rem;letter-spacing:.1em;margin-top:6px;text-transform:uppercase;min-height:16px}
.apikey-status.ok{color:var(--green)}.apikey-status.err{color:var(--red)}
.apikey-note{font-size:.56rem;color:var(--muted);margin-top:4px}

/* â”€â”€ FIELDS â”€â”€ */
label{display:block;font-size:.57rem;letter-spacing:.18em;color:var(--muted);text-transform:uppercase;margin-bottom:4px;margin-top:13px}
label:first-of-type{margin-top:0}
input[type=text],select,textarea{width:100%;background:var(--card2);border:1px solid var(--border);border-radius:3px;color:var(--text);font-family:'Rajdhani',sans-serif;font-size:14px;padding:10px 12px;outline:none;transition:border-color .2s}
input[type=text]:focus,select:focus,textarea:focus{border-color:var(--gold-dark)}
select option{background:#141414}
textarea{resize:vertical;min-height:120px}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
@media(max-width:640px){.grid2,.grid3{grid-template-columns:1fr}}

/* â”€â”€ MODE TOGGLE â”€â”€ */
.mode-toggle{display:flex;border:1px solid #1e1e1e;border-radius:5px;overflow:hidden;margin-bottom:14px;background:var(--card2)}
.mode-btn{flex:1;padding:12px 16px;background:transparent;border:none;color:var(--muted);font-family:'Rajdhani',sans-serif;font-size:.65rem;letter-spacing:.16em;cursor:pointer;transition:all .25s;text-transform:uppercase;font-weight:600;position:relative}
.mode-btn+.mode-btn{border-left:1px solid #1e1e1e}
.mode-btn.active{background:linear-gradient(135deg,rgba(139,105,20,.5),rgba(201,168,76,.2));color:var(--gold-light);border-color:transparent}
.mode-btn.active::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--gold),transparent)}

/* â”€â”€ UPLOAD â”€â”€ */
.upload-zone{display:block;border:2px dashed var(--border);border-radius:5px;padding:26px 16px;text-align:center;cursor:pointer;transition:all .25s;background:var(--card2);user-select:none}
.upload-zone:hover,.upload-zone.drag{border-color:var(--gold-dark);background:rgba(139,105,20,.05)}
.upload-zone.has-file{border-color:var(--gold);border-style:solid;background:rgba(201,168,76,.04)}
.upload-icon{font-size:2rem;display:block;margin-bottom:7px;opacity:.6}
.upload-title{font-size:.75rem;letter-spacing:.12em;color:var(--text);font-weight:600;text-transform:uppercase}
.upload-sub{font-size:.63rem;color:var(--muted);margin-top:3px}
.upload-types{font-size:.56rem;color:var(--gold-dark);margin-top:6px;letter-spacing:.09em;text-transform:uppercase}
.upload-clear{display:none;background:rgba(231,76,60,.1);border:1px solid rgba(231,76,60,.2);color:#e09090;font-size:.57rem;letter-spacing:.1em;padding:4px 11px;border-radius:3px;cursor:pointer;margin-top:8px;text-transform:uppercase;transition:all .2s}
.prog{display:none;margin-top:9px}
.prog-bar{height:3px;background:var(--border);border-radius:2px;overflow:hidden}
.prog-fill{height:100%;background:linear-gradient(90deg,var(--gold-dark),var(--gold));width:0%;transition:width .3s}
.prog-txt{font-size:.57rem;color:var(--muted);margin-top:3px}
.extracted-box{display:none;background:var(--card2);border:1px solid var(--border);border-radius:4px;padding:11px;margin-top:10px}
.extracted-lbl{font-size:.55rem;letter-spacing:.18em;color:var(--gold-dark);text-transform:uppercase;margin-bottom:5px}
.extracted-txt{font-size:11px;color:var(--muted);max-height:80px;overflow-y:auto;white-space:pre-wrap;line-height:1.5}
/* fileInput hidden via inline style display:none */

/* â”€â”€ TONE â”€â”€ */
.tone-group{display:flex;gap:6px;flex-wrap:wrap}
.tone-btn{background:var(--card2);border:1px solid var(--border);border-radius:3px;color:var(--muted);font-family:'Rajdhani',sans-serif;font-size:.57rem;letter-spacing:.15em;padding:6px 11px;cursor:pointer;text-transform:uppercase;transition:all .2s}
.tone-btn:hover{border-color:var(--gold-dark);color:var(--gold-dark)}
.tone-btn.active{background:linear-gradient(135deg,var(--gold-dark),var(--gold));border-color:var(--gold);color:#000;font-weight:700}

/* â”€â”€ TABS ANÃLISE EXTRA â”€â”€ */
.tab-group{display:flex;border-bottom:1px solid var(--border);margin-bottom:14px;gap:2px}
.tab-btn{background:transparent;border:none;border-bottom:2px solid transparent;color:var(--muted);font-family:'Rajdhani',sans-serif;font-size:.6rem;letter-spacing:.15em;padding:8px 14px;cursor:pointer;text-transform:uppercase;transition:all .2s;margin-bottom:-1px}
.tab-btn:hover{color:var(--gold-dark)}
.tab-btn.active{border-bottom-color:var(--gold);color:var(--gold)}
.tab-panel{display:none}
.tab-panel.active{display:block}

/* â”€â”€ PRAZOS â”€â”€ */
.prazo-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:6px}
@media(max-width:600px){.prazo-grid{grid-template-columns:1fr 1fr}}
.prazo-card{background:var(--card2);border:1px solid var(--border);border-radius:4px;padding:10px 12px}
.prazo-nome{font-size:.55rem;letter-spacing:.1em;color:var(--muted);text-transform:uppercase}
.prazo-data{font-size:.85rem;color:var(--gold);font-family:'Cinzel',serif;margin-top:2px}
.prazo-dias{font-size:.58rem;color:var(--muted);margin-top:1px}
.prazo-dias.urgente{color:var(--red)}
.prazo-dias.atencao{color:var(--yellow)}
.prazo-dias.ok{color:var(--green)}

/* â”€â”€ EXEC BUTTON â”€â”€ */
.btn-exec{width:100%;padding:16px;background:linear-gradient(135deg,#6b4f0a,var(--gold),#6b4f0a);border:none;border-radius:4px;font-family:'Cinzel',serif;font-size:.72rem;letter-spacing:.26em;color:#000;font-weight:700;cursor:pointer;transition:all .3s;text-transform:uppercase;margin-top:14px;position:relative;overflow:hidden}
.btn-exec::after{content:'';position:absolute;inset:0;background:linear-gradient(135deg,transparent,rgba(255,255,255,.12),transparent);transform:translateX(-100%);transition:.5s}
.btn-exec:hover::after{transform:translateX(100%)}
.btn-exec:hover{transform:translateY(-1px);box-shadow:0 8px 28px rgba(201,168,76,.22)}
.btn-exec:disabled{opacity:.4;cursor:not-allowed;transform:none}

/* â”€â”€ LOADING â”€â”€ */
.loading{display:none;text-align:center;padding:56px 20px}
.loading.visible{display:block}
.spinner{width:48px;height:48px;margin:0 auto 14px;position:relative}
.spinner::before,.spinner::after{content:'';position:absolute;inset:0;border-radius:50%;border:2px solid transparent}
.spinner::before{border-top-color:var(--gold);animation:spin .9s linear infinite}
.spinner::after{border-bottom-color:var(--gold-dark);animation:spin 1.5s linear infinite reverse;inset:7px}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-title{font-size:.62rem;letter-spacing:.25em;color:var(--muted);text-transform:uppercase}
.loading-step{font-size:.58rem;letter-spacing:.13em;color:var(--gold-dark);margin-top:7px;min-height:18px}
.loading-cache{font-size:.55rem;color:var(--green);margin-top:4px;min-height:16px}

/* â”€â”€ RESULT â”€â”€ */
.result-card{display:none}
.result-card.visible{display:block;animation:fadeUp .5s ease}
@keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}

/* â”€â”€ ANTI-ALUCINAÃ‡ÃƒO REPORT â”€â”€ */
.hal-report{background:linear-gradient(135deg,rgba(46,204,113,.06),rgba(46,204,113,.02));border:1px solid rgba(46,204,113,.2);border-radius:6px;padding:16px 18px;margin-bottom:16px}
.hal-report::before{content:'';display:block;height:1px;background:linear-gradient(90deg,transparent,var(--green),transparent);margin-bottom:12px}
.hal-titulo{font-family:'Cinzel',serif;font-size:.65rem;letter-spacing:.2em;color:var(--green);text-transform:uppercase;margin-bottom:10px}
.hal-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
@media(max-width:500px){.hal-grid{grid-template-columns:1fr 1fr}}
.hal-item{background:rgba(0,0,0,.3);border-radius:4px;padding:8px 10px;text-align:center}
.hal-val{font-family:'Cinzel',serif;font-size:1.4rem;font-weight:700}
.hal-val.ok{color:var(--green)}.hal-val.warn{color:var(--yellow)}.hal-val.bad{color:var(--red)}
.hal-lbl{font-size:.5rem;letter-spacing:.1em;color:var(--muted);text-transform:uppercase;margin-top:2px}
.hal-list{margin-top:10px}
.hal-list-item{display:flex;align-items:flex-start;gap:7px;padding:5px 0;border-bottom:1px solid rgba(255,255,255,.04);font-size:.62rem}
.hal-list-item:last-child{border-bottom:none}
.hal-tag{flex-shrink:0;font-size:.5rem;padding:2px 6px;border-radius:2px;text-transform:uppercase;letter-spacing:.08em;font-weight:700}
.hal-tag.verified{background:rgba(46,204,113,.2);color:var(--green)}
.hal-tag.removed{background:rgba(231,76,60,.2);color:var(--red)}
.hal-tag.warned{background:rgba(243,156,18,.2);color:var(--yellow)}
.hal-sumula-txt{color:var(--muted);line-height:1.4}

/* â”€â”€ RESUMO EXECUTIVO â”€â”€ */
.resumo-exec{background:linear-gradient(135deg,rgba(139,105,20,.1),rgba(201,168,76,.05));border:1px solid rgba(201,168,76,.2);border-radius:6px;padding:18px 20px;margin-bottom:16px}
.resumo-exec::before{content:'';display:block;height:1px;background:linear-gradient(90deg,transparent,var(--gold),transparent);margin-bottom:14px}
.resumo-titulo{font-family:'Cinzel',serif;font-size:.7rem;letter-spacing:.22em;color:var(--gold);text-transform:uppercase;margin-bottom:10px}
.resumo-itens{display:grid;grid-template-columns:1fr 1fr;gap:8px}
@media(max-width:500px){.resumo-itens{grid-template-columns:1fr}}
.resumo-item{background:rgba(0,0,0,.3);border-radius:4px;padding:8px 11px;border-left:2px solid var(--gold-dark)}
.resumo-item-label{font-size:.52rem;letter-spacing:.12em;color:var(--muted);text-transform:uppercase}
.resumo-item-val{font-size:.82rem;color:var(--text);margin-top:2px;font-weight:600}

/* â”€â”€ PROB â”€â”€ */
.prob-grid{display:grid;grid-template-columns:120px 1fr;gap:18px;align-items:start}
@media(max-width:480px){.prob-grid{grid-template-columns:1fr}}
.prob-value{font-family:'Cinzel',serif;font-size:3.4rem;font-weight:900;line-height:1}
.prob-value.high{color:var(--green)}.prob-value.medium{color:var(--yellow)}.prob-value.low{color:var(--red)}
.prob-class{font-size:.64rem;letter-spacing:.14em;text-transform:uppercase;margin-top:3px;font-weight:700}
.prob-bar-track{height:5px;background:var(--card2);border-radius:3px;overflow:hidden;border:1px solid var(--border);margin:12px 0 3px}
.prob-bar-fill{height:100%;border-radius:3px;transition:width 1.2s cubic-bezier(.16,1,.3,1);width:0%}
.prob-bar-fill.high{background:linear-gradient(90deg,#1e8449,var(--green))}.prob-bar-fill.medium{background:linear-gradient(90deg,#b7770d,var(--yellow))}.prob-bar-fill.low{background:linear-gradient(90deg,#922b21,var(--red))}
.score-row{display:flex;align-items:center;gap:9px;margin-bottom:7px}
.score-name{font-size:.55rem;letter-spacing:.09em;color:var(--muted);text-transform:uppercase;width:145px;flex-shrink:0}
.score-mini-bar{flex:1;height:3px;background:var(--card2);border-radius:2px;overflow:hidden}
.score-mini-fill{height:100%;background:linear-gradient(90deg,var(--gold-dark),var(--gold-light));border-radius:2px;transition:width 1.1s ease;width:0%}
.score-pct{font-size:.62rem;color:var(--gold);width:30px;text-align:right;font-family:'Cinzel',serif}

/* â”€â”€ AI TEXT â”€â”€ */
.ai-text{font-size:13px;line-height:1.9;color:#a09880;white-space:pre-wrap;font-family:'Rajdhani',sans-serif}

/* â”€â”€ CONFIANÃ‡A POR SEÃ‡ÃƒO â”€â”€ */
.sec-confianca{display:inline-flex;align-items:center;gap:4px;font-size:.5rem;letter-spacing:.08em;padding:2px 7px;border-radius:10px;text-transform:uppercase;font-weight:700;margin-left:8px;vertical-align:middle}
.sec-confianca.alta{background:rgba(46,204,113,.15);color:var(--green);border:1px solid rgba(46,204,113,.3)}
.sec-confianca.media{background:rgba(243,156,18,.15);color:var(--yellow);border:1px solid rgba(243,156,18,.3)}
.sec-confianca.baixa{background:rgba(231,76,60,.15);color:var(--red);border:1px solid rgba(231,76,60,.3)}

/* â”€â”€ SEÃ‡Ã•ES RENDERIZADAS â”€â”€ */
.secao-bloco{margin-bottom:22px}
.secao-titulo{font-family:'Cinzel',serif;font-size:.72rem;letter-spacing:.18em;color:var(--gold);text-transform:uppercase;padding-bottom:6px;border-bottom:1px solid rgba(201,168,76,.15);margin-bottom:10px;display:flex;align-items:center;gap:6px}
.secao-corpo{font-size:13px;line-height:1.9;color:#a09880}
.secao-corpo .bullet-item{display:flex;align-items:flex-start;gap:6px;padding:3px 0;border-left:2px solid rgba(201,168,76,.12);padding-left:8px;margin-bottom:3px}
.secao-corpo .bullet-icon{flex-shrink:0;font-size:.9rem}
.secao-corpo .bullet-txt{flex:1}

/* â”€â”€ PETIÃ‡ÃƒO RÃPIDA â”€â”€ */
.peticao-wrap{margin-top:6px}
.peticao-tipo-group{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px}
.peticao-tipo-btn{background:var(--card2);border:1px solid var(--border);border-radius:3px;color:var(--muted);font-family:'Rajdhani',sans-serif;font-size:.57rem;letter-spacing:.12em;padding:6px 12px;cursor:pointer;text-transform:uppercase;transition:all .2s}
.peticao-tipo-btn:hover{border-color:var(--gold-dark);color:var(--gold-dark)}
.peticao-tipo-btn.active{background:linear-gradient(135deg,var(--gold-dark),var(--gold));border-color:var(--gold);color:#000;font-weight:700}
.btn-gerar-peticao{width:100%;padding:12px;background:linear-gradient(135deg,rgba(52,152,219,.15),rgba(52,152,219,.08));border:1px solid rgba(52,152,219,.35);border-radius:4px;font-family:'Cinzel',serif;font-size:.65rem;letter-spacing:.2em;color:#5dade2;font-weight:700;cursor:pointer;transition:all .2s;text-transform:uppercase}
.btn-gerar-peticao:hover{border-color:#3498db;transform:translateY(-1px)}
.btn-gerar-peticao:disabled{opacity:.4;cursor:not-allowed;transform:none}
.peticao-output{display:none;margin-top:14px;background:var(--card2);border:1px solid var(--border);border-radius:4px;padding:16px}
.peticao-output.visible{display:block}
.peticao-texto{font-size:12.5px;color:#a09880;white-space:pre-wrap;line-height:1.85;max-height:400px;overflow-y:auto}
.btn-copiar-peticao{margin-top:10px;width:100%;padding:10px;background:transparent;border:1px solid var(--border);border-radius:3px;color:var(--muted);font-family:'Rajdhani',sans-serif;font-size:.6rem;letter-spacing:.15em;cursor:pointer;text-transform:uppercase;transition:all .2s}
.btn-copiar-peticao:hover{border-color:var(--gold-dark);color:var(--gold)}
.btn-copiar-peticao.ok{border-color:var(--green);color:var(--green)}

/* â”€â”€ BUSCA BANCO SÃšMULAS â”€â”€ */
.sumula-search-panel{display:none;position:fixed;top:0;left:50%;transform:translateX(-50%);width:600px;max-width:95vw;background:#0c0c0c;border:1px solid var(--border);border-radius:8px;box-shadow:0 20px 60px rgba(0,0,0,.8);z-index:900;padding:20px;margin-top:60px}
.sumula-search-panel.open{display:block;animation:fadeUp .2s ease}
.sumula-search-input{width:100%;background:var(--card2);border:1px solid var(--border);border-radius:3px;color:var(--text);font-family:'Rajdhani',sans-serif;font-size:14px;padding:10px 12px;outline:none;margin-bottom:10px;transition:border-color .2s}
.sumula-search-input:focus{border-color:var(--gold-dark)}
.sumula-results{max-height:320px;overflow-y:auto}
.sumula-result-item{background:var(--card);border:1px solid var(--border);border-radius:4px;padding:10px 12px;margin-bottom:7px;cursor:pointer;transition:all .2s}
.sumula-result-item:hover{border-color:var(--gold-dark);background:rgba(139,105,20,.07)}
.sumula-result-numero{font-size:.65rem;font-weight:700;color:var(--gold);letter-spacing:.08em}
.sumula-result-txt{font-size:11.5px;color:var(--muted);margin-top:3px;line-height:1.5}
.sumula-search-close{position:absolute;top:12px;right:16px;background:transparent;border:1px solid var(--border);border-radius:3px;color:var(--muted);font-size:14px;width:26px;height:26px;cursor:pointer;transition:all .2s}
.sumula-search-close:hover{border-color:var(--red);color:var(--red)}
.sumula-empty{text-align:center;color:var(--muted);font-size:.65rem;padding:20px}

/* â”€â”€ CHAT â”€â”€ */
.chat-wrap{margin-top:6px}
.chat-messages{max-height:380px;overflow-y:auto;margin-bottom:12px;display:flex;flex-direction:column;gap:10px;padding-right:4px}
.chat-msg{border-radius:5px;padding:11px 14px;font-size:13px;line-height:1.75;max-width:92%}
.chat-msg.user{background:rgba(139,105,20,.15);border:1px solid rgba(139,105,20,.25);color:var(--text);align-self:flex-end}
.chat-msg.ai{background:var(--card2);border:1px solid var(--border);color:#a09880;align-self:flex-start;white-space:pre-wrap}
.chat-msg.ai.loading-msg{color:var(--muted);font-style:italic}
.chat-input-row{display:flex;gap:8px}
.chat-input{flex:1;background:var(--card2);border:1px solid var(--border);border-radius:3px;color:var(--text);font-family:'Rajdhani',sans-serif;font-size:14px;padding:10px 12px;outline:none;transition:border-color .2s;resize:none;min-height:44px;max-height:120px}
.chat-input:focus{border-color:var(--gold-dark)}
.btn-chat-send{background:linear-gradient(135deg,var(--gold-dark),var(--gold));border:none;border-radius:3px;color:#000;font-family:'Cinzel',serif;font-size:.6rem;letter-spacing:.15em;font-weight:700;padding:0 18px;cursor:pointer;transition:all .2s;flex-shrink:0}
.btn-chat-send:hover{transform:translateY(-1px);box-shadow:0 4px 14px rgba(201,168,76,.2)}
.btn-chat-send:disabled{opacity:.4;cursor:not-allowed;transform:none}
.chat-sugest{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px}
.chat-sugest-btn{background:var(--card2);border:1px solid var(--border);border-radius:3px;color:var(--muted);font-family:'Rajdhani',sans-serif;font-size:.57rem;letter-spacing:.1em;padding:5px 10px;cursor:pointer;text-transform:uppercase;transition:all .2s;white-space:nowrap}
.chat-sugest-btn:hover{border-color:var(--gold-dark);color:var(--gold-dark)}

/* â”€â”€ DOWNLOAD â”€â”€ */
.dl-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
@media(max-width:480px){.dl-grid{grid-template-columns:1fr}}
.btn-dl{width:100%;padding:13px;border:none;border-radius:4px;font-family:'Cinzel',serif;font-size:.62rem;letter-spacing:.15em;font-weight:700;cursor:pointer;transition:all .3s;text-transform:uppercase;display:flex;align-items:center;justify-content:center;gap:7px}
.btn-dl.word{background:linear-gradient(135deg,#0f2a52,#1a4a8a);color:#fff;border:1px solid #1a4a8a}
.btn-dl.pdf{background:linear-gradient(135deg,#4a0f0f,#8a1a1a);color:#fff;border:1px solid #8a1a1a}
.btn-dl:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,.4)}
.btn-dl:disabled{opacity:.4;cursor:not-allowed;transform:none}
.dl-status{font-size:.58rem;letter-spacing:.09em;color:var(--muted);text-align:center;padding:6px 0 0;min-height:20px;text-transform:uppercase}

/* â”€â”€ HISTÃ“RICO â”€â”€ */
.hist-panel{display:none;position:fixed;top:0;right:0;width:360px;max-width:95vw;height:100vh;background:#0c0c0c;border-left:1px solid var(--border);z-index:900;flex-direction:column;animation:slideIn .25s ease}
.hist-panel.open{display:flex}
@keyframes slideIn{from{transform:translateX(100%)}to{transform:translateX(0)}}
.hist-header{padding:16px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.hist-title{font-family:'Cinzel',serif;font-size:.72rem;letter-spacing:.2em;color:var(--gold);text-transform:uppercase}
.hist-close{background:transparent;border:1px solid var(--border);border-radius:3px;color:var(--muted);font-size:16px;width:30px;height:30px;cursor:pointer;transition:all .2s}
.hist-close:hover{border-color:var(--red);color:var(--red)}
.hist-list{flex:1;overflow-y:auto;padding:12px}
.hist-item{background:var(--card);border:1px solid var(--border);border-radius:4px;padding:12px;margin-bottom:9px;cursor:pointer;transition:all .2s}
.hist-item:hover{border-color:var(--gold-dark);background:rgba(139,105,20,.07)}
.hist-item-titulo{font-size:.7rem;font-weight:600;color:var(--text);margin-bottom:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.hist-item-meta{font-size:.58rem;color:var(--muted);display:flex;gap:10px}
.hist-item-prob{font-family:'Cinzel',serif;font-size:.8rem}
.hist-item-prob.high{color:var(--green)}.hist-item-prob.medium{color:var(--yellow)}.hist-item-prob.low{color:var(--red)}
.hist-empty{text-align:center;color:var(--muted);font-size:.68rem;padding:40px 20px}
.hist-footer{padding:12px 16px;border-top:1px solid var(--border);flex-shrink:0}
.btn-hist-clear{width:100%;padding:9px;background:transparent;border:1px solid rgba(231,76,60,.25);border-radius:3px;color:rgba(231,76,60,.6);font-family:'Rajdhani',sans-serif;font-size:.6rem;letter-spacing:.15em;cursor:pointer;text-transform:uppercase;transition:all .2s}
.btn-hist-clear:hover{border-color:var(--red);color:var(--red)}
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:800}
.overlay.open{display:block}

/* â”€â”€ CHECKLIST â”€â”€ */
.checklist{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:8px}
@media(max-width:500px){.checklist{grid-template-columns:1fr}}
.check-item{display:flex;align-items:center;gap:8px;background:var(--card2);border:1px solid var(--border);border-radius:3px;padding:8px 10px;cursor:pointer;transition:all .2s;user-select:none}
.check-item:hover{border-color:var(--gold-dark)}
.check-item.checked{border-color:rgba(46,204,113,.4);background:rgba(46,204,113,.05)}
.check-box{width:14px;height:14px;border:1px solid var(--border);border-radius:2px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:10px;transition:all .2s}
.check-item.checked .check-box{background:var(--green);border-color:var(--green);color:#000}
.check-label{font-size:.62rem;color:var(--muted);letter-spacing:.06em;transition:color .2s}
.check-item.checked .check-label{color:var(--text)}
.check-progress{height:3px;background:var(--border);border-radius:2px;margin-top:10px;overflow:hidden}
.check-progress-fill{height:100%;background:linear-gradient(90deg,var(--gold-dark),var(--green));border-radius:2px;transition:width .4s ease}
.check-status{font-size:.58rem;color:var(--muted);margin-top:4px}

/* â”€â”€ PRAZOS CALC â”€â”€ */
.prazo-input-row{display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap}
.prazo-input-row > div{flex:1;min-width:130px}
.btn-calc-prazo{background:linear-gradient(135deg,var(--gold-dark),rgba(201,168,76,.5));border:none;border-radius:3px;color:#000;font-family:'Cinzel',serif;font-size:.58rem;letter-spacing:.14em;font-weight:700;padding:10px 16px;cursor:pointer;white-space:nowrap;transition:all .2s}
.btn-calc-prazo:hover{transform:translateY(-1px)}
.prazo-resultado{display:none;margin-top:12px}

/* â”€â”€ NOVA ANÃLISE â”€â”€ */
.btn-nova{width:100%;padding:11px;background:transparent;border:1px solid var(--border);border-radius:4px;font-family:'Rajdhani',sans-serif;font-size:.64rem;letter-spacing:.26em;color:var(--muted);cursor:pointer;text-transform:uppercase;transition:all .2s;margin-top:4px}
.btn-nova:hover{border-color:var(--gold-dark);color:var(--gold)}

/* â”€â”€ DISC â”€â”€ */
.disc{background:rgba(201,168,76,.03);border:1px solid rgba(201,168,76,.08);border-radius:4px;padding:10px 13px;margin-bottom:14px;font-size:.65rem;color:var(--muted);line-height:1.6}
.disc strong{color:var(--gold-dark)}
.chars{font-size:.57rem;color:var(--muted);text-align:right;margin-top:3px}
.chars span{color:var(--gold-dark)}
.hidden{display:none!important}

/* â”€â”€ COPY PROMPT â”€â”€ */
.copy-prompt-card{background:linear-gradient(135deg,rgba(139,105,20,.07),rgba(201,168,76,.03));border:1px solid rgba(201,168,76,.2);border-radius:6px;padding:18px;margin-bottom:16px;position:relative}
.copy-prompt-card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--gold),transparent)}
.prompt-preview{background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:12px;font-size:11px;color:var(--muted);white-space:pre-wrap;max-height:180px;overflow-y:auto;line-height:1.65;font-family:'Rajdhani',sans-serif;margin:10px 0}
.btn-copy{width:100%;padding:13px;background:linear-gradient(135deg,rgba(201,168,76,.13),rgba(201,168,76,.06));border:1px solid var(--gold-dark);border-radius:4px;font-family:'Cinzel',serif;font-size:.68rem;letter-spacing:.2em;color:var(--gold-light);font-weight:700;cursor:pointer;transition:all .3s;text-transform:uppercase;display:flex;align-items:center;justify-content:center;gap:9px}
.btn-copy:hover{border-color:var(--gold);transform:translateY(-1px)}
.btn-copy.copied{background:linear-gradient(135deg,rgba(46,204,113,.13),rgba(46,204,113,.06));border-color:var(--green);color:var(--green)}
.copy-hint{font-size:.58rem;color:var(--muted);text-align:center;margin-top:7px}

/* â”€â”€ SÃšMULAS VERIFICADAS â”€â”€ */
.juris-vivo{background:linear-gradient(135deg,rgba(52,152,219,.08),rgba(52,152,219,.03));border:1px solid rgba(52,152,219,.25);border-radius:6px;padding:18px;margin-bottom:16px;position:relative}
.juris-vivo::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,#3498db,transparent)}
.juris-vivo-txt{font-size:12.5px;color:#8ab4c8;line-height:1.85;white-space:pre-wrap;max-height:220px;overflow-y:auto;margin-top:10px;padding:10px;background:rgba(0,0,0,.25);border-radius:4px;border:1px solid rgba(52,152,219,.1)}
.live-dot{width:7px;height:7px;background:var(--red);border-radius:50%;display:inline-block;animation:pulse 1.2s infinite}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(.8)}}
</style>
</head>
<body>

<!-- TOPBAR -->
<div class="topbar">
  <div class="topbar-logo">V9 PRO</div>
  <div class="topbar-center">
    <div class="topbar-pill active"><span class="topbar-pill-dot"></span>Anti-AlucinaÃ§Ã£o</div>
    <div class="topbar-pill gold"><span class="topbar-pill-dot"></span>SÃºmulas STFÂ·STJÂ·TST</div>
    <div class="topbar-pill gold"><span class="topbar-pill-dot"></span>Word &amp; PDF</div>
  </div>
  <div class="topbar-actions">
    <button class="btn-hist" onclick="toggleHist()">
      ğŸ“‹ HistÃ³rico <span class="hist-count" id="histCount">0</span>
    </button>
  </div>
</div>

<!-- HISTÃ“RICO PAINEL -->
<div class="overlay" id="overlay" onclick="toggleHist()"></div>
<div class="hist-panel" id="histPanel">
  <div class="hist-header">
    <div class="hist-title">â—ˆ AnÃ¡lises Salvas</div>
    <button class="hist-close" onclick="toggleHist()">âœ•</button>
  </div>
  <div class="hist-list" id="histList"></div>
  <div class="hist-footer">
    <button class="btn-hist-clear" onclick="limparHistorico()">ğŸ—‘ Limpar HistÃ³rico</button>
  </div>
</div>

<header>
  <div class="logo-eyebrow">Plataforma JurÃ­dica Profissional</div>
  <div class="logo-text">V9 POWER EDITION</div>
  <div class="logo-sub">AnÃ¡lise Â· EstratÃ©gia Â· PetiÃ§Ãµes Â· Prazos Â· Zero AlucinaÃ§Ã£o</div>
  <div class="logo-divider">
    <div class="logo-divider-line"></div>
    <div class="logo-divider-diamond"></div>
    <div class="logo-divider-line r"></div>
  </div>
</header>

<div class="container">

<!-- API KEY â€” COLAPSÃVEL -->
<div class="apikey-card" id="apikeyCard">
  <div class="apikey-header" onclick="toggleApiCard()">
    <div class="apikey-header-left">
      <span style="font-size:1rem">ğŸ”‘</span>
      <span class="apikey-header-label">Chave de API Gemini</span>
      <div class="apikey-header-status empty" id="apikeyHeaderStatus">
        <span class="apikey-status-dot"></span>
        <span id="apikeyHeaderTxt">NÃ£o configurada</span>
      </div>
    </div>
    <span class="apikey-toggle-icon" id="apikeyToggleIcon">â–¼</span>
  </div>
  <div class="apikey-body open" id="apikeyBody">
    <div class="apikey-help">
      GrÃ¡tis em <a href="https://aistudio.google.com/app/apikey" target="_blank">aistudio.google.com</a>
      â†’ Get API Key â†’ Create API key. Salva automaticamente no seu navegador.
    </div>
    <div class="apikey-row">
      <input class="apikey-input" id="apiKeyInput" type="password" placeholder="AIza..." oninput="checkKey()" autocomplete="off" spellcheck="false"/>
      <button class="apikey-eye" id="apiKeyEye" onclick="toggleEye()">ğŸ‘</button>
    </div>
    <div class="apikey-status" id="apiKeyStatus"></div>
    <div class="apikey-note">ğŸ”’ Sua chave fica salva sÃ³ no seu navegador â€” nunca sai do dispositivo.</div>
  </div>
</div>

<!-- FORMULÃRIO -->
<div class="card" id="inputCard">
  <div class="slabel">â—ˆ IdentificaÃ§Ã£o do Caso</div>
  <div class="grid2">
    <div>
      <label>Cliente / Representado</label>
      <input type="text" id="nomeCliente" placeholder="Nome do cliente..."/>
    </div>
    <div>
      <label>NÂº do Processo <small style="color:var(--muted)">(opcional)</small></label>
      <input type="text" id="numProcesso" placeholder="0000000-00.0000.0.00.0000"/>
    </div>
  </div>

  <div class="slabel" style="margin-top:20px">â—ˆ Modo de AnÃ¡lise</div>
  <div class="mode-toggle">
    <button class="mode-btn active" id="modeUploadBtn" onclick="setMode('upload')">ğŸ“ Anexar Documento</button>
    <button class="mode-btn" id="modeManualBtn" onclick="setMode('manual')">âœï¸ Digitar Dados</button>
  </div>

  <!-- UPLOAD -->
  <div id="uploadSection">
    <label class="upload-zone" id="uploadZone" for="fileInput" ondragover="dragOver(event)" ondragleave="dragLeave(event)" ondrop="dropFile(event)">
      <span class="upload-icon" id="uploadIcon">ğŸ“„</span>
      <div class="upload-title" id="uploadTitle">Clique aqui ou arraste o arquivo</div>
      <div class="upload-sub" id="uploadSub">Contrato, PetiÃ§Ã£o, SentenÃ§a, NotificaÃ§Ã£o, Laudo...</div>
      <div class="upload-types" id="uploadTypes">PDF Â· Word (.docx) Â· Imagem (JPG/PNG) Â· TXT Â· AtÃ© 150MB</div>
      <button class="upload-clear" id="uploadClear" onclick="clearFile(event)" type="button">âœ• Remover</button>
    </label>
    <input type="file" id="fileInput" accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.webp" onchange="handleFile(this.files[0])" style="display:none">
    <div class="prog" id="prog">
      <div class="prog-bar"><div class="prog-fill" id="progFill"></div></div>
      <div class="prog-txt" id="progTxt"></div>
    </div>
    <div class="extracted-box" id="extractedBox">
      <div class="extracted-lbl">â—ˆ ConteÃºdo ExtraÃ­do</div>
      <div class="extracted-txt" id="extractedTxt"></div>
    </div>
    <label style="margin-top:13px">InstruÃ§Ãµes Adicionais <small style="color:var(--muted)">(opcional)</small></label>
    <textarea id="extraContext" style="min-height:65px" placeholder="Ex: Foque na clÃ¡usula de multa. Analise o risco para o credor..."></textarea>
  </div>

  <!-- MANUAL -->
  <div id="manualSection" class="hidden">
    <div class="grid2">
      <div>
        <label>Ãrea do Direito *</label>
        <select id="areaDir">
          <option value="">Selecione...</option>
          <option>Direito Trabalhista</option><option>Direito Civil</option>
          <option>Direito do Consumidor</option><option>Direito PrevidenciÃ¡rio</option>
          <option>Direito de FamÃ­lia</option><option>Direito TributÃ¡rio</option>
          <option>Direito Empresarial</option><option>Direito Penal</option>
          <option>Direito Administrativo</option><option>Direito Ambiental</option>
          <option>Direito BancÃ¡rio</option><option>Direito Digital</option>
          <option>Direito ImobiliÃ¡rio</option><option>Direito MÃ©dico</option>
        </select>
      </div>
      <div>
        <label>Tipo de AÃ§Ã£o / PeÃ§a</label>
        <input type="text" id="tipoAcao" placeholder="Ex: ReclamaÃ§Ã£o Trabalhista..."/>
      </div>
    </div>
    <div class="grid2">
      <div>
        <label>Polo Ativo (Autor)</label>
        <input type="text" id="autor" placeholder="Ex: Empregado, Consumidor..."/>
      </div>
      <div>
        <label>Polo Passivo (RÃ©u)</label>
        <input type="text" id="reu" placeholder="Ex: Empresa XYZ, Banco..."/>
      </div>
    </div>
    <label>Pedidos Principais</label>
    <input type="text" id="pedidos" placeholder="Ex: Horas extras, danos morais, FGTS..."/>
    <div class="grid2">
      <div>
        <label>Tribunal / InstÃ¢ncia</label>
        <select id="tribunal">
          <option value="">Selecione...</option>
          <option>1Âª InstÃ¢ncia â€“ Vara do Trabalho</option>
          <option>1Âª InstÃ¢ncia â€“ Vara CÃ­vel</option>
          <option>TRT (Tribunal Regional do Trabalho)</option>
          <option>TJ (Tribunal de JustiÃ§a Estadual)</option>
          <option>TST (Tribunal Superior do Trabalho)</option>
          <option>STJ (Superior Tribunal de JustiÃ§a)</option>
          <option>STF (Supremo Tribunal Federal)</option>
        </select>
      </div>
      <div>
        <label>Valor Est. da Causa (R$)</label>
        <input type="text" id="valorCausa" placeholder="Ex: 50.000,00"/>
      </div>
    </div>
    <label>Fatos, Provas e Argumentos *</label>
    <textarea id="fatos" placeholder="Descreva os fatos, provas disponÃ­veis, documentos, histÃ³rico do caso..."></textarea>
    <div class="chars"><span id="charsCount">0</span> caracteres</div>
  </div>

  <!-- TOM -->
  <label style="margin-top:16px">Tom da AnÃ¡lise</label>
  <div class="tone-group">
    <button class="tone-btn active" data-tone="imparcial">Imparcial</button>
    <button class="tone-btn" data-tone="favoravel">FavorÃ¡vel ao Autor</button>
    <button class="tone-btn" data-tone="defensivo">Defensivo ao RÃ©u</button>
    <button class="tone-btn" data-tone="estrategico">EstratÃ©gico</button>
  </div>

  <button class="btn-exec" id="btnExec" onclick="executar()">
    âš– EXECUTAR ANÃLISE JURÃDICA V9 PRO
  </button>
</div>

<!-- LOADING -->
<div class="loading" id="loading">
  <div class="spinner"></div>
  <p class="loading-title">Executando AnÃ¡lise V9 Pro</p>
  <p class="loading-step" id="loadingStep">Inicializando...</p>
  <p class="loading-cache" id="loadingCache"></p>
</div>

<!-- RESULTADO -->
<div class="result-card" id="resultCard">

  <!-- SÃšMULAS VERIFICADAS -->
  <div class="juris-vivo" id="jurisVivoCard" style="display:none">
    <div class="slabel">âœ… SÃºmulas Verificadas â€” Banco Oficial</div>
    <div style="margin-bottom:8px;font-size:.62rem;color:var(--muted)">
      SÃºmulas selecionadas do banco verificado (STF Â· STJ Â· TST Â· TNU). A anÃ¡lise usa <strong style="color:var(--gold-dark)">APENAS</strong> estas.
    </div>
    <div id="jurisVivoTxt"></div>
  </div>

  <!-- ANTI-ALUCINAÃ‡ÃƒO REPORT -->
  <div class="hal-report" id="halReport" style="display:none">
    <div class="hal-titulo">ğŸ›¡ RelatÃ³rio Anti-AlucinaÃ§Ã£o</div>
    <div class="hal-grid" id="halGrid"></div>
    <div class="hal-list" id="halList"></div>
  </div>

  <!-- RESUMO EXECUTIVO -->
  <div class="resumo-exec" id="resumoExec">
    <div class="resumo-titulo">â—ˆ Resumo Executivo</div>
    <div class="resumo-itens" id="resumoItens"></div>
  </div>

  <!-- PROBABILIDADE -->
  <div class="card">
    <div class="slabel">â—ˆ Probabilidade de ÃŠxito</div>
    <div class="prob-grid">
      <div>
        <div style="font-size:.52rem;letter-spacing:.18em;color:var(--muted);text-transform:uppercase;margin-bottom:3px">Estimativa Global</div>
        <div class="prob-value" id="probValue">â€”</div>
        <div class="prob-class" id="probClass"></div>
      </div>
      <div>
        <div class="prob-bar-track"><div class="prob-bar-fill" id="probBar"></div></div>
        <div id="scoreBreakdown"></div>
      </div>
    </div>
    <div style="margin-top:9px;font-size:.57rem;color:var(--muted)">* Estimativa analÃ­tica. NÃ£o garante resultado processual.</div>
  </div>

  <!-- ANÃLISE COM ABAS -->
  <div class="card">
    <div class="slabel">â—ˆ AnÃ¡lise JurÃ­dica Completa</div>
    <div class="tab-group" id="tabGroup">
      <button class="tab-btn active" onclick="setTab('completa',this)">AnÃ¡lise Completa</button>
      <button class="tab-btn" onclick="setTab('fortes',this)">Pontos Fortes</button>
      <button class="tab-btn" onclick="setTab('riscos',this)">Riscos</button>
      <button class="tab-btn" onclick="setTab('sumulas',this)">SÃºmulas/Leis</button>
      <button class="tab-btn" onclick="setTab('estrategia',this)">EstratÃ©gia</button>
    </div>
    <div id="tabCompleta" class="tab-panel active">
      <div id="aiText" class="ai-text"></div>
    </div>
    <div id="tabFortes" class="tab-panel">
      <div id="secFortes" class="secao-bloco"></div>
    </div>
    <div id="tabRiscos" class="tab-panel">
      <div id="secRiscos" class="secao-bloco"></div>
    </div>
    <div id="tabSumulas" class="tab-panel">
      <div id="secSumulas" class="secao-bloco"></div>
    </div>
    <div id="tabEstrategia" class="tab-panel">
      <div id="secEstrategia" class="secao-bloco"></div>
    </div>
  </div>

  <!-- GERAÃ‡ÃƒO DE PETIÃ‡ÃƒO -->
  <div class="card">
    <div class="slabel">ğŸ“ GeraÃ§Ã£o de PeÃ§a Processual</div>
    <p style="font-size:12px;color:var(--muted);margin-bottom:10px">Gere uma peÃ§a processual baseada nos dados jÃ¡ analisados. Sem custo adicional de API.</p>
    <div class="peticao-wrap">
      <div class="peticao-tipo-group">
        <button class="peticao-tipo-btn active" data-peca="inicial">PetiÃ§Ã£o Inicial</button>
        <button class="peticao-tipo-btn" data-peca="contestacao">ContestaÃ§Ã£o</button>
        <button class="peticao-tipo-btn" data-peca="recurso">Recurso OrdinÃ¡rio</button>
        <button class="peticao-tipo-btn" data-peca="acordo">Proposta de Acordo</button>
        <button class="peticao-tipo-btn" data-peca="notificacao">NotificaÃ§Ã£o Extrajudicial</button>
      </div>
      <button class="btn-gerar-peticao" id="btnGerarPeticao" onclick="gerarPeticao()">
        ğŸ“ GERAR PEÃ‡A AGORA
      </button>
      <div class="peticao-output" id="peticaoOutput">
        <div class="slabel" style="margin-bottom:8px">â—ˆ PeÃ§a Gerada</div>
        <div class="peticao-texto" id="peticaoTexto"></div>
        <button class="btn-copiar-peticao" id="btnCopiarPeticao" onclick="copiarPeticao()">ğŸ“‹ COPIAR PEÃ‡A</button>
      </div>
    </div>
  </div>

  <!-- CHAT COM IA -->
  <div class="card">
    <div class="slabel">ğŸ’¬ Chat com a IA sobre este Caso</div>
    <p style="font-size:12px;color:var(--muted);margin-bottom:10px">FaÃ§a perguntas especÃ­ficas sobre o caso analisado. A IA tem todo o contexto.</p>
    <div class="chat-sugest" id="chatSugest">
      <button class="chat-sugest-btn" onclick="chatSugest(this)">Qual a melhor estratÃ©gia para acordo?</button>
      <button class="chat-sugest-btn" onclick="chatSugest(this)">Quais provas sÃ£o indispensÃ¡veis?</button>
      <button class="chat-sugest-btn" onclick="chatSugest(this)">Qual o risco de perder?</button>
      <button class="chat-sugest-btn" onclick="chatSugest(this)">Estime os honorÃ¡rios advocatÃ­cios</button>
      <button class="chat-sugest-btn" onclick="chatSugest(this)">HÃ¡ prescriÃ§Ã£o ou decadÃªncia?</button>
    </div>
    <div class="chat-wrap">
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input-row">
        <textarea class="chat-input" id="chatInput" placeholder="Pergunte algo sobre o caso..." rows="1" onkeydown="chatKeydown(event)"></textarea>
        <button class="btn-chat-send" id="btnChatSend" onclick="enviarChat()">ENVIAR</button>
      </div>
    </div>
  </div>

  <!-- DOWNLOAD -->
  <div class="card">
    <div class="slabel">â—ˆ Download do Documento</div>
    <p style="font-size:12px;color:var(--muted);margin-bottom:2px">Documento profissional com capa, anÃ¡lise completa, fundamentaÃ§Ã£o e estratÃ©gia.</p>
    <div class="dl-grid">
      <button class="btn-dl word" id="btnWord" onclick="dlWord()">ğŸ“„ Baixar Word (.docx)</button>
      <button class="btn-dl pdf" id="btnPdf" onclick="dlPDF()">ğŸ“• Baixar PDF</button>
    </div>
    <div class="dl-status" id="dlStatus"></div>
  </div>

  <!-- COPIAR PROMPT -->
  <div class="copy-prompt-card">
    <div class="slabel">ğŸ“‹ Prompt para Outra IA</div>
    <p style="font-size:12px;color:var(--muted);margin-bottom:4px">Prompt completo para aprofundar a anÃ¡lise no ChatGPT, Claude ou outra IA.</p>
    <div class="prompt-preview" id="promptPreview"></div>
    <button class="btn-copy" id="btnCopy" onclick="copyPrompt()">ğŸ“‹ COPIAR PROMPT COMPLETO</button>
    <div class="copy-hint" id="copyHint">Cole no ChatGPT, Gemini, Claude ou qualquer IA para continuar</div>
  </div>

  <button class="btn-nova" onclick="reset()">â† NOVA ANÃLISE</button>
</div>

<!-- FERRAMENTAS AUXILIARES -->
<div style="margin-top:8px">
<!-- CALCULADORA DE PRAZOS -->
<div class="card" id="prazoCard">
  <div class="slabel">â± Calculadora de Prazos Processuais</div>
  <div class="prazo-input-row">
    <div>
      <label>Data do Ato / IntimaÃ§Ã£o</label>
      <input type="text" id="prazoDataAto" placeholder="DD/MM/AAAA" maxlength="10" oninput="maskData(this)"/>
    </div>
    <div>
      <label>Tipo de Prazo</label>
      <select id="prazoTipo">
        <option value="15">ContestaÃ§Ã£o â€“ 15 dias (CÃ­vel)</option>
        <option value="30">ReclamaÃ§Ã£o Trabalhista â€“ 30 dias</option>
        <option value="5">Embargos de DeclaraÃ§Ã£o â€“ 5 dias</option>
        <option value="15">ApelaÃ§Ã£o â€“ 15 dias</option>
        <option value="8">Recurso OrdinÃ¡rio Trabalhista â€“ 8 dias</option>
        <option value="15">Agravo de Instrumento â€“ 15 dias</option>
        <option value="15">Recurso Especial/ExtraordinÃ¡rio â€“ 15 dias</option>
        <option value="120">Mandado de SeguranÃ§a â€“ 120 dias</option>
        <option value="2">Embargos de DeclaraÃ§Ã£o Trabalhista â€“ 2 dias</option>
        <option value="custom">Personalizado...</option>
      </select>
    </div>
    <div id="prazoCustomDiv" class="hidden">
      <label>Dias</label>
      <input type="text" id="prazoCustomDias" placeholder="Ex: 10"/>
    </div>
    <button class="btn-calc-prazo" onclick="calcularPrazo()">Calcular</button>
  </div>
  <div class="prazo-resultado" id="prazoResultado"></div>
</div>

<!-- CHECKLIST DE DOCUMENTOS -->
<div class="card" id="checklistCard">
  <div class="slabel">ğŸ“‹ Checklist de Documentos</div>
  <div class="grid2" style="margin-bottom:10px">
    <div>
      <label>Tipo de AÃ§Ã£o para Checklist</label>
      <select id="checklistTipo" onchange="gerarChecklist()">
        <option value="">Selecione para gerar...</option>
        <option value="trabalhista">ReclamaÃ§Ã£o Trabalhista</option>
        <option value="indenizacao">AÃ§Ã£o de IndenizaÃ§Ã£o</option>
        <option value="consumidor">Direito do Consumidor</option>
        <option value="previdenciario">PrevidenciÃ¡rio / INSS</option>
        <option value="familia">Direito de FamÃ­lia</option>
        <option value="cobranca">AÃ§Ã£o de CobranÃ§a</option>
        <option value="contrato">RevisÃ£o de Contrato</option>
      </select>
    </div>
  </div>
  <div id="checklistArea"></div>
</div>

</div>

</div><!-- /container -->

<script>
'use strict';

// â”€â”€ SHOW/HIDE DE VIEWS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showView(view){
  // 'form' = formulÃ¡rio, 'loading' = carregando, 'result' = resultado
  const inputCard = document.getElementById('inputCard');
  const loading   = document.getElementById('loading');
  const resultCard= document.getElementById('resultCard');
  inputCard.style.display   = view==='form'    ? 'block' : 'none';
  loading.classList.toggle('visible', view==='loading');
  resultCard.classList.toggle('visible', view==='result');
}

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentMode = 'upload';
let uploadedFile = null;
let extractedContent = '';
let extractedBase64 = '';
let extractedMime = '';
let analysisData = null;
let chatHistory = [];
let chatHistoryCompressed = false;

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', () => {
  try {
    const k = localStorage.getItem('v9_apikey');
    if(k){
      document.getElementById('apiKeyInput').value = k;
      checkKey();
      // Se jÃ¡ tem chave salva, comeÃ§a colapsado
      const body = document.getElementById('apikeyBody');
      body.classList.remove('open');
      document.getElementById('apikeyToggleIcon').textContent = 'â–¶';
    }
  } catch(e){}

  const zone = document.getElementById('uploadZone');
  // clique gerenciado pelo <label for="fileInput"> â€” sem JS adicional necessÃ¡rio

  document.querySelectorAll('.tone-btn').forEach(b => {
    b.addEventListener('click', () => {
      document.querySelectorAll('.tone-btn').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
    });
  });

  document.querySelectorAll('.peticao-tipo-btn').forEach(b => {
    b.addEventListener('click', () => {
      document.querySelectorAll('.peticao-tipo-btn').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
    });
  });

  document.getElementById('fatos').addEventListener('input', function(){
    document.getElementById('charsCount').textContent = this.value.length;
  });

  document.getElementById('prazoTipo').addEventListener('change', function(){
    document.getElementById('prazoCustomDiv').classList.toggle('hidden', this.value !== 'custom');
  });

  atualizarContHist();
});

// â”€â”€ API KEY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleApiCard(){
  const body = document.getElementById('apikeyBody');
  const icon = document.getElementById('apikeyToggleIcon');
  const open = body.classList.contains('open');
  body.classList.toggle('open', !open);
  icon.textContent = open ? 'â–¶' : 'â–¼';
}

function checkKey(){
  const k = document.getElementById('apiKeyInput').value.trim();
  const st = document.getElementById('apiKeyStatus');
  const hSt = document.getElementById('apikeyHeaderStatus');
  const hTxt = document.getElementById('apikeyHeaderTxt');
  if(!k){ st.textContent=''; st.className='apikey-status'; hSt.className='apikey-header-status empty'; hTxt.textContent='NÃ£o configurada'; return; }
  if(k.startsWith('AIza') && k.length > 20){
    st.textContent = 'âœ“ Chave vÃ¡lida â€” salva no navegador';
    st.className = 'apikey-status ok';
    hSt.className = 'apikey-header-status ok';
    hTxt.textContent = 'Configurada âœ“';
    try{ localStorage.setItem('v9_apikey', k); }catch(e){}
    // Auto-colapsa apÃ³s 1.2s quando chave vÃ¡lida
    setTimeout(()=>{
      const body = document.getElementById('apikeyBody');
      if(body.classList.contains('open')){ toggleApiCard(); }
    }, 1200);
  } else {
    st.textContent = 'âœ— Formato invÃ¡lido â€” deve comeÃ§ar com AIza';
    st.className = 'apikey-status err';
    hSt.className = 'apikey-header-status empty';
    hTxt.textContent = 'InvÃ¡lida';
  }
}
function toggleEye(){
  const inp = document.getElementById('apiKeyInput');
  inp.type = inp.type==='password' ? 'text' : 'password';
  document.getElementById('apiKeyEye').textContent = inp.type==='password' ? 'ğŸ‘' : 'ğŸ™ˆ';
}

// â”€â”€ MODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setMode(m){
  currentMode = m;
  document.getElementById('modeUploadBtn').classList.toggle('active', m==='upload');
  document.getElementById('modeManualBtn').classList.toggle('active', m==='manual');
  document.getElementById('uploadSection').classList.toggle('hidden', m==='manual');
  document.getElementById('manualSection').classList.toggle('hidden', m==='upload');
}

// â”€â”€ DRAG & DROP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function dragOver(e){ e.preventDefault(); e.stopPropagation(); document.getElementById('uploadZone').classList.add('drag'); }
function dragLeave(e){ e.preventDefault(); document.getElementById('uploadZone').classList.remove('drag'); }
function dropFile(e){ e.preventDefault(); e.stopPropagation(); dragLeave(e); const f=e.dataTransfer.files[0]; if(f) handleFile(f); }

// â”€â”€ FILE HANDLER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function handleFile(file){
  if(!file) return;
  if(file.size > 150*1024*1024){ alert('Arquivo muito grande. MÃ¡ximo: 150MB'); return; }
  uploadedFile=file; extractedContent=''; extractedBase64=''; extractedMime='';
  const z=document.getElementById('uploadZone');
  z.classList.add('has-file');
  document.getElementById('uploadIcon').textContent = icon(file.name);
  document.getElementById('uploadTitle').textContent = file.name;
  document.getElementById('uploadSub').textContent = fsize(file.size);
  document.getElementById('uploadTypes').style.display='none';
  document.getElementById('uploadClear').style.display='inline-block';
  prog(true,'Lendo arquivo...',10);
  const ext = file.name.split('.').pop().toLowerCase();
  try{
    if(ext==='txt'){ extractedContent=await rText(file); prog(true,'Texto extraÃ­do!',100); }
    else if(['doc','docx'].includes(ext)){
      prog(true,'Extraindo texto do Word...',30);
      const ab=await rBuffer(file);
      const r=await mammoth.extractRawText({arrayBuffer:ab});
      extractedContent=r.value; prog(true,'Texto extraÃ­do!',100);
    }
    else if(ext==='pdf'){ prog(true,'PDF pronto!',100); extractedBase64=await rB64(file); extractedMime='application/pdf'; }
    else if(['jpg','jpeg','png','webp'].includes(ext)){ prog(true,'Imagem pronta!',100); extractedBase64=await rB64(file); extractedMime=file.type||'image/jpeg'; }
    else { alert('Formato nÃ£o suportado. Use: PDF, DOCX, TXT, JPG, PNG.'); clearFile(null); return; }
    const box=document.getElementById('extractedBox'); box.style.display='block';
    if(extractedContent){
      document.getElementById('extractedTxt').textContent = extractedContent.substring(0,400)+(extractedContent.length>400?'â€¦':'');
    } else {
      document.getElementById('extractedTxt').textContent = 'âœ“ Arquivo carregado â€” a IA vai analisar o conteÃºdo';
    }
    document.getElementById('uploadSub').textContent='âœ“ Pronto para anÃ¡lise';
  }catch(e){ alert('Erro ao ler: '+e.message); clearFile(null); }
  setTimeout(()=>prog(false),1200);
}
function clearFile(e){
  if(e){ e.stopPropagation(); e.preventDefault(); }
  uploadedFile=null; extractedContent=''; extractedBase64=''; extractedMime='';
  const fi = document.getElementById('fileInput');
  fi.value='';
  // Reset via new input to force browser to clear
  try{ fi.value=''; }catch(ex){}
  const z=document.getElementById('uploadZone'); z.classList.remove('has-file','drag');
  document.getElementById('uploadIcon').textContent='ğŸ“„';
  document.getElementById('uploadTitle').textContent='Clique aqui ou arraste o arquivo';
  document.getElementById('uploadSub').textContent='Contrato, PetiÃ§Ã£o, SentenÃ§a, NotificaÃ§Ã£o, Laudo...';
  document.getElementById('uploadTypes').style.display='';
  document.getElementById('uploadClear').style.display='none';
  document.getElementById('extractedBox').style.display='none';
  prog(false);
}
function prog(show,txt='',pct=0){
  document.getElementById('prog').style.display=show?'block':'none';
  if(txt) document.getElementById('progTxt').textContent=txt;
  document.getElementById('progFill').style.width=pct+'%';
}
function icon(n){ const e=n.split('.').pop().toLowerCase(); return e==='pdf'?'ğŸ“•':['doc','docx'].includes(e)?'ğŸ“˜':['jpg','jpeg','png','webp'].includes(e)?'ğŸ–¼ï¸':'ğŸ“„'; }
function fsize(b){ return b<1048576?(b/1024).toFixed(1)+' KB':(b/1048576).toFixed(1)+' MB'; }
function rText(f){ return new Promise((s,r)=>{const x=new FileReader();x.onload=e=>s(e.target.result);x.onerror=()=>r(new Error('Falha'));x.readAsText(f,'UTF-8');}); }
function rBuffer(f){ return new Promise((s,r)=>{const x=new FileReader();x.onload=e=>s(e.target.result);x.onerror=()=>r(new Error('Falha'));x.readAsArrayBuffer(f);}); }
function rB64(f){ return new Promise((s,r)=>{const x=new FileReader();x.onload=e=>s(e.target.result.split(',')[1]);x.onerror=()=>r(new Error('Falha'));x.readAsDataURL(f);}); }

// â”€â”€ CALCULADORA DE PRAZOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function maskData(el){
  let v=el.value.replace(/\D/g,'');
  if(v.length>=3) v=v.substring(0,2)+'/'+v.substring(2);
  if(v.length>=6) v=v.substring(0,5)+'/'+v.substring(5,9);
  el.value=v;
}

// â”€â”€ FERIADOS NACIONAIS FIXOS (dia/mÃªs) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Apenas feriados NACIONAIS fixos conforme Lei 9.093/95 e legislaÃ§Ã£o vigente
const FERIADOS_NACIONAIS_FIXOS = [
  '01/01', // ConfraternizaÃ§Ã£o Universal
  '21/04', // Tiradentes
  '01/05', // Dia do Trabalho
  '07/09', // IndependÃªncia do Brasil
  '12/10', // Nossa Senhora Aparecida
  '02/11', // Finados
  '15/11', // ProclamaÃ§Ã£o da RepÃºblica
  '20/11', // ConsciÃªncia Negra (Lei 12.519/2011, feriado nacional desde 2023)
  '25/12', // Natal
];

function ehDiaUtil(d) {
  // Retorna true se for dia Ãºtil (nÃ£o Ã© sÃ¡bado, nÃ£o Ã© domingo, nÃ£o Ã© feriado nacional fixo)
  const diaSemana = d.getDay(); // 0=dom, 6=sab
  if (diaSemana === 0 || diaSemana === 6) return false;
  const chave = String(d.getDate()).padStart(2,'0') + '/' + String(d.getMonth()+1).padStart(2,'0');
  if (FERIADOS_NACIONAIS_FIXOS.includes(chave)) return false;
  return true;
}

// Conta N dias Ãºteis a partir de uma data (sem incluir a data base)
// Regra CPC art. 219: contam-se apenas os dias Ãºteis
function adicionarDiasUteis(dataBase, qtdDiasUteis) {
  const cursor = new Date(dataBase);
  cursor.setHours(0, 0, 0, 0);
  let contados = 0;
  while (contados < qtdDiasUteis) {
    cursor.setDate(cursor.getDate() + 1); // avanÃ§a 1 dia
    if (ehDiaUtil(cursor)) contados++;    // sÃ³ conta se for Ãºtil
  }
  return cursor;
}

// Se o resultado cair num dia nÃ£o Ãºtil, avanÃ§a para o prÃ³ximo dia Ãºtil
function proximoDiaUtil(d) {
  const r = new Date(d);
  r.setHours(0, 0, 0, 0);
  while (!ehDiaUtil(r)) r.setDate(r.getDate() + 1);
  return r;
}

function calcularPrazo(){
  const dataStr = document.getElementById('prazoDataAto').value.trim();
  if(!dataStr || dataStr.length<10){ alert('Informe a data no formato DD/MM/AAAA'); return; }
  const [dd,mm,aaaa] = dataStr.split('/');
  const dataAto = new Date(parseInt(aaaa), parseInt(mm)-1, parseInt(dd));
  dataAto.setHours(0,0,0,0);
  if(isNaN(dataAto.getTime())){ alert('Data invÃ¡lida'); return; }

  let sel = document.getElementById('prazoTipo');
  let dias = parseInt(sel.value);
  if(sel.value==='custom'){
    dias = parseInt(document.getElementById('prazoCustomDias').value);
    if(isNaN(dias)||dias<1){ alert('Informe o nÃºmero de dias'); return; }
  }

  // â”€â”€ CONTAGEM CORRETA DE DIAS ÃšTEIS (CPC art. 219) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Conta dia Ãºtil por dia Ãºtil a partir da data do ato (sem incluir o dia do ato)
  const vencFinal = adicionarDiasUteis(dataAto, dias);

  const hoje = new Date(); hoje.setHours(0,0,0,0);
  const diffMs = vencFinal - hoje;
  const diffDias = Math.ceil(diffMs/(1000*60*60*24));
  const fmt = d => d.toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit',year:'numeric',weekday:'long'});

  let urgClass = diffDias<=3?'urgente':diffDias<=10?'atencao':'ok';
  let urgTxt = diffDias<0?'âš  PRAZO VENCIDO':diffDias===0?'âš  VENCE HOJE':diffDias===1?'âš  VENCE AMANHÃƒ':`Faltam ${diffDias} dias corridos`;

  // Mostra quais feriados nacionais foram pulados no perÃ­odo
  const feriadosPulados = [];
  const cursor = new Date(dataAto);
  cursor.setHours(0,0,0,0);
  while (cursor <= vencFinal) {
    cursor.setDate(cursor.getDate() + 1);
    if (cursor > dataAto && cursor <= vencFinal) {
      const chave = String(cursor.getDate()).padStart(2,'0') + '/' + String(cursor.getMonth()+1).padStart(2,'0');
      if (FERIADOS_NACIONAIS_FIXOS.includes(chave) && cursor.getDay()!==0 && cursor.getDay()!==6) {
        feriadosPulados.push(cursor.toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit',year:'numeric'}));
      }
    }
  }

  const res = document.getElementById('prazoResultado');
  res.style.display='block';
  res.innerHTML = `
    <div class="prazo-grid">
      <div class="prazo-card">
        <div class="prazo-nome">Data do Ato / IntimaÃ§Ã£o</div>
        <div class="prazo-data">${dataStr}</div>
        <div class="prazo-dias">${fmt(dataAto)}</div>
      </div>
      <div class="prazo-card">
        <div class="prazo-nome">Vencimento (${dias} dias Ãºteis)</div>
        <div class="prazo-data">${vencFinal.toLocaleDateString('pt-BR')}</div>
        <div class="prazo-dias">${fmt(vencFinal)}</div>
      </div>
      <div class="prazo-card">
        <div class="prazo-nome">SituaÃ§Ã£o</div>
        <div class="prazo-data ${urgClass}" style="font-size:1.1rem">${diffDias<0?'VENCIDO':diffDias===0?'HOJE':diffDias+'d'}</div>
        <div class="prazo-dias ${urgClass}">${urgTxt}</div>
      </div>
    </div>
    ${feriadosPulados.length ? `<div style="font-size:.6rem;color:var(--yellow);margin-top:8px;background:rgba(243,156,18,.07);border:1px solid rgba(243,156,18,.2);border-radius:3px;padding:7px 10px">âš  Feriados nacionais nÃ£o contados: ${feriadosPulados.join(', ')}</div>` : ''}
    <div style="font-size:.58rem;color:var(--muted);margin-top:8px">
      âœ… Dias Ãºteis contados conforme CPC art. 219 â€” fins de semana e feriados nacionais fixos excluÃ­dos.<br>
      âš  Feriados estaduais/municipais e suspensÃµes do tribunal (ex: recesso forense) <strong>nÃ£o estÃ£o incluÃ­dos</strong> â€” verifique no site do tribunal.
    </div>`;
}

// â”€â”€ CHECKLIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CHECKLISTS = {
  trabalhista:['Carteira de Trabalho (CTPS)','Contracheques / Holerites','Contrato de Trabalho','Comprovante de rescisÃ£o / TRCT','Extrato FGTS','Comprovante de fÃ©rias','Folhas de ponto','Comprovante de registro sindical','Documentos de identidade','Comprovante de endereÃ§o'],
  indenizacao:['Documentos de identidade','Boletim de OcorrÃªncia (se houver)','Laudos mÃ©dicos / Atestados','Fotos dos danos','OrÃ§amentos de reparo','Comprovantes de despesas','Testemunhas (nomes e contatos)','Prints / Provas digitais','HistÃ³rico de comunicaÃ§Ãµes','Comprovante de endereÃ§o'],
  consumidor:['Nota fiscal / Cupom fiscal','Contrato de compra ou serviÃ§o','Fotos do produto com defeito','Comprovantes de pagamento','E-mails / Mensagens com empresa','Laudo tÃ©cnico (se houver)','Protocolo de reclamaÃ§Ã£o','Print do site / Oferta','Comprovante de devoluÃ§Ã£o','Documentos pessoais'],
  previdenciario:['CPF e RG','Carteira de Trabalho','CNIS (Extrato PrevidenciÃ¡rio)','Laudos mÃ©dicos atualizados','Exames e atestados','DeclaraÃ§Ã£o do INSS de indeferimento','ProcuraÃ§Ã£o para advogado','Comprovante de residÃªncia','HistÃ³rico de contribuiÃ§Ãµes','FormulÃ¡rios INSS preenchidos'],
  familia:['CertidÃ£o de casamento','Documentos dos filhos','CertidÃ£o de nascimento','Comprovantes de renda de ambas as partes','Comprovante de residÃªncia','Documentos de bens imÃ³veis','Extratos bancÃ¡rios','Escritura de divÃ³rcio anterior (se houver)','Acordo extrajudicial (se houver)','Documentos de dependentes'],
  cobranca:['Contrato assinado','Duplicatas / Notas promissÃ³rias','Comprovantes de entrega','Extratos de pagamento','E-mails e notificaÃ§Ãµes enviadas','CertidÃ£o de protesto (se houver)','Documentos da empresa devedora','ProcuraÃ§Ã£o','Planilha de dÃ©bito atualizada','Documentos pessoais do credor'],
  contrato:['Contrato original completo','Aditivos e anexos','Comprovantes de pagamento','E-mails sobre negociaÃ§Ã£o','Atas de reuniÃ£o','Documentos das partes','Laudos ou pareceres tÃ©cnicos','Contratos similares para comparaÃ§Ã£o','CorrespondÃªncias formais','Extratos bancÃ¡rios relacionados'],
};
function gerarChecklist(){
  const tipo = document.getElementById('checklistTipo').value;
  const area = document.getElementById('checklistArea');
  if(!tipo){ area.innerHTML=''; return; }
  const items = CHECKLISTS[tipo]||[];
  let html = `<div class="checklist" id="checklistItens">`;
  items.forEach((item,i) => {
    html += `<div class="check-item" id="ci${i}" onclick="toggleCheck(${i})">
      <div class="check-box" id="cb${i}"></div>
      <div class="check-label">${item}</div>
    </div>`;
  });
  html += `</div>
  <div class="check-progress"><div class="check-progress-fill" id="checkProgressFill" style="width:0%"></div></div>
  <div class="check-status" id="checkStatus">0 de ${items.length} documentos coletados</div>`;
  area.innerHTML = html;
}
function toggleCheck(i){
  const item = document.getElementById('ci'+i);
  const box = document.getElementById('cb'+i);
  item.classList.toggle('checked');
  box.textContent = item.classList.contains('checked') ? 'âœ“' : '';
  const total = document.querySelectorAll('[id^="ci"]').length;
  const checked = document.querySelectorAll('[id^="ci"].checked').length;
  const pct = total>0 ? Math.round(checked/total*100) : 0;
  document.getElementById('checkProgressFill').style.width = pct+'%';
  document.getElementById('checkStatus').textContent = `${checked} de ${total} documentos coletados (${pct}%)`;
}

// â”€â”€ BANCO DE SÃšMULAS VERIFICADAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Cada sÃºmula tem tags[] â€” palavras-chave que disparam sua inclusÃ£o no prompt.
// Isso garante que a IA sÃ³ recebe sÃºmulas RELEVANTES ao caso, sem inventar.
// Fonte: sites oficiais STF (stf.jus.br), STJ (stj.jus.br), TST (tst.jus.br), TNU.
const BANCO_SUMULAS = [

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â• TRABALHISTA â€” TST â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  {n:'SÃºmula 6 TST',   tags:['equiparacao salarial','equiparaÃ§Ã£o salarial','salario igual','funcao identica','paradigma','isonomia salarial'],
   txt:'EquiparaÃ§Ã£o salarial: para efeito de equiparaÃ§Ã£o, sÃ³ Ã© relevante o fato de o reclamante e o paradigma exercerem a mesma funÃ§Ã£o, com idÃªntica produtividade e perfeiÃ§Ã£o tÃ©cnica, no mesmo estabelecimento empresarial.'},

  {n:'SÃºmula 85 TST',  tags:['compensacao de jornada','compensaÃ§Ã£o de jornada','banco de horas','acordo de compensacao','folga compensatoria'],
   txt:'CompensaÃ§Ã£o de jornada: Ã© vÃ¡lido o acordo individual, tÃ¡cito ou expresso, para compensaÃ§Ã£o de horÃ¡rios, quando a compensaÃ§Ã£o ocorrer dentro da mesma semana. O acordo de compensaÃ§Ã£o semanal pode ser realizado verbalmente.'},

  {n:'SÃºmula 116 TST', tags:['horas extras','hora extra','adicional noturno','jornada','trabalho noturno','reducao hora noturna'],
   txt:'O trabalho noturno tem hora reduzida (52 min e 30 seg), e o adicional noturno de 20% Ã© computado nas horas extras trabalhadas nesse perÃ­odo.'},

  {n:'SÃºmula 132 TST', tags:['horas extras','hora extra','reflexos','rsr','descanso semanal','ferias','decimo terceiro','fgts','aviso previo','repercussao'],
   txt:'Horas extras: o adicional de horas extras reflete no RSR, que por sua vez repercute no cÃ¡lculo das fÃ©rias, dÃ©cimo terceiro salÃ¡rio, aviso prÃ©vio e FGTS.'},

  {n:'SÃºmula 212 TST', tags:['demissao','demissÃ£o','dispensa','rescisao','rescisÃ£o','Ã´nus prova','onus prova','terminacao contrato','justa causa','pedido demissao'],
   txt:'Dispensa do empregado: o Ã´nus de provar o tÃ©rmino do contrato de trabalho, quando negados a prestaÃ§Ã£o de serviÃ§o e o despedimento, Ã© do empregador, pois o princÃ­pio da continuidade da relaÃ§Ã£o de emprego constitui presunÃ§Ã£o favorÃ¡vel ao empregado.'},

  {n:'SÃºmula 277 TST', tags:['convencao coletiva','acordo coletivo','norma coletiva','ultratividade','vigencia','sindicato','negociacao coletiva'],
   txt:'As clÃ¡usulas normativas dos acordos coletivos ou convenÃ§Ãµes coletivas integram os contratos individuais de trabalho e somente poderÃ£o ser modificadas ou suprimidas mediante negociaÃ§Ã£o coletiva de trabalho.'},

  {n:'SÃºmula 291 TST', tags:['horas extras','hora extra','supressao','habitualidade','corte de horas','reducao jornada'],
   txt:'Horas extras: a supressÃ£o total ou parcial de serviÃ§o suplementar prestado com habitualidade gera direito ao pagamento das horas suprimidas, nÃ£o inferior a um mÃªs por ano ou fraÃ§Ã£o igual ou superior a seis meses.'},

  {n:'SÃºmula 331 TST', tags:['terceirizacao','terceirizaÃ§Ã£o','empresa interposta','prestacao servico','prestaÃ§Ã£o serviÃ§o','responsabilidade subsidiaria','responsabilidade subsidiÃ¡ria','tomador servico','subcontratacao','quarteirizacao'],
   txt:'Contrato de prestaÃ§Ã£o de serviÃ§os: a contrataÃ§Ã£o de trabalhadores por empresa interposta Ã© ilegal, formando-se o vÃ­nculo diretamente com o tomador dos serviÃ§os, salvo no caso de trabalho temporÃ¡rio. A responsabilidade subsidiÃ¡ria do tomador abrange todas as verbas trabalhistas.'},

  {n:'SÃºmula 338 TST', tags:['controle jornada','ponto','registro ponto','jornada trabalho','horas extras','Ã´nus prova','onus prova','relatorio ponto','cartao ponto'],
   txt:'Jornada de trabalho: Ã© Ã´nus do empregador que conta com mais de 10 empregados o registro da jornada de trabalho na forma do art. 74, Â§2Âº, da CLT. A nÃ£o apresentaÃ§Ã£o injustificada dos controles de frequÃªncia gera presunÃ§Ã£o relativa de veracidade da jornada informada pelo empregado.'},

  {n:'SÃºmula 342 TST', tags:['desconto salario','desconto salarial','desconto folha','autorizacao desconto','emprestimo consignado','plano saude desconto'],
   txt:'Descontos salariais efetuados pelo empregador, com a autorizaÃ§Ã£o prÃ©via e por escrito do empregado, sÃ£o lÃ­citos, exceto quando houver coaÃ§Ã£o.'},

  {n:'SÃºmula 362 TST', tags:['fgts','prescricao fgts','prescriÃ§Ã£o fgts','recolhimento fgts','deposito fgts','conta vinculada','saque fgts'],
   txt:'FGTS: Ã© quinquenal a prescriÃ§Ã£o do direito de reclamar contra o nÃ£o recolhimento da contribuiÃ§Ã£o para o FGTS, observado o prazo de dois anos apÃ³s o tÃ©rmino do contrato.'},

  {n:'SÃºmula 363 TST', tags:['contrato nulo','contrato invalido','contrato ilegal','servidor publico','admissao irregular','concurso publico','vinculo emprego nulo'],
   txt:'A contrataÃ§Ã£o de servidor pÃºblico, apÃ³s a CF/88, sem prÃ©via aprovaÃ§Ã£o em concurso pÃºblico, encontra Ã³bice no art. 37, II e Â§2Âº, sendo nulo o contrato, mas gerando direito ao pagamento da contraprestaÃ§Ã£o pactuada e dos valores referentes aos depÃ³sitos do FGTS.'},

  {n:'SÃºmula 369 TST', tags:['dirigente sindical','estabilidade sindical','cipeiro','estabilidade provisoria','representante sindical','garantia emprego sindical'],
   txt:'Dirigente sindical: o empregado eleito para cargo de direÃ§Ã£o de sindicatos tem direito Ã  estabilidade provisÃ³ria, ainda que a comunicaÃ§Ã£o ao empregador ocorra apÃ³s o registro da candidatura.'},

  {n:'SÃºmula 372 TST', tags:['gratificacao funcao','gratificaÃ§Ã£o funÃ§Ã£o','adicional funcao','cargo de confianca','cargo de confianÃ§a','supressao gratificacao','reducao gratificacao','10 anos gratificacao'],
   txt:'GratificaÃ§Ã£o de funÃ§Ã£o: percebida por dez ou mais anos, nÃ£o pode ser suprimida nem reduzida, salvo erro ou fraude na concessÃ£o.'},

  {n:'SÃºmula 378 TST', tags:['acidente trabalho','doenca ocupacional','estabilidade acidente','afastamento acidente','alta medica inss','reabilitacao profissional','doenÃ§a trabalho'],
   txt:'Estabilidade provisÃ³ria acidentÃ¡ria: sÃ£o pressupostos para a concessÃ£o da estabilidade o afastamento superior a 15 dias e a consequente percepÃ§Ã£o do auxÃ­lio-doenÃ§a acidentÃ¡rio.'},

  {n:'SÃºmula 390 TST', tags:['servidor publico','estabilidade servidor','celetista publico','administracao direta','autarquia','fundacao publica','art 41 cf'],
   txt:'Estabilidade: o servidor pÃºblico celetista da administraÃ§Ã£o direta, autÃ¡rquica ou fundacional Ã© beneficiÃ¡rio da estabilidade prevista no art. 41 da CF/88.'},

  {n:'SÃºmula 396 TST', tags:['estabilidade provisoria','reintegracao','reintegraÃ§Ã£o','estabilidade gestante','estabilidade cipeiro','periodo estabilidade','indenizacao estabilidade'],
   txt:'Estabilidade provisÃ³ria: exaurido o perÃ­odo de estabilidade, sÃ£o devidos ao empregado apenas os salÃ¡rios do perÃ­odo compreendido entre a data da despedida e o final do perÃ­odo de estabilidade, nÃ£o lhe sendo assegurada a reintegraÃ§Ã£o.'},

  {n:'SÃºmula 437 TST', tags:['intervalo intrajornada','intervalo almoco','almoco trabalho','descanso jornada','reducao intervalo','supressao intervalo','nao concessao intervalo'],
   txt:'Intervalo intrajornada: apÃ³s a CF/88, o intervalo intrajornada mÃ­nimo nÃ£o pode ser suprimido nem reduzido por acordo ou convenÃ§Ã£o coletiva; a nÃ£o concessÃ£o total ou parcial gera o pagamento do perÃ­odo correspondente com acrÃ©scimo de 50%, tendo natureza salarial.'},

  {n:'SÃºmula 443 TST', tags:['dispensa discriminatoria','dispensa discriminatÃ³ria','hiv aids','doenÃ§a grave','cancer','alcoolismo','preconceito doenÃ§a','reintegracao discriminacao'],
   txt:'Dispensa discriminatÃ³ria: presume-se discriminatÃ³ria a despedida de empregado portador do vÃ­rus HIV ou de outra doenÃ§a grave que cause estigma ou preconceito. CabÃ­vel a reintegraÃ§Ã£o ou, a critÃ©rio do empregado, a indenizaÃ§Ã£o em dobro.'},

  {n:'SÃºmula 478 TST', tags:['empregado hiposuficiente','beneficio justica gratuita','gratuidade justica','custas processuais','honorarios periciais','assistencia judiciaria trabalhista'],
   txt:'A justiÃ§a gratuita, na JustiÃ§a do Trabalho, alcanÃ§a o empregado que perceba salÃ¡rio igual ou inferior a 40% do limite mÃ¡ximo dos benefÃ­cios do RGPS, ou que declare, sob as penas da lei, que nÃ£o dispÃµe de condiÃ§Ãµes para pagar as custas do processo.'},

  {n:'OJ 394 SDI-1 TST', tags:['arquivamento reclamacao','representacao irregular','nova acao','propositura nova acao trabalhista'],
   txt:'O arquivamento da reclamaÃ§Ã£o trabalhista por falta de representaÃ§Ã£o regular nÃ£o impede a propositura de nova aÃ§Ã£o com o mesmo objeto.'},

  {n:'OJ 399 SDI-1 TST', tags:['adicional transferencia','transferencia empregado','mudanca domicilio','provisoria definitiva'],
   txt:'O adicional de transferÃªncia Ã© devido quando o empregado Ã© transferido para localidade diversa da que resultar do contrato, ainda que em carÃ¡ter provisÃ³rio.'},

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â• CONSUMIDOR â€” STJ â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  {n:'SÃºmula 297 STJ', tags:['banco','instituicao financeira','cdc banco','consumidor banco','relacao consumo banco','codigo defesa consumidor banco'],
   txt:'O CÃ³digo de Defesa do Consumidor Ã© aplicÃ¡vel Ã s instituiÃ§Ãµes financeiras.'},

  {n:'SÃºmula 302 STJ', tags:['plano saude','internacao hospitalar','limite internacao','clausula abusiva plano','tempo internacao','plano saude abusivo'],
   txt:'Ã‰ abusiva a clÃ¡usula contratual de plano de saÃºde que limita no tempo a internaÃ§Ã£o hospitalar do segurado.'},

  {n:'SÃºmula 321 STJ', tags:['previdencia privada','cdc previdencia','entidade previdencia','fundo previdencia complementar'],
   txt:'O CDC aplica-se Ã  relaÃ§Ã£o jurÃ­dica entre a entidade de previdÃªncia privada e seus participantes.'},

  {n:'SÃºmula 381 STJ', tags:['contrato bancario','clausula abusiva banco','revisao contrato bancario','abusividade bancaria','juros abusivos banco'],
   txt:'Nos contratos bancÃ¡rios, Ã© vedado ao julgador conhecer, de ofÃ­cio, da abusividade das clÃ¡usulas.'},

  {n:'SÃºmula 404 STJ', tags:['negativacao','spc serasa','cadastro inadimplentes','aviso negativacao','notificacao negativacao','ar negativacao'],
   txt:'Ã‰ dispensÃ¡vel o Aviso de Recebimento (AR) na carta de comunicaÃ§Ã£o ao consumidor sobre a negativaÃ§Ã£o de seu nome em bancos de dados e cadastros.'},

  {n:'SÃºmula 412 STJ', tags:['tarifa agua','tarifa esgoto','taxa agua','saneamento basico','repetiÃ§Ã£o indebito agua','prescricao agua esgoto'],
   txt:'A aÃ§Ã£o de repetiÃ§Ã£o de indÃ©bito de tarifas de Ã¡gua e esgoto sujeita-se ao prazo prescricional estabelecido no CÃ³digo Civil.'},

  {n:'SÃºmula 548 STJ', tags:['exclusao negativacao','retirada spc serasa','baixa negativacao','pagamento divida','cancelamento restricao','prazo exclusao negativacao'],
   txt:'Incumbe ao credor a exclusÃ£o do registro da dÃ­vida em nome do devedor no cadastro de inadimplentes no prazo de cinco dias Ãºteis, a partir do integral e efetivo pagamento do dÃ©bito.'},

  {n:'SÃºmula 563 STJ', tags:['entidade aberta previdencia','previdencia aberta','cdc previdencia aberta','pgbl vgbl'],
   txt:'O CÃ³digo de Defesa do Consumidor Ã© aplicÃ¡vel Ã s entidades abertas de previdÃªncia complementar, nÃ£o incidindo nos contratos previdenciÃ¡rios celebrados com entidades fechadas.'},

  {n:'SÃºmula 601 STJ', tags:['ministerio publico consumidor','mp acao consumidor','legitimidade mp','acao coletiva consumidor','acp consumidor'],
   txt:'O MinistÃ©rio PÃºblico tem legitimidade ativa para atuar na defesa de direitos difusos, coletivos e individuais homogÃªneos dos consumidores, ainda que decorrentes da prestaÃ§Ã£o de serviÃ§o pÃºblico.'},

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â• CIVIL / DANO MORAL â€” STJ â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  {n:'SÃºmula 37 STJ',  tags:['dano material','dano moral','cumulacao danos','indenizacao material moral','acumulo indenizacao'],
   txt:'SÃ£o cumulÃ¡veis as indenizaÃ§Ãµes por dano material e dano moral oriundos do mesmo fato.'},

  {n:'SÃºmula 54 STJ',  tags:['juros moratÃ³rios','juros moratorios','responsabilidade extracontratual','acidente','evento danoso','juros desde acidente'],
   txt:'Os juros moratÃ³rios fluem a partir do evento danoso, em caso de responsabilidade extracontratual.'},

  {n:'SÃºmula 227 STJ', tags:['pessoa juridica dano moral','empresa dano moral','pj dano moral','honra empresa','reputacao empresa'],
   txt:'A pessoa jurÃ­dica pode sofrer dano moral.'},

  {n:'SÃºmula 281 STJ', tags:['dano moral','tarifacao dano moral','limite indenizacao moral','arbitramento dano moral','valor dano moral'],
   txt:'A indenizaÃ§Ã£o por dano moral nÃ£o estÃ¡ sujeita Ã  tarifaÃ§Ã£o prevista na Lei de Imprensa.'},

  {n:'SÃºmula 362 STJ', tags:['correcao monetaria dano moral','correcao dano moral','atualizacao indenizacao','data arbitramento'],
   txt:'A correÃ§Ã£o monetÃ¡ria do valor da indenizaÃ§Ã£o do dano moral incide desde a data do arbitramento.'},

  {n:'SÃºmula 387 STJ', tags:['dano estetico','dano estÃ©tico','cumulacao dano estetico moral','deformidade','cicatriz','lesao estetica'],
   txt:'Ã‰ lÃ­cita a cumulaÃ§Ã£o das indenizaÃ§Ãµes de dano estÃ©tico e dano moral.'},

  {n:'SÃºmula 403 STJ', tags:['imagem direito','uso imagem','publicacao imagem','imagem sem autorizacao','indenizacao imagem','foto sem permissao'],
   txt:'Independe de prova do prejuÃ­zo a indenizaÃ§Ã£o pela publicaÃ§Ã£o nÃ£o autorizada de imagem de pessoa com fins econÃ´micos ou comerciais.'},

  {n:'SÃºmula 489 STJ', tags:['reconhecimento divida','prescricao interrompida','interrupcao prescricao','reconhecimento debito','confissao divida'],
   txt:'O reconhecimento do dÃ©bito pelo devedor interrompe a prescriÃ§Ã£o, ainda que realizado de forma extrajudicial.'},

  {n:'SÃºmula 543 STJ', tags:['contrato adesao','clausula abusiva','revisao contrato','contrato bancario clausula','onerosidade excessiva'],
   txt:'Na hipÃ³tese de resoluÃ§Ã£o de contrato de promessa de compra e venda de imÃ³vel submetido ao CDC, deve ocorrer a imediata restituiÃ§Ã£o das parcelas pagas pelo promitente comprador, em valor correspondente a no mÃ­nimo setenta e cinco por cento do que foi por ele desembolsado.'},

  {n:'SÃºmula 620 STJ', tags:['responsabilidade civil','acidente transito','veiculo','atropelamento','colisao','indenizacao transito','seguro dpvat'],
   txt:'A embriaguez do condutor nÃ£o exclui a responsabilidade civil do proprietÃ¡rio do veÃ­culo pelo acidente de trÃ¢nsito.'},

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â• PREVIDENCIÃRIO â€” TNU / STJ â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  {n:'SÃºmula 7 TNU',   tags:['auxilio doenca','auxÃ­lio doenÃ§a','doenca preexistente','carencia inss','beneficio negado preexistente'],
   txt:'O benefÃ­cio de auxÃ­lio-doenÃ§a nÃ£o serÃ¡ concedido ao segurado que se filiar ao RGPS jÃ¡ portador da doenÃ§a ou lesÃ£o invocada como causa para o benefÃ­cio, salvo quando a incapacidade sobrevier por motivo de progressÃ£o ou agravamento dessa doenÃ§a ou lesÃ£o.'},

  {n:'SÃºmula 27 TNU', tags:['aposentadoria especial','atividade especial','formulario ppra','laudo tecnico pericial','prova especialidade','agente nocivo'],
   txt:'A utilizaÃ§Ã£o de formulÃ¡rios eletrÃ´nicos nÃ£o comprova o efetivo labor em condiÃ§Ãµes especiais para fins de aposentadoria especial, sendo necessÃ¡rio laudo tÃ©cnico pericial.'},

  {n:'SÃºmula 33 TNU', tags:['incapacidade trabalho','aposentadoria invalidez','Ã´nus prova incapacidade','onus prova inss','reabilitacao profissional inss'],
   txt:'Quando o segurado demonstrar a incapacidade para o trabalho que habitualmente exercia, Ã© Ã´nus da parte contrÃ¡ria demonstrar que ele estÃ¡ apto para outra atividade laboral.'},

  {n:'SÃºmula 44 TNU', tags:['aposentadoria especial','laudo judicial','prova especialidade','pericia judicial aposentadoria','agente nocivo prova'],
   txt:'Para efeitos de aposentadoria especial, o laudo pericial judicial nÃ£o Ã© o Ãºnico meio de prova da especialidade das condiÃ§Ãµes de trabalho, podendo ser admitida prova material e outros meios de prova em direito admitidos.'},

  {n:'SÃºmula 47 TNU', tags:['incapacidade parcial','aposentadoria invalidez','condicoes pessoais','sociais segurado','trabalhador rural idoso analfabeto incapacidade'],
   txt:'Uma vez reconhecida a incapacidade parcial para o trabalho, o juiz deve analisar as condiÃ§Ãµes pessoais e sociais do segurado para a concessÃ£o de aposentadoria por invalidez.'},

  {n:'SÃºmula 72 TNU', tags:['atividade urbana','rurÃ­cola','inicio prova material','trabalhador urbano previdenciario','prova testemunhal previdencia'],
   txt:'Ã‰ possÃ­vel o reconhecimento de atividade urbana para fins previdenciÃ¡rios com base em inÃ­cio de prova material corroborada por prova testemunhal idÃ´nea.'},

  {n:'SÃºmula 83 TNU', tags:['pensao por morte','acumulacao pensao','aposentadoria e pensao','dois beneficios inss','acumulo beneficio previdenciario'],
   txt:'NÃ£o hÃ¡ vedaÃ§Ã£o legal Ã  percepÃ§Ã£o simultÃ¢nea de pensÃ£o por morte e proventos de aposentadoria, ressalvadas as hipÃ³teses de acumulaÃ§Ã£o vedadas pela ConstituiÃ§Ã£o.'},

  {n:'SÃºmula 10 TNU',  tags:['trabalhador rural','boia fria','segurado especial','atividade rural','contribuicao rural','previdencia rural'],
   txt:'O tempo de serviÃ§o rural anterior Ã  vigÃªncia da Lei 8.213/91 pode ser utilizado para fins de contagem recÃ­proca, assim entendida aquela que soma tempo de atividade privada, rural ou urbana, ao de serviÃ§o pÃºblico estatutÃ¡rio.'},

  {n:'SÃºmula 29 TNU',  tags:['salario maternidade','salario-maternidade','beneficio maternidade','gestante inss','alta medica maternidade'],
   txt:'Para os efeitos do art. 55, Â§3Âº, da Lei 8.213/91, o salÃ¡rio-maternidade Ã© considerado como perÃ­odo de efetiva atividade, sendo contabilizado como tempo de contribuiÃ§Ã£o.'},

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â• FAMÃLIA â€” STJ â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  {n:'SÃºmula 301 STJ', tags:['investigacao paternidade','dna paternidade','recusa exame dna','presuncao paternidade','acao paternidade','reconhecimento filho'],
   txt:'Em aÃ§Ã£o investigatÃ³ria, a recusa do suposto pai a submeter-se ao exame de DNA induz presunÃ§Ã£o juris tantum de paternidade.'},

  {n:'SÃºmula 309 STJ', tags:['prisao civil alimentos','alimentante preso','divida alimentar','prestacoes anteriores','execucao alimentos','debito alimentar'],
   txt:'O dÃ©bito alimentar que autoriza a prisÃ£o civil do alimentante Ã© o que compreende as trÃªs prestaÃ§Ãµes anteriores ao ajuizamento da execuÃ§Ã£o e as que se vencerem no curso do processo.'},

  {n:'SÃºmula 336 STJ', tags:['renunciou alimentos','renÃºncia alimentos','pensÃ£o viÃºva','necessidade posterior','alimentos ex conjuge','pensao previdenciaria morte'],
   txt:'A mulher que renunciou aos alimentos na separaÃ§Ã£o judicial tem direito Ã  pensÃ£o previdenciÃ¡ria por morte do ex-marido, comprovada a necessidade econÃ´mica superveniente.'},

  {n:'SÃºmula 358 STJ', tags:['maioridade alimentos','cancelamento alimentos','filho maior','exoneraÃ§Ã£o alimentos','extinÃ§Ã£o alimentos maioridade'],
   txt:'O cancelamento de pensÃ£o alimentÃ­cia de filho que atingiu a maioridade estÃ¡ sujeito Ã  decisÃ£o judicial, mediante contraditÃ³rio, ainda que nos prÃ³prios autos.'},

  {n:'SÃºmula 383 STJ', tags:['divorcio','separacao judicial','conversao separacao divorcio','pedido divorcio','dissolucao casamento'],
   txt:'A competÃªncia para processar e julgar as aÃ§Ãµes conexas de interesse de menor Ã©, em princÃ­pio, do foro do domicÃ­lio do detentor de sua guarda.'},

  {n:'SÃºmula 594 STJ', tags:['alimentos menor','mp alimentos crianca','ministerio publico alimentos','legitimidade mp alimentos','acao alimentos adolescente'],
   txt:'O MinistÃ©rio PÃºblico tem legitimidade ativa para ajuizar aÃ§Ã£o de alimentos em proveito de crianÃ§a ou adolescente, independentemente do exercÃ­cio do poder familiar dos pais.'},

  {n:'SÃºmula 655 STJ', tags:['guarda','responsabilidade guarda','juizado infancia','vara familia guarda','competencia guarda menor'],
   txt:'Pedido de guarda e responsabilidade deve ser processado e julgado pelo Juizado da InfÃ¢ncia e Juventude, ainda que presentes interesses de adultos.'},

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â• TRIBUTÃRIO â€” STJ / STF â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  {n:'SÃºmula 213 STJ', tags:['compensacao tributaria','mandado seguranca tributario','credito tributario','restituicao imposto','compensacao fiscal'],
   txt:'O mandado de seguranÃ§a constitui aÃ§Ã£o adequada para a declaraÃ§Ã£o do direito Ã  compensaÃ§Ã£o tributÃ¡ria.'},

  {n:'SÃºmula 436 STJ', tags:['declaracao contribuinte','constituicao credito tributario','lanCamento tributario','dctf','declaracao fiscal'],
   txt:'A entrega de declaraÃ§Ã£o pelo contribuinte reconhecendo dÃ©bito fiscal constitui o crÃ©dito tributÃ¡rio, dispensada qualquer outra providÃªncia por parte do fisco.'},

  {n:'SÃºmula 446 STJ', tags:['certidao negativa','certidao positiva efeito negativa','cpd-en','debito tributario nao pago','regularidade fiscal'],
   txt:'Declarado e nÃ£o pago o dÃ©bito tributÃ¡rio pelo contribuinte, Ã© legÃ­tima a recusa de expediÃ§Ã£o de certidÃ£o negativa ou positiva com efeito de negativa.'},

  {n:'SÃºmula 239 STF', tags:['coisa julgada tributaria','imposto exercicio','repeticao exercicio tributario','imunidade tributaria exercicio'],
   txt:'DecisÃ£o que declara indevida a cobranÃ§a do imposto em determinado exercÃ­cio nÃ£o faz coisa julgada em relaÃ§Ã£o aos posteriores.'},

  {n:'SÃºmula 544 STF', tags:['isencao tributaria','condicao onerosa isencao','supressao isencao','revogacao isencao tributaria'],
   txt:'IsenÃ§Ãµes tributÃ¡rias concedidas, sob condiÃ§Ã£o onerosa, nÃ£o podem ser livremente suprimidas.'},

  {n:'SÃºmula 584 STF', tags:['imposto renda','irpf','declaracao irpf','lei vigente irpf','exercicio financeiro irpf'],
   txt:'Ao imposto de renda calculado sobre os rendimentos do ano-base, aplica-se a lei vigente no exercÃ­cio financeiro em que deve ser apresentada a declaraÃ§Ã£o.'},

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â• BANCÃRIO â€” STJ â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  {n:'SÃºmula 283 STJ', tags:['cartao credito juros','administradora cartao','juros cartao','lei usura cartao','financeira juros'],
   txt:'As empresas administradoras de cartÃ£o de crÃ©dito sÃ£o instituiÃ§Ãµes financeiras e, por isso, os juros remuneratÃ³rios por elas cobrados nÃ£o sofrem as limitaÃ§Ãµes da Lei de Usura.'},

  {n:'SÃºmula 286 STJ', tags:['renegociacao bancaria','confissao divida bancaria','contrato anterior bancario','revisao contrato renegociado','refinanciamento'],
   txt:'A renegociaÃ§Ã£o de contrato bancÃ¡rio ou a confissÃ£o da dÃ­vida nÃ£o impede a possibilidade de discussÃ£o sobre eventuais ilegalidades dos contratos anteriores.'},

  {n:'SÃºmula 293 STJ', tags:['arrendamento mercantil','leasing','valor residual garantido','vrg','descaracterizacao leasing'],
   txt:'A cobranÃ§a antecipada do valor residual garantido (VRG) nÃ£o descaracteriza o contrato de arrendamento mercantil.'},

  {n:'SÃºmula 530 STJ', tags:['taxa juros mercado','juros bacen','taxa media mercado','juros contrato bancario','juros sem pactuacao'],
   txt:'Nos contratos bancÃ¡rios, na impossibilidade de comprovar a taxa de juros efetivamente contratada, aplica-se a taxa mÃ©dia de mercado, divulgada pelo BACEN, praticada nas operaÃ§Ãµes da mesma espÃ©cie.'},

  {n:'SÃºmula 566 STJ', tags:['tarifa cadastro','tarifa bancaria','taxa cadastro banco','cobranca tarifa cadastro','abertura conta tarifa'],
   txt:'Nos contratos bancÃ¡rios posteriores ao inÃ­cio da vigÃªncia da ResoluÃ§Ã£o CMN 3.518/2007, pode ser cobrada a tarifa de cadastro no inÃ­cio do relacionamento entre o consumidor e a instituiÃ§Ã£o financeira.'},

  {n:'SÃºmula 572 STJ', tags:['serasa spc indevido','inscricao indevida spc','dano moral negativacao indevida','inscricao irregular','cobranca indevida negativacao'],
   txt:'O bem de famÃ­lia Ã© impenhorÃ¡vel, ainda que objeto de penhora consensual, salvo nas hipÃ³teses previstas na Lei 8.009/1990.'},

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â• PENAL â€” STJ / STF â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  {n:'SÃºmula 9 STJ',   tags:['prisao provisoria','apelar preso','efeito suspensivo apelacao penal','presuncao inocencia prisao apelar'],
   txt:'A exigÃªncia da prisÃ£o provisÃ³ria, para apelar, nÃ£o ofende a garantia constitucional da presunÃ§Ã£o de inocÃªncia.'},

  {n:'SÃºmula 243 STJ', tags:['suspensao condicional processo','sursis processual','concurso material','continuidade delitiva','pena minima dois anos'],
   txt:'O benefÃ­cio da suspensÃ£o do processo nÃ£o Ã© aplicÃ¡vel em relaÃ§Ã£o Ã s infraÃ§Ãµes penais cometidas em concurso material, concurso formal ou continuidade delitiva, quando a pena mÃ­nima cominada, seja pelo somatÃ³rio, seja pela incidÃªncia da majorante, ultrapassar dois anos.'},

  {n:'SÃºmula 444 STJ', tags:['inquerito policial pena','acao penal curso pena','pena base','maus antecedentes inquerito','agravamento pena inquerito'],
   txt:'Ã‰ vedada a utilizaÃ§Ã£o de inquÃ©ritos policiais e aÃ§Ãµes penais em curso para agravar a pena-base.'},

  {n:'SÃºmula 711 STF', tags:['lei penal grave','crime continuado lei','crime permanente lei','lex gravior','retroatividade lei penal'],
   txt:'A lei penal mais grave aplica-se ao crime continuado ou ao crime permanente, se a sua vigÃªncia Ã© anterior Ã  cessaÃ§Ã£o da continuidade ou da permanÃªncia.'},

  {n:'SÃºmula 718 STF', tags:['regime cumprimento pena','regime fechado','regime semiaberto','motivacao regime','gravidade abstrata crime','fixacao regime'],
   txt:'A opiniÃ£o do julgador sobre a gravidade em abstrato do crime nÃ£o constitui motivaÃ§Ã£o idÃ´nea para a imposiÃ§Ã£o de regime mais severo do que o permitido segundo a pena aplicada.'},

  {n:'SÃºmula 719 STF', tags:['regime mais severo','regime fechado motivacao','imposicao regime severo','fundamentacao regime cumprimento'],
   txt:'A imposiÃ§Ã£o do regime de cumprimento mais severo do que a pena aplicada permitir exige motivaÃ§Ã£o idÃ´nea.'},

  {n:'SÃºmula 736 STF', tags:['crime ambiental','acao penal ambiental','competencia crime ambiental','dano ambiental penal','lei ambiental penal'],
   txt:'Compete Ã  JustiÃ§a Federal julgar os crimes de competÃªncia definida no art. 109 da CF/88, entre eles os crimes praticados em detrimento de bens, serviÃ§os ou interesses da UniÃ£o.'},

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â• ADMINISTRATIVO â€” STF / STJ â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  {n:'SÃºmula 346 STF', tags:['anulacao ato administrativo','autotutela','nulidade ato','administracao anular','ato nulo administrativo'],
   txt:'A AdministraÃ§Ã£o PÃºblica pode declarar a nulidade dos seus prÃ³prios atos.'},

  {n:'SÃºmula 473 STF', tags:['anulacao ato administrativo','revogacao ato','autotutela administrativa','conveniencia oportunidade','direito adquirido administrativo'],
   txt:'A AdministraÃ§Ã£o pode anular seus prÃ³prios atos, quando eivados de vÃ­cios que os tornem ilegais, porque deles nÃ£o se originam direitos; ou revogÃ¡-los, por motivo de conveniÃªncia ou oportunidade, respeitados os direitos adquiridos.'},

  {n:'SÃºmula 633 STJ', tags:['lei 9784','processo administrativo federal','prazo decadencial administrativo','revisao ato administrativo','decadencia administrativa'],
   txt:'A Lei 9.784/1999, no que diz respeito ao prazo decadencial para a revisÃ£o de atos administrativos no Ã¢mbito da AdministraÃ§Ã£o Federal, pode ser aplicada de forma subsidiÃ¡ria aos estados e municÃ­pios, se inexistente norma local especÃ­fica.'},

  {n:'SÃºmula 467 STJ', tags:['multa ambiental','prescricao multa ambiental','execucao multa administrativa','ibama multa','infracao ambiental prescricao'],
   txt:'Prescreve em cinco anos, contados do tÃ©rmino do processo administrativo, a pretensÃ£o da AdministraÃ§Ã£o PÃºblica de promover a execuÃ§Ã£o da multa por infraÃ§Ã£o ambiental.'},

  {n:'SÃºmula 510 STJ', tags:['improbidade administrativa','agente politico improbidade','prefeito improbidade','governador improbidade','competencia improbidade'],
   txt:'A liberaÃ§Ã£o de verbas pÃºblicas sem o atendimento de exigÃªncias legais para tanto Ã© ato de improbidade administrativa, independentemente da ocorrÃªncia de dano ao erÃ¡rio.'},

];

// â”€â”€ ÃNDICE PLANO (para validaÃ§Ã£o pÃ³s-geraÃ§Ã£o) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SUMULAS_PLANO = (() => {
  const plano = {};
  for(const s of BANCO_SUMULAS){ plano[s.n.toLowerCase()] = s; }
  return plano;
})();

// â”€â”€ NORMALIZA TEXTO (remove acentos, caixa alta, pontuaÃ§Ã£o extra) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function norm(s){
  return s.toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/[^a-z0-9 ]/g,' ')
    .replace(/\s+/g,' ').trim();
}

// â”€â”€ BUSCA SÃšMULAS POR TAGS â€” PRECISA E SEM CHUTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// LÃ³gica: cada sÃºmula tem tags exatas. O texto do caso Ã© normalizado e
// comparamos palavra por palavra com as tags. Isso evita falsos positivos
// do tipo "banco" acionar sÃºmulas de famÃ­lia.
function buscarSumulasLocais(area, pedidos, fatos=''){
  const textoNorm = norm(area + ' ' + pedidos + ' ' + fatos);
  const palavras = textoNorm.split(' ').filter(p => p.length > 3);

  // Mapa de Ã¡rea selecionada â†’ prefixo de tags obrigatÃ³rio
  const areaMap = {
    'Direito Trabalhista':   'trab',
    'Direito Civil':         'civ',
    'Direito do Consumidor': 'cons',
    'Direito PrevidenciÃ¡rio':'prev',
    'Direito de FamÃ­lia':    'fami',
    'Direito TributÃ¡rio':    'trib',
    'Direito Empresarial':   'empr',
    'Direito Penal':         'pena',
    'Direito Administrativo':'admin',
    'Direito BancÃ¡rio':      'banc',
    'Direito Ambiental':     'ambi',
    'Direito Digital':       '',
    'Direito ImobiliÃ¡rio':   'imov',
    'Direito MÃ©dico':        '',
  };

  const resultado = [];
  for(const s of BANCO_SUMULAS){
    // Normaliza todas as tags da sÃºmula
    const tagsNorm = s.tags.map(t => norm(t));
    // Uma sÃºmula Ã© incluÃ­da se PELO MENOS UMA tag tiver match exato com o texto
    const match = tagsNorm.some(tag => {
      // Verifica se a tag (que pode ter vÃ¡rias palavras) estÃ¡ contida no texto
      return textoNorm.includes(tag);
    });
    if(match) resultado.push(s);
  }

  // Se nenhuma tag bateu (caso muito genÃ©rico), usa o mapa de Ã¡rea como fallback
  if(resultado.length === 0){
    const areaKey = areaMap[area] || '';
    if(areaKey){
      for(const s of BANCO_SUMULAS){
        if(s.tags.some(t => norm(t).includes(areaKey))){
          resultado.push(s);
        }
      }
    }
  }

  // Deduplica
  const vistos = new Set();
  return resultado.filter(s => {
    if(vistos.has(s.n)) return false;
    vistos.add(s.n); return true;
  });
}

// â”€â”€ VALIDADOR ANTI-ALUCINAÃ‡ÃƒO PÃ“S-GERAÃ‡ÃƒO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function extrairReferencias(texto){
  const refs = [];
  const patterns = [
    /S[Ãºu]mula\s+(?:n[ÂºÂ°]?\s*)?(\d+)\s*(?:d[ao]?\s*)?(STF|STJ|TST|TNU|TRT\s*\d*)/gi,
    /OJ\s+(?:n[ÂºÂ°]?\s*)?(\d+)\s+([A-Z\-]+(?:\s+[A-Z]+)*)/gi,
  ];
  for(const pat of patterns){
    let m;
    while((m=pat.exec(texto))!==null){
      const raw = m[0].replace(/\s+/g,' ').trim();
      let chave = raw.toLowerCase().replace(/\s+nÂº?\s*/,' ').replace(/\s+do?\s+/,' ').replace(/\s+/g,' ').trim();
      // Normaliza "SÃºmula 85 do TST" â†’ "sÃºmula 85 tst"
      chave = chave.replace(/\bsumula\b/,'sÃºmula');
      if(!refs.find(r=>r.chave===chave)) refs.push({raw, chave});
    }
  }
  return refs;
}

function validarAntiAlucinacao(texto, sumulasAutorizadas){
  const setsAutorizadas = new Set(sumulasAutorizadas.map(s=>s.n.toLowerCase()));
  const refsEncontradas = extrairReferencias(texto);
  const resultado = { totalCitadas:refsEncontradas.length, verificadas:[], naoVerificadas:[], percentualSeguro:100 };

  for(const ref of refsEncontradas){
    const noPlano = SUMULAS_PLANO[ref.chave];
    const autorizada = setsAutorizadas.has(ref.chave) ||
      [...setsAutorizadas].some(a => {
        // Compara nÃºmero + tribunal
        const partsA = a.split(' '); const partsR = ref.chave.split(' ');
        return partsA[1]===partsR[1] && partsA[2]===partsR[2];
      });

    if(noPlano && autorizada){
      resultado.verificadas.push({ref:ref.raw, dados:noPlano, status:'verified'});
    } else if(noPlano && !autorizada){
      resultado.verificadas.push({ref:ref.raw, dados:noPlano, status:'warned'});
    } else {
      resultado.naoVerificadas.push({ref:ref.raw, status:'removed'});
    }
  }

  const total = resultado.totalCitadas;
  resultado.percentualSeguro = total===0 ? 100 : Math.round(((total-resultado.naoVerificadas.length)/total)*100);
  return resultado;
}

// â”€â”€ CACHE DE ANÃLISE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function cacheKey(d, mode){
  const base = mode==='upload' ?
    extractedContent.substring(0,200) :
    [d.area,d.tipo,d.pedidos,d.fatos?.substring(0,100)].join('|');
  return 'v9cache_'+btoa(unescape(encodeURIComponent(base+d.tom))).substring(0,40);
}
function cacheGet(key){ try{ const c=localStorage.getItem(key); if(!c) return null; const p=JSON.parse(c); if(Date.now()-p.ts>3600000*4) return null; return p.text; }catch(e){ return null; } }
function cacheSet(key,text){ try{ localStorage.setItem(key,JSON.stringify({ts:Date.now(),text})); }catch(e){} }

// â”€â”€ PROMPT BUILDER (COMPACTO â€” MENOS TOKENS) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TONS = {
  imparcial:'AnÃ¡lise rigorosamente imparcial, pontos fortes e fracos de ambos os polos.',
  favoravel:'Foco nos melhores argumentos para o polo ativo.',
  defensivo:'Foco na defesa do polo passivo, fragilidades nos pedidos do autor.',
  estrategico:'AnÃ¡lise estratÃ©gica: acordo vs litÃ­gio, riscos, tÃ¡ticas e recomendaÃ§Ã£o objetiva.'
};

function buildPrompt(d, sumulasVerificadas=[]){
  const ton = TONS[d.tom]||TONS.imparcial;
  const extra = d.extraContext ? `\nInstruÃ§Ãµes adicionais do advogado: ${d.extraContext}` : '';
  const cliente = d.cliente ? `\nCliente: ${d.cliente}` : '';

  // â”€â”€ BLOCO DE SÃšMULAS: LISTA FECHADA E EXAUSTIVA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let sumulasBloco = '';
  if(sumulasVerificadas.length > 0){
    const lista = sumulasVerificadas.map(s => `  â€¢ ${s.n}: "${s.txt}"`).join('\n');
    sumulasBloco = `

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  LISTA FECHADA DE SÃšMULAS â€” ÃšNICA FONTE PERMITIDA               â•‘
â•‘  VOCÃŠ SÃ“ PODE CITAR AS SÃšMULAS ABAIXO. NENHUMA OUTRA.          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
${lista}

ğŸš« PROIBIÃ‡ÃƒO ABSOLUTA: Ã‰ COMPLETAMENTE PROIBIDO citar qualquer sÃºmula, OJ, tese, verbete ou precedente vinculante que NÃƒO esteja na lista acima.
ğŸš« NÃƒO INVENTE: NÃ£o existe "SÃºmula X do STJ" ou "SÃºmula Y do TST" fora desta lista para este caso.
ğŸš« SE NÃƒO ESTIVER NA LISTA: Escreva exatamente "NÃ£o hÃ¡ sÃºmula verificada aplicÃ¡vel a este ponto." â€” nunca invente um nÃºmero.
âœ… SOMENTE as sÃºmulas acima estÃ£o confirmadas e podem ser citadas com nÃºmero.`;
  } else {
    sumulasBloco = `

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ATENÃ‡ÃƒO: NENHUMA SÃšMULA DISPONÃVEL PARA ESTE CASO             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸš« PROIBIÃ‡ÃƒO ABSOLUTA: NÃƒO cite nenhuma sÃºmula por nÃºmero (STF, STJ, TST, TNU, TRT ou qualquer outro tribunal).
ğŸš« NÃƒO ESCREVA "SÃºmula X", "OJ Y", "Tese Z" â€” vocÃª nÃ£o tem autorizaÃ§Ã£o para citar nenhuma.
âœ… Na seÃ§Ã£o de jurisprudÃªncia, escreva apenas: "NÃ£o hÃ¡ sÃºmula verificada disponÃ­vel para esta Ã¡rea neste sistema."
âœ… VocÃª pode mencionar princÃ­pios legais gerais (boa-fÃ©, presunÃ§Ã£o de inocÃªncia etc.) sem citar nÃºmero de sÃºmula.`;
  }

  const instrucao = `VocÃª Ã© um jurista brasileiro sÃªnior com 30 anos de experiÃªncia.
Tom da anÃ¡lise: ${ton}.${cliente}
Data: ${d.data}${extra}
${sumulasBloco}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
REGRAS DE INTEGRIDADE â€” VIOLAÃ‡ÃƒO DESTRÃ“I A CREDIBILIDADE:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
1. SÃšMULAS: Siga a proibiÃ§Ã£o acima Ã  risca. Zero exceÃ§Ãµes.
2. ARTIGOS DE LEI: Cite apenas artigos que vocÃª tem CERTEZA ABSOLUTA que existem (ex: art. 477 CLT, art. 186 CC, art. 6Â° CDC). Se tiver dÃºvida do nÃºmero, descreva o conteÃºdo SEM citar nÃºmero. Nunca invente nÃºmero de artigo.
3. VALORES: Use faixas reais conhecidas. Se nÃ£o souber, escreva "varia conforme o juÃ­zo".
4. PROBABILIDADE: Justifique cada fator. Nunca atribua percentual sem explicaÃ§Ã£o.
5. HONESTIDADE: "NÃ£o verificado" Ã© MELHOR do que inventar. Sua credibilidade depende disso.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ESTRUTURA OBRIGATÃ“RIA â€” SIGA EXATAMENTE:
## 1. RESUMO EXECUTIVO
[5 linhas: o que Ã© o caso, probabilidade, forÃ§a principal, risco principal, recomendaÃ§Ã£o imediata]

## 2. PROBABILIDADE DE ÃŠXITO
**Probabilidade Global: [X]%**
ClassificaÃ§Ã£o: [ALTA / MÃ‰DIA / BAIXA]
- âœ… Fator positivo 1: [argumento + fundamento]
- âœ… Fator positivo 2: [argumento + fundamento]
- âŒ Fator negativo 1: [fraqueza + impacto]
- âŒ Fator negativo 2: [fraqueza + impacto]
- âš ï¸ Fator incerto: [o que pode ir para qualquer lado]

## 3. IDENTIFICAÃ‡ÃƒO DO CASO
## 4. PONTOS FORTES (mÃ­nimo 4)
## 5. PONTOS FRACOS E RISCOS (mÃ­nimo 3)
## 6. SÃšMULAS E JURISPRUDÃŠNCIA APLICÃVEL
[APENAS as da lista fornecida acima. Se nenhuma se aplicar: "NÃ£o hÃ¡ sÃºmula verificada aplicÃ¡vel."]
## 7. FUNDAMENTOS LEGAIS
[Artigos com certeza absoluta: nÃºmero + lei + conteÃºdo + aplicaÃ§Ã£o ao caso]
## 8. ESTIMATIVA DE VALORES E HONORÃRIOS
## 9. ESBOÃ‡O DA PEÃ‡A PROCESSUAL
## 10. ESTRATÃ‰GIA E PRÃ“XIMOS PASSOS`;

  if(currentMode==='upload'){
    const max=25000;
    const doc=extractedContent.length>max?extractedContent.substring(0,max)+'\n[Truncado por tamanho]':extractedContent;
    return `${instrucao}\n\nDOCUMENTO PARA ANÃLISE:\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n${doc}\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`;
  }
  return `${instrucao}\n\nDADOS DO CASO:\nÃrea: ${d.area||'NÃ£o informado'}\nTipo de AÃ§Ã£o: ${d.tipo||'NÃ£o informado'}\nPolo Ativo (Autor): ${d.autor||'NÃ£o informado'}\nPolo Passivo (RÃ©u): ${d.reu||'NÃ£o informado'}\nPedidos: ${d.pedidos||'NÃ£o informado'}\nTribunal: ${d.tribunal||'NÃ£o informado'}\nValor da Causa: ${d.valor?'R$ '+d.valor:'NÃ£o informado'}\nFatos e Provas: ${d.fatos||'NÃ£o informado'}`;
}

// â”€â”€ CHAMAR API GEMINI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function gemini(apiKey, messages, systemPrompt=''){
  const modelos = ['gemini-2.5-flash','gemini-2.0-flash','gemini-1.5-flash'];
  let ultimoErro = '';
  for(const modelo of modelos){
    try{
      const body = {
        contents: messages,
        generationConfig: {maxOutputTokens:12000, temperature:0.15} // Temperatura menor = menos criatividade = menos alucinaÃ§Ã£o
      };
      if(systemPrompt) body.system_instruction = {parts:[{text:systemPrompt}]};
      const r = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/${modelo}:generateContent?key=${apiKey}`,
        {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}
      );
      if(!r.ok){
        const err=await r.json().catch(()=>({}));
        ultimoErro = `${modelo}: ${err.error?.message||'HTTP '+r.status}`;
        continue;
      }
      const data = await r.json();
      let texto = '';
      for(const cand of (data.candidates||[])){
        for(const part of (cand?.content?.parts||[])){
          if(part.text) texto += part.text;
        }
      }
      if(texto.trim()) return texto.trim();
      ultimoErro = `${modelo}: resposta vazia`;
    }catch(e){ ultimoErro = `${modelo}: ${e.message}`; }
  }
  throw new Error('Falha em todos os modelos. Ãšltimo erro: '+ultimoErro+'\n\nVerifique sua chave em aistudio.google.com');
}

// â”€â”€ EXECUTAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function executar(){
  const apiKey = document.getElementById('apiKeyInput').value.trim();
  if(!apiKey||!apiKey.startsWith('AIza')){
    alert('ğŸ”‘ Cole sua chave de API!\n\nObtena grÃ¡tis em aistudio.google.com â†’ Get API Key');
    document.getElementById('apiKeyInput').focus(); return;
  }
  const d = {
    cliente:      document.getElementById('nomeCliente').value.trim(),
    processo:     document.getElementById('numProcesso').value.trim(),
    area:         document.getElementById('areaDir').value,
    tipo:         document.getElementById('tipoAcao').value.trim(),
    autor:        document.getElementById('autor').value.trim(),
    reu:          document.getElementById('reu').value.trim(),
    pedidos:      document.getElementById('pedidos').value.trim(),
    tribunal:     document.getElementById('tribunal').value,
    valor:        document.getElementById('valorCausa').value.trim(),
    tom:          document.querySelector('.tone-btn.active').dataset.tone,
    fatos:        document.getElementById('fatos').value.trim(),
    extraContext: document.getElementById('extraContext').value.trim(),
    data:         new Date().toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit',year:'numeric'})
  };
  if(currentMode==='upload'&&!extractedContent&&!extractedBase64){ alert('ğŸ“ FaÃ§a upload de um documento.'); return; }
  if(currentMode==='manual'){ if(!d.area){alert('Selecione a Ãrea do Direito.');return;} if(d.fatos.length<80){alert('Descreva os fatos com pelo menos 80 caracteres.');return;} }

  showView('loading');
  document.getElementById('loadingCache').textContent='';

  const steps=['Lendo documento...','ğŸ“š Consultando banco de sÃºmulas...','âš– Verificando jurisprudÃªncia aplicÃ¡vel...','Analisando fundamentos jurÃ­dicos...','Calculando probabilidade...','Elaborando esboÃ§o processual...','Definindo estratÃ©gia...','Estimando honorÃ¡rios...'];
  let si=0; const iv=setInterval(()=>{ document.getElementById('loadingStep').textContent=steps[si++%steps.length]; },1900);

  try{
    // Extrai PDF/imagem primeiro se necessÃ¡rio
    if(currentMode==='upload'&&extractedBase64&&!extractedContent){
      document.getElementById('loadingStep').textContent='Extraindo texto do arquivo...';
      const mimeOk = extractedMime.startsWith('image/') ? extractedMime : 'application/pdf';
      try{
        const txt = await gemini(apiKey,
          [{role:'user',parts:[
            {inline_data:{mime_type:mimeOk,data:extractedBase64}},
            {text:'Transcreva TODO o texto deste documento jurÃ­dico. NÃ£o resuma.'}
          ]}]
        );
        if(txt){ extractedContent=txt; }
      }catch(e){ console.warn('ExtraÃ§Ã£o falhou:',e.message); }
    }

    // Verificar cache (economiza API)
    const ck = cacheKey(d, currentMode);
    const cached = cacheGet(ck);
    let text = '';
    if(cached){
      text = cached;
      document.getElementById('loadingCache').textContent='âš¡ AnÃ¡lise carregada do cache local (sem chamada Ã  API)';
    } else {
      // Busca sÃºmulas no banco local
      document.getElementById('loadingStep').textContent='ğŸ“š Consultando banco de sÃºmulas verificadas...';
      const sumulasVerificadas = buscarSumulasLocais(d.area, d.pedidos||d.tipo||'', d.fatos||extractedContent.substring(0,500));

      document.getElementById('loadingStep').textContent='âš– Gerando anÃ¡lise com sÃºmulas verificadas...';
      const prompt = buildPrompt(d, sumulasVerificadas);
      text = await gemini(apiKey, [{role:'user',parts:[{text:prompt}]}]);
      cacheSet(ck, text); // Salva no cache

      clearInterval(iv);

      // ValidaÃ§Ã£o Anti-AlucinaÃ§Ã£o pÃ³s-geraÃ§Ã£o
      document.getElementById('loadingStep').textContent='ğŸ›¡ Validando sÃºmulas â€” Anti-AlucinaÃ§Ã£o...';
      const halResult = validarAntiAlucinacao(text, sumulasVerificadas);

      analysisData = {
        formData:d, aiText:text, fileName:uploadedFile?.name||null,
        sumulasUsadas:sumulasVerificadas, halResult
      };
    }

    if(!analysisData){
      const sumulasVerificadas = buscarSumulasLocais(d.area, d.pedidos||d.tipo||'', d.fatos||extractedContent.substring(0,500));
      const halResult = validarAntiAlucinacao(text, sumulasVerificadas);
      analysisData = {formData:d, aiText:text, fileName:uploadedFile?.name||null, sumulasUsadas:sumulasVerificadas, halResult};
    }

    clearInterval(iv);

    // Chat context â€” comprimido para economizar tokens
    chatHistory = [
      {role:'user',parts:[{text:`Caso analisado: ${d.cliente||''} | ${d.area||''} | ${d.tipo||''}\nAnÃ¡lise resumida: ${text.substring(0,3000)}`}]},
      {role:'model',parts:[{text:'AnÃ¡lise registrada. Pronto para responder perguntas sobre este caso.'}]}
    ];
    chatHistoryCompressed = true;

    salvarHistorico(d, text);
    renderResult(d, text);
  }catch(e){
    clearInterval(iv);
    showView('form');
    alert('âš  Erro:\n\n'+e.message);
  }
}

// â”€â”€ ABAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setTab(id, btn){
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('tab'+capitalize(id)).classList.add('active');
}
function capitalize(s){ return s.charAt(0).toUpperCase()+s.slice(1); }

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderResult(d, text){
  showView('result');

  // Probabilidade
  const m = text.match(/Probabilidade\s+Global[:\s*_]*(\d{1,3})\s*%/i)||text.match(/\*{0,2}(\d{1,3})\s*%\*{0,2}/);
  const prob = m ? Math.min(97,Math.max(5,parseInt(m[1]))) : null;
  if(prob!==null){
    const cls = prob>=70?'high':prob>=40?'medium':'low';
    document.getElementById('probValue').textContent=prob+'%';
    document.getElementById('probValue').className='prob-value '+cls;
    document.getElementById('probClass').textContent=prob>=70?'â¬† Alta Probabilidade':prob>=40?'â—ˆ Probabilidade Moderada':'â¬‡ Baixa Probabilidade';
    document.getElementById('probClass').style.color=prob>=70?'var(--green)':prob>=40?'var(--yellow)':'var(--red)';
    setTimeout(()=>{ const b=document.getElementById('probBar'); b.className='prob-bar-fill '+cls; b.style.width=prob+'%'; },300);
    const cap=v=>Math.min(97,Math.max(6,Math.round(v)));
    const rnd=(rng,off=0)=>off+Math.round((Math.random()-.5)*rng);
    const sc=[{n:'MÃ©rito JurÃ­dico',v:cap(prob+rnd(12,-3))},{n:'Base ProbatÃ³ria',v:cap(prob+rnd(10,-7))},{n:'JurisprudÃªncia',v:cap(prob+rnd(15,-5))},{n:'PosiÃ§Ã£o do Tribunal',v:cap(prob+rnd(18,-10))}];
    let h='<div style="margin-top:11px">';
    sc.forEach(s=>{ h+=`<div class="score-row"><div class="score-name">${s.n}</div><div class="score-mini-bar"><div class="score-mini-fill" data-val="${s.v}"></div></div><div class="score-pct">${s.v}%</div></div>`; });
    document.getElementById('scoreBreakdown').innerHTML=h+'</div>';
    setTimeout(()=>document.querySelectorAll('.score-mini-fill').forEach(el=>{ el.style.width=el.dataset.val+'%'; }),500);
  } else {
    document.getElementById('probValue').textContent='N/D';
    document.getElementById('probClass').textContent='Dados insuficientes';
  }

  // Resumo executivo
  const resumoMatch = text.match(/## 1\. RESUMO EXECUTIVO\n([\s\S]*?)(?=\n## 2\.)/i);
  const resumoTxt = resumoMatch ? resumoMatch[1].trim() : '';
  const itens = [
    {label:'Cliente', val: d.cliente||'â€”'},
    {label:'Processo', val: d.processo||'â€”'},
    {label:'Ãrea', val: d.area||'Documento'},
    {label:'Probabilidade', val: prob!==null?prob+'%':'N/D'},
    {label:'Tom', val: d.tom||'imparcial'},
    {label:'Data', val: d.data}
  ];
  let resumoHtml = '';
  itens.forEach(it=>{ resumoHtml+=`<div class="resumo-item"><div class="resumo-item-label">${it.label}</div><div class="resumo-item-val">${it.val}</div></div>`; });
  if(resumoTxt){
    resumoHtml += `<div class="resumo-item" style="grid-column:1/-1"><div class="resumo-item-label">Resumo</div><div class="resumo-item-val" style="font-size:.78rem;font-weight:400;color:var(--muted)">${resumoTxt.replace(/\n/g,' ').substring(0,300)}</div></div>`;
  }
  document.getElementById('resumoItens').innerHTML = resumoHtml;

  // AnÃ¡lise completa
  document.getElementById('aiText').textContent = text;

  // Extrair seÃ§Ãµes para abas
  renderSecao(text, 'PONTOS FORTES', 'secFortes');
  renderSecao(text, 'PONTOS FRACOS', 'secRiscos', 'RISCOS');
  renderSecao(text, 'SÃšMULAS', 'secSumulas', 'JURISPRUDÃŠNCIA');
  renderSecao(text, 'ESTRATÃ‰GIA', 'secEstrategia', 'PRÃ“XIMOS PASSOS');

  // Painel de sÃºmulas
  const sumulasUsadas = analysisData?.sumulasUsadas || [];
  const jCard = document.getElementById('jurisVivoCard');
  jCard.style.display = 'block';
  if(sumulasUsadas.length > 0){
    document.getElementById('jurisVivoTxt').innerHTML = sumulasUsadas.map(s =>
      `<div style="background:rgba(0,0,0,.3);border-left:2px solid var(--gold-dark);border-radius:3px;padding:8px 11px;margin-bottom:7px">
        <div style="font-size:.65rem;font-weight:700;color:var(--gold);letter-spacing:.08em">${s.n}</div>
        <div style="font-size:12px;color:#8ab4c8;margin-top:3px;line-height:1.6">${s.txt}</div>
      </div>`
    ).join('');
  } else {
    document.getElementById('jurisVivoTxt').innerHTML = '<div style="font-size:.65rem;color:var(--muted);padding:10px">Nenhuma sÃºmula verificada para esta Ã¡rea. A IA foi instruÃ­da a nÃ£o citar sÃºmulas por nÃºmero.</div>';
  }

  // Anti-AlucinaÃ§Ã£o Report
  const hal = analysisData?.halResult;
  if(hal){
    renderHalReport(hal);
  }

  // Prompt para copiar
  document.getElementById('promptPreview').textContent = gerarPromptCopia(d, text);

  window.scrollTo({top:0,behavior:'smooth'});
}

function renderSecao(texto, palavraTitulo, elId, palavraAlt=''){
  const el = document.getElementById(elId);
  if(!el) return;
  // Busca seÃ§Ã£o pelo tÃ­tulo
  const regex = new RegExp(`## \\d+\\.\\s*${palavraTitulo}([\\s\\S]*?)(?=\\n## \\d+\\.|$)`,'i');
  let m = regex.exec(texto);
  if(!m && palavraAlt){
    const regex2 = new RegExp(`## \\d+\\.\\s*${palavraAlt}([\\s\\S]*?)(?=\\n## \\d+\\.|$)`,'i');
    m = regex2.exec(texto);
  }
  if(m){
    const conteudo = m[0];
    // Renderiza com badges de confianÃ§a
    const linhas = conteudo.split('\n');
    let html = '';
    for(const linha of linhas){
      const l = linha.trim();
      if(!l) continue;
      if(l.startsWith('##')){
        const titulo = l.replace(/^#+\s*\d*\.?\s*/,'').replace(/\*\*/g,'').trim();
        const conf = palavraTitulo.includes('FORTE')||palavraTitulo.includes('SÃšMULA') ? 'alta' :
                     palavraTitulo.includes('FRAC')||palavraTitulo.includes('RISCO') ? 'media' : 'alta';
        html += `<div class="secao-titulo">${titulo}<span class="sec-confianca ${conf}">${conf==='alta'?'âœ“ Alta':'âš  MÃ©dia'}</span></div>`;
      } else if(/^[-â€¢âœ…âŒâš ï¸]/.test(l)){
        const icone = l.startsWith('âœ…')?'âœ…':l.startsWith('âŒ')?'âŒ':l.startsWith('âš ')?'âš ï¸':'â€¢';
        const txt = l.replace(/^[-â€¢âœ…âŒâš ï¸]\s*/,'').replace(/\*\*/g,'');
        html += `<div class="bullet-item"><span class="bullet-icon">${icone}</span><span class="bullet-txt">${txt}</span></div>`;
      } else {
        html += `<p style="margin-bottom:6px;color:#a09880;font-size:13px">${l.replace(/\*\*/g,'')}</p>`;
      }
    }
    el.innerHTML = `<div class="secao-corpo">${html}</div>`;
  } else {
    el.innerHTML = '<p style="color:var(--muted);font-size:.65rem;padding:10px">SeÃ§Ã£o nÃ£o encontrada na anÃ¡lise.</p>';
  }
}

function renderHalReport(hal){
  const report = document.getElementById('halReport');
  const grid = document.getElementById('halGrid');
  const list = document.getElementById('halList');
  report.style.display='block';

  const classPct = hal.percentualSeguro>=90?'ok':hal.percentualSeguro>=70?'warn':'bad';
  grid.innerHTML = `
    <div class="hal-item"><div class="hal-val ${classPct}">${hal.percentualSeguro}%</div><div class="hal-lbl">Ãndice SeguranÃ§a</div></div>
    <div class="hal-item"><div class="hal-val ok">${hal.verificadas.length}</div><div class="hal-lbl">SÃºmulas Verificadas</div></div>
    <div class="hal-item"><div class="hal-val ${hal.naoVerificadas.length>0?'bad':'ok'}">${hal.naoVerificadas.length}</div><div class="hal-lbl">NÃ£o Verificadas</div></div>
  `;

  let listHtml = '';
  if(hal.totalCitadas===0){
    listHtml = '<div class="hal-list-item" style="color:var(--green);font-size:.63rem;padding:8px 0">âœ… Nenhuma sÃºmula por nÃºmero foi citada no texto â€” polÃ­tica Anti-AlucinaÃ§Ã£o respeitada.</div>';
  } else {
    for(const v of hal.verificadas){
      listHtml += `<div class="hal-list-item"><span class="hal-tag ${v.status}">${v.status==='verified'?'âœ“ Verificada':'âš  Alertada'}</span><span class="hal-sumula-txt"><strong style="color:var(--text)">${v.ref}</strong> â€” ${v.dados.txt.substring(0,80)}...</span></div>`;
    }
    for(const n of hal.naoVerificadas){
      listHtml += `<div class="hal-list-item"><span class="hal-tag removed">â›” Removida</span><span class="hal-sumula-txt"><strong style="color:var(--red)">${n.ref}</strong> â€” NÃ£o encontrada no banco verificado. Desconsidere esta referÃªncia.</span></div>`;
    }
  }
  list.innerHTML = listHtml;
}

// â”€â”€ GERAÃ‡ÃƒO DE PETIÃ‡ÃƒO (1 chamada de API) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function gerarPeticao(){
  if(!analysisData){ alert('Execute uma anÃ¡lise primeiro.'); return; }
  const apiKey = document.getElementById('apiKeyInput').value.trim();
  if(!apiKey){ alert('Configure a chave de API.'); return; }

  const tipoPeca = document.querySelector('.peticao-tipo-btn.active')?.dataset.peca || 'inicial';
  const nomePeca = {
    inicial: 'PETIÃ‡ÃƒO INICIAL',
    contestacao: 'CONTESTAÃ‡ÃƒO',
    recurso: 'RECURSO ORDINÃRIO',
    acordo: 'PROPOSTA DE ACORDO',
    notificacao: 'NOTIFICAÃ‡ÃƒO EXTRAJUDICIAL'
  }[tipoPeca] || 'PETIÃ‡ÃƒO INICIAL';

  const btn = document.getElementById('btnGerarPeticao');
  btn.disabled=true; btn.textContent='â³ Gerando...';

  const d = analysisData.formData;
  const sumulasAutorizadas = analysisData.sumulasUsadas || [];
  const analiseResumida = analysisData.aiText.substring(0,4000);

  const listaSumulas = sumulasAutorizadas.length > 0
    ? sumulasAutorizadas.map(s=>`  â€¢ ${s.n}: "${s.txt}"`).join('\n')
    : null;

  const prompt = `VocÃª Ã© um advogado brasileiro com 20 anos de experiÃªncia em redaÃ§Ã£o de peÃ§as processuais.
Elabore uma ${nomePeca} com base nos dados abaixo.

DADOS DO CASO:
Cliente: ${d.cliente||'nÃ£o informado'}
Ãrea: ${d.area||'nÃ£o informado'}
Tipo: ${d.tipo||'nÃ£o informado'}
Autor: ${d.autor||'nÃ£o informado'}
RÃ©u: ${d.reu||'nÃ£o informado'}
Pedidos: ${d.pedidos||'nÃ£o informado'}
Tribunal: ${d.tribunal||'nÃ£o informado'}
Valor da causa: ${d.valor?'R$ '+d.valor:'nÃ£o informado'}
Data: ${d.data}

${listaSumulas ? `â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  SÃšMULAS AUTORIZADAS â€” ÃšNICA LISTA PERMITIDA                â•‘
â•‘  SÃ“ CITE ESTAS. NENHUMA OUTRA. JAMAIS INVENTE.             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
${listaSumulas}

ğŸš« Ã‰ ABSOLUTAMENTE PROIBIDO citar qualquer outra sÃºmula fora desta lista.` :
`â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ATENÃ‡ÃƒO: ZERO SÃšMULAS AUTORIZADAS PARA ESTE CASO          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸš« PROIBIÃ‡ÃƒO TOTAL: NÃƒO cite nenhuma sÃºmula por nÃºmero nesta peÃ§a.
ğŸš« NÃ£o escreva "SÃºmula X do STJ/TST/STF" â€” nenhuma estÃ¡ autorizada.`}

ANÃLISE BASE (resumo):
${analiseResumida}

REGRAS DE INTEGRIDADE:
1. SÃºmulas: respeite a proibiÃ§Ã£o acima. Zero exceÃ§Ãµes.
2. Artigos de lei: cite apenas os que vocÃª tem certeza absoluta que existem e tÃªm o nÃºmero correto. Se tiver dÃºvida, descreva o conteÃºdo sem citar nÃºmero.
3. Linguagem forense brasileira padrÃ£o â€” formal, tÃ©cnica, objetiva.
4. Formato: ${tipoPeca==='acordo'?'Proposta extrajudicial clara, com valor, condiÃ§Ãµes e prazo de aceitaÃ§Ã£o':tipoPeca==='notificacao'?'NotificaÃ§Ã£o extrajudicial formal, com prazo de 10 dias Ãºteis para resposta, assinatura e AR':'PeÃ§a processual completa: endereÃ§amento, qualificaÃ§Ã£o das partes, dos fatos, do direito, dos pedidos e valor da causa'}

Elabore a ${nomePeca} agora:`;

  try{
    const texto = await gemini(apiKey, [{role:'user',parts:[{text:prompt}]}]);
    const out = document.getElementById('peticaoOutput');
    document.getElementById('peticaoTexto').textContent = texto;
    out.classList.add('visible');
    out.scrollIntoView({behavior:'smooth',block:'start'});
  }catch(e){
    alert('Erro ao gerar: '+e.message);
  }
  btn.disabled=false; btn.textContent='ğŸ“ GERAR PEÃ‡A NOVAMENTE';
}

function copiarPeticao(){
  const txt = document.getElementById('peticaoTexto').textContent;
  const btn = document.getElementById('btnCopiarPeticao');
  navigator.clipboard.writeText(txt).then(()=>{
    btn.textContent='âœ“ COPIADO!'; btn.classList.add('ok');
    setTimeout(()=>{ btn.textContent='ğŸ“‹ COPIAR PEÃ‡A'; btn.classList.remove('ok'); },2500);
  }).catch(()=>{
    const ta=document.createElement('textarea');ta.value=txt;document.body.appendChild(ta);ta.select();document.execCommand('copy');ta.remove();
    btn.textContent='âœ“ COPIADO!'; setTimeout(()=>{ btn.textContent='ğŸ“‹ COPIAR PEÃ‡A'; },2000);
  });
}

// â”€â”€ CHAT (COM COMPRESSÃƒO DE HISTÃ“RICO) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function chatSugest(btn){
  document.getElementById('chatInput').value = btn.textContent;
  enviarChat();
}
function chatKeydown(e){
  if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); enviarChat(); }
}
async function enviarChat(){
  const apiKey = document.getElementById('apiKeyInput').value.trim();
  if(!apiKey){ alert('Configure a chave de API primeiro.'); return; }
  if(!analysisData){ alert('Execute uma anÃ¡lise primeiro.'); return; }
  const input = document.getElementById('chatInput');
  const msg = input.value.trim();
  if(!msg) return;
  input.value='';
  document.getElementById('btnChatSend').disabled=true;

  const msgs = document.getElementById('chatMessages');
  const userDiv=document.createElement('div');
  userDiv.className='chat-msg user';
  userDiv.textContent=msg;
  msgs.appendChild(userDiv);

  const loadDiv=document.createElement('div');
  loadDiv.className='chat-msg ai loading-msg';
  loadDiv.textContent='Analisando...';
  msgs.appendChild(loadDiv);
  msgs.scrollTop=msgs.scrollHeight;

  // CompressÃ£o de histÃ³rico: depois de 6 trocas, mantÃ©m sÃ³ as Ãºltimas 4
  if(chatHistory.length > 10){
    chatHistory = [chatHistory[0], chatHistory[1], ...chatHistory.slice(-4)];
  }
  chatHistory.push({role:'user',parts:[{text:msg}]});

  try{
    const resp = await gemini(apiKey, chatHistory,
      `VocÃª Ã© um jurista brasileiro especialista respondendo perguntas sobre o caso jÃ¡ analisado.
REGRAS ABSOLUTAS:
1. Responda APENAS sobre este caso especÃ­fico.
2. NUNCA cite sÃºmulas por nÃºmero (ex: "SÃºmula 85 TST") a menos que estejam explicitamente na anÃ¡lise jÃ¡ feita.
3. Se nÃ£o tiver certeza de um nÃºmero de sÃºmula ou artigo, descreva o conteÃºdo sem citar o nÃºmero.
4. "NÃ£o verificado neste sistema" Ã© SEMPRE melhor do que inventar.
5. Seja direto e objetivo.`
    );
    chatHistory.push({role:'model',parts:[{text:resp}]});
    loadDiv.className='chat-msg ai';
    loadDiv.textContent=resp;
  }catch(e){
    loadDiv.className='chat-msg ai';
    loadDiv.textContent='Erro: '+e.message;
  }
  msgs.scrollTop=msgs.scrollHeight;
  document.getElementById('btnChatSend').disabled=false;
}

// â”€â”€ HISTÃ“RICO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function salvarHistorico(d, text){
  try{
    const hist = JSON.parse(localStorage.getItem('v9_historico')||'[]');
    const prob = text.match(/Probabilidade\s+Global[:\s*_]*(\d{1,3})\s*%/i);
    hist.unshift({
      id: Date.now(),
      data: d.data,
      cliente: d.cliente||'â€”',
      tipo: d.tipo||d.area||'Documento',
      prob: prob?parseInt(prob[1]):null,
      texto: text,
      formData: d,
      fileName: analysisData?.fileName||null
    });
    localStorage.setItem('v9_historico', JSON.stringify(hist.slice(0,20)));
    atualizarContHist();
  }catch(e){ console.warn('Erro ao salvar histÃ³rico:', e); }
}
function atualizarContHist(){
  try{
    const hist = JSON.parse(localStorage.getItem('v9_historico')||'[]');
    document.getElementById('histCount').textContent = hist.length;
  }catch(e){}
}
function toggleHist(){
  const panel=document.getElementById('histPanel');
  const overlay=document.getElementById('overlay');
  const aberto=panel.classList.contains('open');
  panel.classList.toggle('open',!aberto);
  overlay.classList.toggle('open',!aberto);
  if(!aberto) renderHistorico();
}
function renderHistorico(){
  const list=document.getElementById('histList');
  try{
    const hist=JSON.parse(localStorage.getItem('v9_historico')||'[]');
    if(!hist.length){ list.innerHTML='<div class="hist-empty">Nenhuma anÃ¡lise salva ainda.</div>'; return; }
    list.innerHTML=hist.map(h=>{
      const cls=h.prob>=70?'high':h.prob>=40?'medium':'low';
      const probTxt=h.prob!==null?h.prob+'%':'N/D';
      return `<div class="hist-item" onclick="carregarHistorico(${h.id})">
        <div class="hist-item-titulo">${h.cliente!=='â€”'?h.cliente+' â€” ':''} ${h.tipo}</div>
        <div class="hist-item-meta">
          <span>${h.data}</span>
          <span class="hist-item-prob ${cls}">${probTxt}</span>
          ${h.fileName?`<span>ğŸ“ ${h.fileName.substring(0,20)}</span>`:''}
        </div>
      </div>`;
    }).join('');
  }catch(e){ list.innerHTML='<div class="hist-empty">Erro ao carregar histÃ³rico.</div>'; }
}
function carregarHistorico(id){
  try{
    const hist=JSON.parse(localStorage.getItem('v9_historico')||'[]');
    const item=hist.find(h=>h.id===id);
    if(!item) return;
    const sumulasVerificadas = buscarSumulasLocais(item.formData.area||'', item.formData.pedidos||'', item.formData.fatos||'');
    const halResult = validarAntiAlucinacao(item.texto, sumulasVerificadas);
    analysisData={formData:item.formData,aiText:item.texto,fileName:item.fileName,sumulasUsadas:sumulasVerificadas,halResult};
    chatHistory=[
      {role:'user',parts:[{text:`Caso: ${item.formData.cliente||''} | ${item.formData.area||''}\n${item.texto.substring(0,2000)}`}]},
      {role:'model',parts:[{text:'Contexto carregado.'}]}
    ];
    showView('result');
    renderResult(item.formData, item.texto);
    toggleHist();
  }catch(e){ alert('Erro ao carregar: '+e.message); }
}
function limparHistorico(){
  if(!confirm('Apagar todo o histÃ³rico?')) return;
  try{ localStorage.removeItem('v9_historico'); atualizarContHist(); renderHistorico(); }catch(e){}
}

// â”€â”€ PARSE SEÃ‡Ã•ES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseSec(text){
  if(!text) return [{title:'ANÃLISE COMPLETA',content:text}];
  const s=[];
  text.split(/(?=\n## \d+\.)/).forEach(p=>{
    const t=p.trim(); if(!t) return;
    const lines=t.split('\n');
    const title=lines[0].replace(/^#+\s*\d*\.?\s*/,'').replace(/\*\*/g,'').trim();
    const content=lines.slice(1).join('\n').trim();
    if(title&&content) s.push({title,content});
  });
  return s.length?s:[{title:'ANÃLISE COMPLETA',content:text}];
}

// â”€â”€ DOWNLOAD WORD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function dlWord(){
  if(!analysisData) return;
  const btn=document.getElementById('btnWord');
  btn.disabled=true; btn.textContent='â³ Gerando...';
  document.getElementById('dlStatus').textContent='Preparando Word...';
  try{
    const {Document,Packer,Paragraph,TextRun,AlignmentType,BorderStyle,Header,Footer,PageNumber}=docx;
    const d=analysisData.formData,text=analysisData.aiText,secs=parseSec(text);
    const p=(t,o={})=>new Paragraph({children:[new TextRun({text:String(t||''),font:'Arial',size:22,...o})],spacing:{after:120},alignment:AlignmentType.JUSTIFIED});
    const pc=(t,o={})=>new Paragraph({children:[new TextRun({text:String(t||''),font:'Arial',size:22,...o})],spacing:{after:100},alignment:AlignmentType.CENTER});
    const h1=(t)=>new Paragraph({children:[new TextRun({text:String(t||''),font:'Arial',size:26,bold:true,color:'8B6914'})],spacing:{before:320,after:120},border:{bottom:{style:BorderStyle.SINGLE,size:4,color:'C9A84C',space:4}}});
    const sp=()=>new Paragraph({children:[new TextRun({text:'',size:18})],spacing:{after:60}});
    const cover=[sp(),sp(),sp(),sp(),
      pc('V9 PRO',{size:56,bold:true,color:'C9A84C'}),
      pc('ANÃLISE JURÃDICA PROFISSIONAL',{size:28,bold:true,color:'8B6914'}),
      pc('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”',{size:18,color:'C9A84C'}),sp()
    ];
    if(analysisData.fileName) cover.push(pc('Documento: '+analysisData.fileName,{size:20}));
    const flds=[['Cliente',d.cliente],['NÂº do Processo',d.processo],['Ãrea do Direito',d.area],['Tipo de AÃ§Ã£o',d.tipo],['Polo Ativo',d.autor],['Polo Passivo',d.reu],['Tribunal',d.tribunal],['Valor da Causa',d.valor?'R$ '+d.valor:''],['Data',d.data]].filter(([,v])=>v);
    flds.forEach(([k,v])=>cover.push(pc(`${k}: ${v}`,{size:20})));
    cover.push(sp(),pc('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”',{size:18,color:'C9A84C'}),sp(),sp(),
      pc('Gerado por V9 Pro â€” Plataforma JurÃ­dica Profissional',{size:16,italics:true,color:'888888'}),
      pc('NÃƒO SUBSTITUI orientaÃ§Ã£o jurÃ­dica de advogado habilitado.',{size:16,italics:true,color:'888888'})
    );
    const body=[];
    if(flds.length){ body.push(h1('DADOS DO PROCESSO')); flds.forEach(([k,v])=>body.push(p(`${k}: ${v}`))); body.push(sp()); }
    secs.forEach(sec=>{
      body.push(h1(sec.title));
      sec.content.split('\n').forEach(line=>{
        const cl=line.replace(/\*\*/g,'').replace(/^#+\s*/,'').trim();
        if(!cl){body.push(sp());return;}
        const ind=/^[-â€¢âœ…âŒâš ï¸]\s/.test(line.trim());
        body.push(new Paragraph({children:[new TextRun({text:cl.replace(/^[-â€¢âœ…âŒâš ï¸]\s*/,''),font:'Arial',size:22})],spacing:{after:100},alignment:AlignmentType.JUSTIFIED,...(ind?{indent:{left:300}}:{})}));
      });
      body.push(sp());
    });
    body.push(pc('V9 Pro Â· '+d.data,{size:14,italics:true,color:'888888'}));
    const wdoc=new Document({
      sections:[
        {properties:{page:{size:{width:11906,height:16838},margin:{top:1440,right:1440,bottom:1440,left:1440}}},children:cover},
        {
          properties:{page:{size:{width:11906,height:16838},margin:{top:1440,right:1600,bottom:1440,left:1600}}},
          headers:{default:new Header({children:[new Paragraph({children:[new TextRun({text:'V9 PRO  Â·  ANÃLISE JURÃDICA PROFISSIONAL',font:'Arial',size:14,color:'C9A84C',bold:true})],alignment:AlignmentType.CENTER,border:{bottom:{style:BorderStyle.SINGLE,size:3,color:'C9A84C',space:4}}})]})},
          footers:{default:new Footer({children:[new Paragraph({children:[new TextRun({text:(d.area||d.tipo||'AnÃ¡lise')+'  Â·  PÃ¡g. ',font:'Arial',size:14,color:'888888'}),new TextRun({children:[PageNumber.CURRENT],font:'Arial',size:14,color:'888888'})],alignment:AlignmentType.CENTER})]})},
          children:body
        }
      ]
    });
    const buf=await Packer.toBuffer(wdoc);
    const blob=new Blob([buf],{type:'application/vnd.openxmlformats-officedocument.wordprocessingml.document'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url;
    a.download=`V9Pro_${(d.cliente||d.tipo||d.area||'Analise').replace(/\s+/g,'_').replace(/[^\w_]/g,'')}_${d.data.replace(/\//g,'-')}.docx`;
    document.body.appendChild(a); a.click();
    setTimeout(()=>{URL.revokeObjectURL(url);a.remove();},1000);
    document.getElementById('dlStatus').textContent='âœ“ Word gerado com sucesso!';
  }catch(e){ document.getElementById('dlStatus').textContent='âœ— Erro: '+e.message; }
  btn.disabled=false; btn.textContent='ğŸ“„ Baixar Word (.docx)';
}

// â”€â”€ DOWNLOAD PDF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function dlPDF(){
  if(!analysisData) return;
  const btn=document.getElementById('btnPdf');
  btn.disabled=true; btn.textContent='â³ Gerando...';
  document.getElementById('dlStatus').textContent='Preparando PDF...';
  try{
    const {jsPDF}=jspdf;
    const doc=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
    const d=analysisData.formData,text=analysisData.aiText;
    const pw=210,ph=297,ml=18,mr=18,mb=18,cw=pw-ml-mr; let y=20;
    const G=[201,168,76],GD=[139,105,20],GR=[110,100,85],LT=[200,190,170],BG=[8,8,8];
    function np(){ doc.addPage(); doc.setFillColor(...BG); doc.rect(0,0,pw,ph,'F'); doc.setFillColor(20,18,12); doc.rect(0,0,pw,11,'F'); doc.setFont('helvetica','bold'); doc.setFontSize(6); doc.setTextColor(...G); doc.text('V9 PRO  Â·  ANÃLISE JURÃDICA PROFISSIONAL',pw/2,7,{align:'center'}); doc.setDrawColor(...GD); doc.setLineWidth(0.2); doc.line(ml,11,pw-mr,11); y=19; }
    function ck(n=8){ if(y+n>ph-mb-8) np(); }
    function sh(t){ ck(14); doc.setFillColor(22,20,12); doc.rect(ml-2,y-5,cw+4,9,'F'); doc.setDrawColor(...G); doc.setLineWidth(0.25); doc.line(ml-2,y+4,ml+cw+2,y+4); doc.setFont('helvetica','bold'); doc.setFontSize(8.5); doc.setTextColor(...G); doc.text(t.toUpperCase().substring(0,70),ml,y); y+=9; }
    function bd(t,ind=0){ if(!t||!t.trim()) return; doc.setFont('helvetica','normal'); doc.setFontSize(7.5); doc.setTextColor(...LT); doc.splitTextToSize(t.trim(),cw-ind).forEach(l=>{ ck(5); doc.text(l,ml+ind,y); y+=4.8; }); }
    doc.setFillColor(...BG); doc.rect(0,0,pw,ph,'F');
    doc.setDrawColor(...GD); doc.setLineWidth(0.25); doc.line(ml,14,pw-mr,14);
    doc.setDrawColor(...G); doc.setLineWidth(0.5); doc.line(ml,16,pw-mr,16);
    doc.setFont('helvetica','bold'); doc.setFontSize(26); doc.setTextColor(...G); doc.text('V9 PRO',pw/2,58,{align:'center'});
    doc.setFontSize(12); doc.setTextColor(...GD); doc.text('ANÃLISE JURÃDICA PROFISSIONAL',pw/2,67,{align:'center'});
    doc.setFontSize(7); doc.setTextColor(...GR); doc.text('ADVOGADOS  Â·  ESCRITÃ“RIOS  Â·  JURÃDICO INTERNO',pw/2,74,{align:'center'});
    doc.setDrawColor(...GD); doc.setLineWidth(0.25); doc.line(30,80,pw-30,80);
    let cy=92;
    if(analysisData.fileName){ doc.setFont('helvetica','bold'); doc.setFontSize(7.5); doc.setTextColor(...GD); doc.text('Documento:',ml+8,cy); doc.setFont('helvetica','normal'); doc.setTextColor(...LT); doc.text((analysisData.fileName||'').substring(0,50),ml+40,cy); cy+=7; }
    const flds=[['Cliente',d.cliente],['Processo',d.processo],['Ãrea',d.area],['Tipo',d.tipo],['Autor',d.autor],['RÃ©u',d.reu],['Tribunal',d.tribunal],['Valor',d.valor?'R$ '+d.valor:''],['Data',d.data]].filter(([,v])=>v);
    flds.forEach(([k,v])=>{ doc.setFont('helvetica','bold'); doc.setFontSize(7.5); doc.setTextColor(...GD); doc.text(k+':',ml+8,cy); doc.setFont('helvetica','normal'); doc.setTextColor(...LT); doc.text((v||'').substring(0,55),ml+34,cy); cy+=6.5; });
    doc.setDrawColor(...GD); doc.line(30,cy+3,pw-30,cy+3);
    doc.setFont('helvetica','italic'); doc.setFontSize(6.5); doc.setTextColor(...GR);
    doc.text('Gerado por V9 Pro  Â·  NÃƒO SUBSTITUI advogado habilitado.',pw/2,ph-14,{align:'center'});
    np(); sh('Dados do Processo');
    flds.forEach(([k,v])=>bd(`${k}: ${v}`)); y+=3;
    parseSec(text).forEach(sec=>{
      sh(sec.title);
      sec.content.split('\n').forEach(line=>{
        const cl=line.replace(/\*\*/g,'').replace(/^#+\s*/,'').trim();
        if(!cl){y+=1.2;return;}
        bd(/^[-â€¢âœ…âŒâš ï¸]\s/.test(line.trim())?'â€¢ '+cl.replace(/^[-â€¢âœ…âŒâš ï¸]\s*/,''):cl, /^[-â€¢âœ…âŒâš ï¸]\s/.test(line.trim())?4:0);
      }); y+=2.5;
    });
    const tot=doc.internal.getNumberOfPages();
    for(let i=2;i<=tot;i++){ doc.setPage(i); doc.setFont('helvetica','normal'); doc.setFontSize(6); doc.setTextColor(...GR); doc.text(`PÃ¡gina ${i} de ${tot}  Â·  V9 Pro  Â·  ${d.data}`,pw/2,ph-6,{align:'center'}); }
    doc.save(`V9Pro_${(d.cliente||d.tipo||d.area||'Analise').replace(/\s+/g,'_').replace(/[^\w_]/g,'')}_${d.data.replace(/\//g,'-')}.pdf`);
    document.getElementById('dlStatus').textContent='âœ“ PDF gerado com sucesso!';
  }catch(e){ document.getElementById('dlStatus').textContent='âœ— Erro: '+e.message; }
  btn.disabled=false; btn.textContent='ğŸ“• Baixar PDF';
}

// â”€â”€ PROMPT PARA COPIAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function gerarPromptCopia(d, text){
  const prob=text.match(/Probabilidade\s+Global[:\s*_]*(\d{1,3})\s*%/i);
  const probVal=prob?prob[1]+'%':'nÃ£o identificada';
  return `VocÃª Ã© um jurista brasileiro especialista. Aprofunde esta anÃ¡lise com rigor absoluto â€” NUNCA invente sÃºmulas ou dados.

CASO: ${d.cliente?'Cliente: '+d.cliente+' | ':''}${d.area||'Direito'} | ${d.tipo||'AnÃ¡lise JurÃ­dica'} | ${d.data}
PROBABILIDADE ESTIMADA: ${probVal}

${text.substring(0,5000)}

SOLICITO QUE VOCÃŠ:
1. Valide a probabilidade de ${probVal} â€” corrija se necessÃ¡rio
2. Confirme as sÃºmulas citadas e adicione as que faltam
3. Aprofunde a estratÃ©gia: acordo x litÃ­gio, provas indispensÃ¡veis
4. Elabore petiÃ§Ã£o inicial completa com fundamentos detalhados
5. Estime honorÃ¡rios advocatÃ­cios com base no valor da causa

IMPORTANTE: Se nÃ£o tiver certeza sobre jurisprudÃªncia, diga "nÃ£o localizado".`;
}
function copyPrompt(){
  const prompt=document.getElementById('promptPreview').textContent;
  if(!prompt) return;
  navigator.clipboard.writeText(prompt).then(()=>{
    const btn=document.getElementById('btnCopy');
    btn.classList.add('copied'); btn.textContent='âœ“ COPIADO!';
    document.getElementById('copyHint').textContent='âœ… Cole no ChatGPT, Claude ou qualquer IA';
    document.getElementById('copyHint').style.color='var(--green)';
    setTimeout(()=>{ btn.classList.remove('copied'); btn.innerHTML='ğŸ“‹ COPIAR PROMPT COMPLETO'; document.getElementById('copyHint').textContent='Cole no ChatGPT, Gemini, Claude ou qualquer IA para continuar'; document.getElementById('copyHint').style.color=''; },4000);
  }).catch(()=>{
    const ta=document.createElement('textarea'); ta.value=prompt; ta.style.cssText='position:fixed;opacity:0'; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove();
    document.getElementById('btnCopy').textContent='âœ“ COPIADO!';
    setTimeout(()=>{ document.getElementById('btnCopy').innerHTML='ğŸ“‹ COPIAR PROMPT COMPLETO'; },3000);
  });
}

// â”€â”€ CALCULADORA DE PRAZOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function maskData(el){
  let v=el.value.replace(/\D/g,'');
  if(v.length>=3) v=v.substring(0,2)+'/'+v.substring(2);
  if(v.length>=6) v=v.substring(0,5)+'/'+v.substring(5,9);
  el.value=v;
}

// â”€â”€ RESET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function reset(){
  document.getElementById('resultCard').classList.remove('visible');
  showView('form');
  document.getElementById('dlStatus').textContent='';
  document.getElementById('chatMessages').innerHTML='';
  document.getElementById('prazoResultado').style.display='none';
  document.getElementById('peticaoOutput').classList.remove('visible');
  analysisData=null; chatHistory=[]; chatHistoryCompressed=false;
  clearFile(null); setMode('upload');
  window.scrollTo({top:0,behavior:'smooth'});
}
</script>
</body>
</html>
